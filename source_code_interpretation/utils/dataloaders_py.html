
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.1.11">
    
    
      
        <title>dataloaders.py - oneflow-yolo-doc</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3754935a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="oneflow-yolo-doc" class="md-header__button md-logo" aria-label="oneflow-yolo-doc" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            oneflow-yolo-doc
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              dataloaders.py
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/Oneflow-Inc/oneflow-yolo-doc/" title="å‰å¾€ GitHub ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OneYOLO-Doc
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../index.html" class="md-tabs__link">
      é¦–é¡µğŸ 
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../tutorials/00_chapter/overview.html" class="md-tabs__link">
        YOLOv5æ•™ç¨‹ğŸ“š
      </a>
    </li>
  

  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../val_py.html" class="md-tabs__link md-tabs__link--active">
        æºç è§£è¯»
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../thesis_interpretation/00_yolo_history.html" class="md-tabs__link">
        è®ºæ–‡è§£è¯»
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="oneflow-yolo-doc" class="md-nav__button md-logo" aria-label="oneflow-yolo-doc" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    oneflow-yolo-doc
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Oneflow-Inc/oneflow-yolo-doc/" title="å‰å¾€ GitHub ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OneYOLO-Doc
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        é¦–é¡µğŸ 
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        YOLOv5æ•™ç¨‹ğŸ“š
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YOLOv5æ•™ç¨‹ğŸ“š" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YOLOv5æ•™ç¨‹ğŸ“š
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        å¼•è¨€
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="å¼•è¨€" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          å¼•è¨€
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/00_chapter/overview.html" class="md-nav__link">
        one-yolov5 ç‰¹ç‚¹è§£æ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/00_chapter/optim_speed_version1.html" class="md-nav__link">
        æ¶ˆè´¹çº§æ˜¾å¡çš„æ˜¥å¤©ï¼ŒGTX 3090 YOLOv5så•å¡å®Œæ•´è®­ç»ƒCOCOæ•°æ®é›†ç¼©çŸ­11.35ä¸ªå°æ—¶
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        ç¬¬ä¸€ç«  ç½‘ç»œç»“æ„
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ç¬¬ä¸€ç«  ç½‘ç»œç»“æ„" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          ç¬¬ä¸€ç«  ç½‘ç»œç»“æ„
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/01_chapter/yolov5_network_structure_analysis.html" class="md-nav__link">
        1.1. YOLOv5 ç½‘ç»œç»“æ„è§£æ
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        ç¬¬äºŒç«  è®­ç»ƒæ¨¡å‹çš„æ•°æ®é›†
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ç¬¬äºŒç«  è®­ç»ƒæ¨¡å‹çš„æ•°æ®é›†" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          ç¬¬äºŒç«  è®­ç»ƒæ¨¡å‹çš„æ•°æ®é›†
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/02_chapter/how_to_prepare_yolov5_training_data.html" class="md-nav__link">
        2.1. å¦‚ä½•å‡†å¤‡YOLOv5æ¨¡å‹è®­ç»ƒæ•°æ®
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      <label class="md-nav__link" for="__nav_2_4">
        ç¬¬ä¸‰ç«  æ¨¡å‹è®­ç»ƒ
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ç¬¬ä¸‰ç«  æ¨¡å‹è®­ç»ƒ" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          ç¬¬ä¸‰ç«  æ¨¡å‹è®­ç»ƒ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/03_chapter/quick_start.html" class="md-nav__link">
        3.1 å¿«é€Ÿå¼€å§‹
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/03_chapter/loading_model_from_oneflowhub.html" class="md-nav__link">
        3.2 ä»OneFlow Hub åŠ è½½YOLOv5
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/03_chapter/TTA.html" class="md-nav__link">
        3.3 æµ‹è¯•æ—¶å¢å¼º (TTA)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/03_chapter/model_ensembling.html" class="md-nav__link">
        3.4 æ¨¡å‹èåˆ (Model Ensembling)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/03_chapter/intro_to_wandb.html" class="md-nav__link">
        3.5 Weights & Biases
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      <label class="md-nav__link" for="__nav_2_5">
        ç¬¬å››ç«  æ•°æ®ç»„ç»‡ä¸å¤„ç†è§£è¯»
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ç¬¬å››ç«  æ•°æ®ç»„ç»‡ä¸å¤„ç†è§£è¯»" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          ç¬¬å››ç«  æ•°æ®ç»„ç»‡ä¸å¤„ç†è§£è¯»
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/04_chapter/mosaic.html" class="md-nav__link">
        4.1 mosaic è§£è¯»
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      <label class="md-nav__link" for="__nav_2_6">
        ç¬¬äº”ç«  YOLOv5ä¸­IoUæŸå¤±
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ç¬¬äº”ç«  YOLOv5ä¸­IoUæŸå¤±" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          ç¬¬äº”ç«  YOLOv5ä¸­IoUæŸå¤±
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/05_chapter/rectangular_reasoning.html" class="md-nav__link">
        5.1 çŸ©å½¢æ¨ç†
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/05_chapter/iou_in-depth_analysis.html" class="md-nav__link">
        5.2 IoUæ·±å…¥è§£æ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/05_chapter/map_analysis.html" class="md-nav__link">
        5.3 æ¨¡å‹ç²¾ç¡®åº¦è¯„ä¼°
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/05_chapter/Introduction_to_functions_used_in_metrics.html" class="md-nav__link">
        5.4 è®¡ç®—mAPç”¨åˆ°çš„numpyå‡½æ•°
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" type="checkbox" id="__nav_2_7" >
      
      <label class="md-nav__link" for="__nav_2_7">
        ç¬¬å…­ç«  æ¨¡å‹å¯¼å‡ºå’Œéƒ¨ç½²ä»‹ç»
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ç¬¬å…­ç«  æ¨¡å‹å¯¼å‡ºå’Œéƒ¨ç½²ä»‹ç»" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          ç¬¬å…­ç«  æ¨¡å‹å¯¼å‡ºå’Œéƒ¨ç½²ä»‹ç»
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/06_chapter/export_onnx_tflite_tensorrt.html" class="md-nav__link">
        6.1 æ¨¡å‹å¯¼å‡º
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        æºç è§£è¯»
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="æºç è§£è¯»" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          æºç è§£è¯»
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../val_py.html" class="md-nav__link">
        val.py
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../train_py.html" class="md-nav__link">
        train.py
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" checked>
      
      <label class="md-nav__link" for="__nav_3_3">
        utils
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="utils" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="loss_py.html" class="md-nav__link">
        loss.py
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="augmentations_py.html" class="md-nav__link">
        augmentations.py
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          dataloaders.py
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="dataloaders_py.html" class="md-nav__link md-nav__link--active">
        dataloaders.py
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    å‰è¨€
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. å¯¼å…¥éœ€è¦çš„åŒ…å’ŒåŸºæœ¬é…ç½®
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. ç›¸æœºè®¾ç½®
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3dataloader" class="md-nav__link">
    3.è‡ªå®šä¹‰DataLoader
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-loadimagesandlabels" class="md-nav__link">
    4. LoadImagesAndLabels
  </a>
  
    <nav class="md-nav" aria-label="4. LoadImagesAndLabels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-init" class="md-nav__link">
    4.1 init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-cache_labels" class="md-nav__link">
    4.2 cache_labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-getitem" class="md-nav__link">
    4.3 getitem
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-collate_fn" class="md-nav__link">
    4.4 collate_fn
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-img2label_paths" class="md-nav__link">
    5. img2label_paths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-verify_image_label" class="md-nav__link">
    6. verify_image_label
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-load_image" class="md-nav__link">
    7. load_image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-augment_hsv" class="md-nav__link">
    8. augment_hsv
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-load_mosaicload_mosaic9" class="md-nav__link">
    9. load_mosaicã€load_mosaic9
  </a>
  
    <nav class="md-nav" aria-label="9. load_mosaicã€load_mosaic9">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-load_mosaic" class="md-nav__link">
    9.1 load_mosaic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-load_mosaic9" class="md-nav__link">
    9.2 load_mosaic9
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-loadimages-loadstreams-loadwebcam" class="md-nav__link">
    10. LoadImages &amp; LoadStreams &amp; LoadWebcam
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-flatten_recursive" class="md-nav__link">
    11. flatten_recursive
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12extract_boxes" class="md-nav__link">
    12.extract_boxes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-autosplit" class="md-nav__link">
    13. autosplit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="downloads_py.html" class="md-nav__link">
        downloads.py
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="general_py.html" class="md-nav__link">
        geneal.py
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="autoanchor_py.html" class="md-nav__link">
        autoanchor.py
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="callbacks_py.html" class="md-nav__link">
        callbacks.py
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        è®ºæ–‡è§£è¯»
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="è®ºæ–‡è§£è¯»" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          è®ºæ–‡è§£è¯»
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/00_yolo_history.html" class="md-nav__link">
        history
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/01_yolo.html" class="md-nav__link">
        YOLOv1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/02_yolo.html" class="md-nav__link">
        YOLOv2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/03_yolo.html" class="md-nav__link">
        YOLOv3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/04_yolo.html" class="md-nav__link">
        YOLOv4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/06_yolo.html" class="md-nav__link">
        YOLOv6
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    å‰è¨€
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. å¯¼å…¥éœ€è¦çš„åŒ…å’ŒåŸºæœ¬é…ç½®
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2. ç›¸æœºè®¾ç½®
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3dataloader" class="md-nav__link">
    3.è‡ªå®šä¹‰DataLoader
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-loadimagesandlabels" class="md-nav__link">
    4. LoadImagesAndLabels
  </a>
  
    <nav class="md-nav" aria-label="4. LoadImagesAndLabels">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-init" class="md-nav__link">
    4.1 init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-cache_labels" class="md-nav__link">
    4.2 cache_labels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-getitem" class="md-nav__link">
    4.3 getitem
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-collate_fn" class="md-nav__link">
    4.4 collate_fn
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-img2label_paths" class="md-nav__link">
    5. img2label_paths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-verify_image_label" class="md-nav__link">
    6. verify_image_label
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-load_image" class="md-nav__link">
    7. load_image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-augment_hsv" class="md-nav__link">
    8. augment_hsv
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-load_mosaicload_mosaic9" class="md-nav__link">
    9. load_mosaicã€load_mosaic9
  </a>
  
    <nav class="md-nav" aria-label="9. load_mosaicã€load_mosaic9">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-load_mosaic" class="md-nav__link">
    9.1 load_mosaic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-load_mosaic9" class="md-nav__link">
    9.2 load_mosaic9
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-loadimages-loadstreams-loadwebcam" class="md-nav__link">
    10. LoadImages &amp; LoadStreams &amp; LoadWebcam
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-flatten_recursive" class="md-nav__link">
    11. flatten_recursive
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12extract_boxes" class="md-nav__link">
    12.extract_boxes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-autosplit" class="md-nav__link">
    13. autosplit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Oneflow-Inc/oneflow-yolo-doc/blob/master/docs/source_code_interpretation/utils/dataloaders_py.md" title="ç¼–è¾‘æ­¤é¡µ" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>dataloaders.py</h1>
                
                <h2 id="_1">å‰è¨€</h2>
<blockquote>
<p>ğŸ‰ä»£ç ä»“åº“åœ°å€ï¼š<a href="https://github.com/Oneflow-Inc/one-yolov5" target="blank">https://github.com/Oneflow-Inc/one-yolov5</a>
æ¬¢è¿star <a href="https://github.com/Oneflow-Inc/one-yolov5">one-yolov5é¡¹ç›®</a> è·å–<a href="https://github.com/Oneflow-Inc/one-yolov5/tags" target="blank" >æœ€æ–°çš„åŠ¨æ€ã€‚</a>
<a href="https://github.com/Oneflow-Inc/one-yolov5/issues/new"  target="blank"  >å¦‚æœæ‚¨æœ‰é—®é¢˜ï¼Œæ¬¢è¿åœ¨ä»“åº“ç»™æˆ‘ä»¬æå‡ºå®è´µçš„æ„è§ã€‚ğŸŒŸğŸŒŸğŸŒŸ</a>
<a href="https://github.com/Oneflow-Inc/one-yolov5" target="blank" >
å¦‚æœå¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿æ¥ç»™æˆ‘Starå‘€ğŸ˜Š~  </a></p>
</blockquote>
<p>æºç è§£è¯»ï¼š <a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/utils/dataloaders.py">utils/dataloaders.py</a></p>
<h2 id="1">1. å¯¼å…¥éœ€è¦çš„åŒ…å’ŒåŸºæœ¬é…ç½®</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">Dataloaders and dataset utils</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span> <span class="nn">contextlib</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">glob</span> <span class="c1"># pythonè‡ªå·±å¸¦çš„ä¸€ä¸ªæ–‡ä»¶æ“ä½œç›¸å…³æ¨¡å— æŸ¥æ‰¾ç¬¦åˆè‡ªå·±ç›®çš„çš„æ–‡ä»¶(å¦‚æ¨¡ç³ŠåŒ¹é…)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">import</span> <span class="nn">hashlib</span>  <span class="c1"># å“ˆå¸Œæ¨¡å— æä¾›äº†å¤šç§å®‰å…¨æ–¹ä¾¿çš„hashæ–¹æ³•</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">import</span> <span class="nn">json</span>  <span class="c1"># jsonæ–‡ä»¶æ“ä½œæ¨¡å—</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">import</span> <span class="nn">math</span>  <span class="c1"># æ•°å­¦å…¬å¼æ¨¡å—</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="kn">import</span>  <span class="nn">os</span>  <span class="c1"># ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„æ¨¡å— åŒ…å«æ–‡ä»¶è·¯å¾„æ“ä½œå’Œè§£æ</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kn">import</span> <span class="nn">random</span>  <span class="c1"># ç”Ÿæˆéšæœºæ•°æ¨¡å—</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="kn">import</span> <span class="nn">shutil</span> <span class="c1"># æ–‡ä»¶å¤¹ã€å‹ç¼©åŒ…å¤„ç†æ¨¡å—</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="kn">import</span> <span class="nn">time</span>  <span class="c1"># æ—¶é—´æ¨¡å— æ›´åº•å±‚</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span> <span class="c1"># å¤åˆ¶æ¨¡å—</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">ThreadPool</span>  <span class="c1"># å¤šçº¿ç¨‹æ¨¡å— çº¿ç¨‹æ± </span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>   <span class="c1"># Pathå°†strè½¬æ¢ä¸ºPathå¯¹è±¡ ä½¿å­—ç¬¦ä¸²è·¯å¾„æ˜“äºæ“ä½œçš„æ¨¡å—</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>   <span class="c1"># å¤šçº¿ç¨‹æ“ä½œæ¨¡å—</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> <span class="c1"># numpyçŸ©é˜µæ“ä½œæ¨¡å—</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="kn">import</span> <span class="nn">oneflow</span> <span class="k">as</span> <span class="nn">flow</span>    <span class="c1"># OneFlowæ·±åº¦å­¦ä¹ æ¨¡å—</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="kn">import</span> <span class="nn">oneflow.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>     <span class="c1"># OneFlowå‡½æ•°æ¥å£ å°è£…äº†å¾ˆå¤šå·ç§¯ã€æ± åŒ–ç­‰å‡½æ•°</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="kn">import</span> <span class="nn">yaml</span>  <span class="c1"># yamlæ–‡ä»¶æ“ä½œæ¨¡å—</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="kn">from</span> <span class="nn">oneflow.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">distributed</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ExifTags</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageOps</span>    <span class="c1"># å›¾ç‰‡ã€ç›¸æœºæ“ä½œæ¨¡å—</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>   <span class="c1"># è¿›åº¦æ¡æ¨¡å—</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="c1"># augmentations.pyæºç è§£è¯»:  https://start.oneflow.org/oneflow-yolo-doc/source_code_interpretation/utils/augmentations_py.html</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="kn">from</span> <span class="nn">utils.augmentations</span> <span class="kn">import</span> <span class="n">Albumentations</span><span class="p">,</span> <span class="n">augment_hsv</span><span class="p">,</span> <span class="n">copy_paste</span><span class="p">,</span> <span class="n">letterbox</span><span class="p">,</span> <span class="n">mixup</span><span class="p">,</span> <span class="n">random_perspective</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="kn">from</span> <span class="nn">utils.general</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="n">DATASETS_DIR</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="n">LOGGER</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="n">NUM_THREADS</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="n">check_dataset</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="n">check_requirements</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="n">check_yaml</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="n">clean_str</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="n">cv2</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="n">is_colab</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="n">is_kaggle</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="n">segments2boxes</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="n">xyn2xy</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="n">xywh2xyxy</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="n">xywhn2xyxy</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="n">xyxy2xywhn</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="c1"># Parameters</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="n">HELP_URL</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="n">IMG_FORMATS</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    <span class="s2">&quot;bmp&quot;</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="s2">&quot;dng&quot;</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>    <span class="s2">&quot;mpo&quot;</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    <span class="s2">&quot;png&quot;</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>    <span class="s2">&quot;tif&quot;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    <span class="s2">&quot;tiff&quot;</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="s2">&quot;webp&quot;</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="p">)</span>  <span class="c1"># include image suffixes</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="n">VID_FORMATS</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>    <span class="s2">&quot;asf&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>    <span class="s2">&quot;avi&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>    <span class="s2">&quot;gif&quot;</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>    <span class="s2">&quot;m4v&quot;</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>    <span class="s2">&quot;mkv&quot;</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>    <span class="s2">&quot;mov&quot;</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>    <span class="s2">&quot;mp4&quot;</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>    <span class="s2">&quot;mpeg&quot;</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>    <span class="s2">&quot;mpg&quot;</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>    <span class="s2">&quot;ts&quot;</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>    <span class="s2">&quot;wmv&quot;</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="p">)</span>  <span class="c1"># include video suffixes</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="n">BAR_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{l_bar}{bar:10}{r_bar}{bar:-10b}</span><span class="s2">&quot;</span>  <span class="c1"># tqdm bar format</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="n">LOCAL_RANK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>  
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="c1"># https://oneflow.readthedocs.io/en/master/distributed.html?highlight=launch#launching-distributed-training </span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="n">RANK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<h2 id="2">2. ç›¸æœºè®¾ç½®</h2>
<p>&emsp;è¿™éƒ¨åˆ†æ˜¯ç›¸æœºç›¸å…³è®¾ç½®ï¼Œå½“ä½¿ç”¨ç›¸æœºé‡‡æ ·æ—¶æ‰ä¼šä½¿ç”¨ã€‚</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># ç›¸æœºè®¾ç½®</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1"># Get orientation exif tag</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># ä¸“é—¨ä¸ºæ•°ç ç›¸æœºçš„ç…§ç‰‡è€Œè®¾å®š  å¯ä»¥è®°å½•æ•°ç ç…§ç‰‡çš„å±æ€§ä¿¡æ¯å’Œæ‹æ‘„æ•°æ®</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="k">for</span> <span class="n">orientation</span> <span class="ow">in</span> <span class="n">ExifTags</span><span class="o">.</span><span class="n">TAGS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="k">if</span> <span class="n">ExifTags</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">orientation</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Orientation&quot;</span><span class="p">:</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>        <span class="k">break</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="k">def</span> <span class="nf">get_hash</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="c1"># è¿”å›æ–‡ä»¶åˆ—è¡¨çš„hashå€¼</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="c1"># Returns a single hash value of a list of paths (files or dirs)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>  <span class="c1"># sizes</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>  <span class="c1"># hash sizes</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>  <span class="c1"># hash paths</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># return hash</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="k">def</span> <span class="nf">exif_size</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="c1"># è·å–æ•°ç ç›¸æœºçš„å›¾ç‰‡å®½é«˜ä¿¡æ¯  å¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦æ—‹è½¬ï¼ˆæ•°ç ç›¸æœºå¯ä»¥å¤šè§’åº¦æ‹æ‘„ï¼‰</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="c1"># Returns exif-corrected PIL size</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># (width, height)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>        <span class="n">rotation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">_getexif</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="n">orientation</span><span class="p">]</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>        <span class="k">if</span> <span class="n">rotation</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>  <span class="c1"># rotation 270 or 90</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    <span class="k">return</span> <span class="n">s</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="k">def</span> <span class="nf">exif_transpose</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="sd">    å¦‚æœæœ‰EXIFæ–¹å‘æ ‡è®°ï¼Œåˆ™ç›¸åº”è°ƒæ¢PILå›¾åƒã€‚</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="sd">    Transpose a PIL image accordingly if it has an EXIF Orientation tag.</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="sd">    Inplace version of https://github.com/python-pillow/Pillow/blob/master/src/PIL/ImageOps.py exif_transpose()</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="sd">    :param image: The image to transpose.</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="sd">    :return: An image.</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>    <span class="n">exif</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">getexif</span><span class="p">()</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>    <span class="n">orientation</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mh">0x0112</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># default 1</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>    <span class="k">if</span> <span class="n">orientation</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>        <span class="n">method</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>            <span class="mi">2</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">,</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>            <span class="mi">3</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_180</span><span class="p">,</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>            <span class="mi">4</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">FLIP_TOP_BOTTOM</span><span class="p">,</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>            <span class="mi">5</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">TRANSPOSE</span><span class="p">,</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>            <span class="mi">6</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_270</span><span class="p">,</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>            <span class="mi">7</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">TRANSVERSE</span><span class="p">,</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>            <span class="mi">8</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_90</span><span class="p">,</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>            <span class="k">del</span> <span class="n">exif</span><span class="p">[</span><span class="mh">0x0112</span><span class="p">]</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>            <span class="n">image</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;exif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exif</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>    <span class="k">return</span> <span class="n">image</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span> <span class="nf">seed_worker</span><span class="p">(</span><span class="n">worker_id</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="c1"># Set dataloader worker seed </span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="c1"># https://oneflow.readthedocs.io/en/master/utils.data.html?highlight=randomness#platform-specific-behaviors</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">worker_seed</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">initial_seed</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">worker_seed</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">worker_seed</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="k">def</span> <span class="nf">create_dataloader</span><span class="p">(</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="n">path</span><span class="p">,</span> <span class="c1">#  path: å›¾ç‰‡æ•°æ®åŠ è½½è·¯å¾„ train/test  å¦‚: ../datasets/coco/images/train2017</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">imgsz</span><span class="p">,</span> <span class="c1">#  train/testå›¾ç‰‡å°ºå¯¸ï¼ˆæ•°æ®å¢å¼ºåå¤§å°ï¼‰ 640</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">batch_size</span><span class="p">,</span><span class="c1">#  batch size å¤§å° 8/16/32</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">stride</span><span class="p">,</span> <span class="c1"># æ¨¡å‹æœ€å¤§stride=32   [32 16 8]</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="n">single_cls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1">#  æ•°æ®é›†æ˜¯å¦æ˜¯å•ç±»åˆ« é»˜è®¤False</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">hyp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="c1"># è¶…å‚åˆ—è¡¨dict ç½‘ç»œè®­ç»ƒæ—¶çš„ä¸€äº›è¶…å‚æ•°ï¼ŒåŒ…æ‹¬å­¦ä¹ ç‡ç­‰ï¼Œè¿™é‡Œä¸»è¦ç”¨åˆ°é‡Œé¢ä¸€äº›å…³äºæ•°æ®å¢å¼º(æ—‹è½¬ã€å¹³ç§»ç­‰)çš„ç³»æ•°</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="c1"># æ˜¯å¦è¦è¿›è¡Œæ•°æ®å¢å¼º  True</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># æ˜¯å¦cache_images False</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="n">pad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="c1"># è®¾ç½®çŸ©å½¢è®­ç»ƒçš„shapeæ—¶è¿›è¡Œçš„å¡«å…… é»˜è®¤0.0</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="n">rect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># æ˜¯å¦å¼€å¯çŸ©å½¢train/test  é»˜è®¤è®­ç»ƒé›†å…³é—­ éªŒè¯é›†å¼€å¯</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>    <span class="n">rank</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># å¤šå¡è®­ç»ƒæ—¶çš„è¿›ç¨‹ç¼–å· rankä¸ºè¿›ç¨‹ç¼–å·  -1ä¸”gpu=1æ—¶ä¸è¿›è¡Œåˆ†å¸ƒå¼  -1ä¸”å¤šå—gpuä½¿ç”¨DataParallelæ¨¡å¼  é»˜è®¤-1</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="n">workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="c1"># dataloaderçš„num_works åŠ è½½æ•°æ®æ—¶çš„cpuè¿›ç¨‹æ•°</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="n">image_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># è®­ç»ƒæ—¶æ˜¯å¦æ ¹æ®å›¾ç‰‡æ ·æœ¬çœŸå®æ¡†åˆ†å¸ƒæƒé‡æ¥é€‰æ‹©å›¾ç‰‡  é»˜è®¤False</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="n">quad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># dataloaderå–æ•°æ®æ—¶, æ˜¯å¦ä½¿ç”¨collate_fn4ä»£æ›¿collate_fn  é»˜è®¤False</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="c1"># æ˜¾ç¤ºä¿¡æ¯   ä¸€ä¸ªæ ‡å¿—ï¼Œå¤šä¸ºtrain/valï¼Œå¤„ç†æ ‡ç­¾æ—¶ä¿å­˜cacheæ–‡ä»¶ä¼šç”¨åˆ°</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="c1"># å¯¹è®­ç»ƒæ•°æ®æ˜¯å¦éšæœºæ‰“ä¹±ã€‚</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="p">):</span>  
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>    <span class="sd">&quot;&quot;&quot;åœ¨train.pyä¸­è¢«è°ƒç”¨ï¼Œç”¨äºç”ŸæˆTrainloader, datasetï¼Œtestloader</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="sd">    è‡ªå®šä¹‰dataloaderå‡½æ•°: è°ƒç”¨LoadImagesAndLabelsè·å–æ•°æ®é›†(åŒ…æ‹¬æ•°æ®å¢å¼º) + è°ƒç”¨åˆ†å¸ƒå¼é‡‡æ ·å™¨DistributedSampler +</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="sd">                        è‡ªå®šä¹‰InfiniteDataLoader è¿›è¡Œæ°¸ä¹…æŒç»­çš„é‡‡æ ·æ•°æ®</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>    <span class="k">if</span> <span class="n">rect</span> <span class="ow">and</span> <span class="n">shuffle</span><span class="p">:</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WARNING: --rect is incompatible with DataLoader shuffle, setting shuffle=False&quot;</span><span class="p">)</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>    <span class="c1"># è½½å…¥æ–‡ä»¶æ•°æ®(å¢å¼ºæ•°æ®é›†)</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">LoadImagesAndLabels</span><span class="p">(</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>        <span class="n">path</span><span class="p">,</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="n">imgsz</span><span class="p">,</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>        <span class="n">augment</span><span class="o">=</span><span class="n">augment</span><span class="p">,</span>  <span class="c1"># augmentation</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>        <span class="n">hyp</span><span class="o">=</span><span class="n">hyp</span><span class="p">,</span>  <span class="c1"># hyperparameters</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>        <span class="n">rect</span><span class="o">=</span><span class="n">rect</span><span class="p">,</span>  <span class="c1"># rectangular batches</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>        <span class="n">cache_images</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>        <span class="n">single_cls</span><span class="o">=</span><span class="n">single_cls</span><span class="p">,</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="n">stride</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">stride</span><span class="p">),</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>        <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">,</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>        <span class="n">image_weights</span><span class="o">=</span><span class="n">image_weights</span><span class="p">,</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>        <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>    <span class="p">)</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>    <span class="n">nd</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>  <span class="c1"># number of CUDA devices</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>    <span class="n">nw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">//</span> <span class="nb">max</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="p">])</span>  <span class="c1"># number of workers</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>    <span class="c1"># åˆ†å¸ƒå¼é‡‡æ ·å™¨DistributedSampler</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>    <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">distributed</span><span class="o">.</span><span class="n">DistributedSampler</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>    <span class="c1"># ä½¿ç”¨InfiniteDataLoaderå’Œ_RepeatSampleræ¥å¯¹DataLoaderè¿›è¡Œå°è£…, ä»£æ›¿åŸå…ˆçš„DataLoader, èƒ½å¤Ÿæ°¸ä¹…æŒç»­çš„é‡‡æ ·æ•°æ®</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span> <span class="k">if</span> <span class="n">image_weights</span> <span class="k">else</span> <span class="n">InfiniteDataLoader</span>  <span class="c1"># only DataLoader allows for attribute updates</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>    <span class="c1"># éšæœºæ•°ç”Ÿæˆå™¨ https://oneflow.readthedocs.io/en/master/generated/oneflow.randint.html?highlight=flow.Generator#oneflow.randint</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>    <span class="n">generator</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span> 
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>    <span class="n">generator</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">6148914691236517205</span> <span class="o">+</span> <span class="n">RANK</span><span class="p">)</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="n">loader</span><span class="p">(</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>            <span class="n">dataset</span><span class="p">,</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span> <span class="ow">and</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>            <span class="n">num_workers</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>            <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>            <span class="n">collate_fn</span><span class="o">=</span><span class="n">LoadImagesAndLabels</span><span class="o">.</span><span class="n">collate_fn4</span> <span class="k">if</span> <span class="n">quad</span> <span class="k">else</span> <span class="n">LoadImagesAndLabels</span><span class="o">.</span><span class="n">collate_fn</span><span class="p">,</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>            <span class="n">worker_init_fn</span><span class="o">=</span><span class="n">seed_worker</span><span class="p">,</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>        <span class="p">),</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>        <span class="n">dataset</span><span class="p">,</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>    <span class="p">)</span>
</code></pre></div>
<h2 id="3dataloader">3.è‡ªå®šä¹‰DataLoader</h2>
<p>&emsp;å½“image_weights=Falseæ—¶ï¼ˆä¸æ ¹æ®å›¾ç‰‡æ ·æœ¬çœŸå®æ¡†åˆ†å¸ƒæƒé‡æ¥é€‰æ‹©å›¾ç‰‡ï¼‰å°±ä¼šè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•° è¿›è¡Œè‡ªå®šä¹‰DataLoaderï¼Œè¿›è¡ŒæŒç»­æ€§é‡‡æ ·ã€‚åœ¨ä¸Šé¢çš„create_dataloadeå‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span> <span class="nc">InfiniteDataLoader</span><span class="p">(</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="sd">&quot;&quot;&quot;Dataloader that reuses workers</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">    å½“image_weights=Falseæ—¶å°±ä¼šä½¿ç”¨InfiniteDataLoaderå’Œ_RepeatSamplerè¿™ä¸¤ä¸ªç±»å®ç°è‡ªå®šä¹‰DataLoader</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="sd">    ä½¿ç”¨InfiniteDataLoaderå’Œ_RepeatSampleræ¥å¯¹DataLoaderè¿›è¡Œå°è£…, ä»£æ›¿åŸå…ˆçš„DataLoader, èƒ½å¤Ÿæ°¸ä¹…æŒç»­çš„é‡‡æ ·æ•°æ®</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="sd">    Uses same syntax as vanilla DataLoader</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        <span class="c1"># è°ƒç”¨_RepeatSamplerè¿›è¡ŒæŒç»­é‡‡æ ·</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;batch_sampler&quot;</span><span class="p">,</span> <span class="n">_RepeatSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_sampler</span><span class="p">))</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_sampler</span><span class="o">.</span><span class="n">sampler</span><span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>            <span class="k">yield</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="k">class</span> <span class="nc">_RepeatSampler</span><span class="p">:</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="sd">&quot;&quot;&quot;Sampler that repeats forever</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="sd">     è¿™éƒ¨åˆ†æ˜¯è¿›è¡ŒæŒç»­é‡‡æ ·</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="sd">    Args:</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="sd">        sampler (Sampler)</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampler</span><span class="p">):</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">sampler</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>            <span class="k">yield from</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">)</span>
</code></pre></div>
<h2 id="4-loadimagesandlabels">4. LoadImagesAndLabels</h2>
<p>&emsp;è¿™ä¸ªéƒ¨åˆ†æ˜¯æ•°æ®è½½å…¥ï¼ˆæ•°æ®å¢å¼ºï¼‰éƒ¨åˆ†ï¼Œ</p>
<p>ä¹Ÿå°±æ˜¯è‡ªå®šä¹‰æ•°æ®é›†éƒ¨åˆ†ï¼Œç»§æ‰¿è‡ªDatasetï¼Œéœ€è¦é‡å†™__init__,__getitem()__ç­‰æŠ½è±¡æ–¹æ³•ï¼Œ</p>
<p>å¦å¤–ç›®æ ‡æ£€æµ‹ä¸€èˆ¬è¿˜éœ€è¦é‡å†™collate_fnå‡½æ•°ã€‚æ‰€ä»¥ï¼Œç†è§£è¿™ä¸‰ä¸ªå‡½æ•°æ˜¯ç†è§£æ•°æ®å¢å¼ºï¼ˆæ•°æ®è½½å…¥ï¼‰çš„é‡ä¸­ä¹‹é‡ã€‚</p>
<h3 id="41-init">4.1 init</h3>
<p>è¿™ä¸ªå‡½æ•°çš„å…¥å£æ˜¯ä¸Šé¢çš„create_dataloaderå‡½æ•°ï¼š
<img alt="image" src="https://user-images.githubusercontent.com/109639975/199916141-2ac22f90-abe0-4b0f-8654-282c857d5804.png" />
<img alt="image" src="https://user-images.githubusercontent.com/109639975/199916291-e60a796a-2e77-4fa1-aa22-869cafb23969.png" /></p>
<p><strong>init</strong> ä¸»è¦å¹²äº†ä¸€ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ol>
<li>èµ‹å€¼ä¸€äº›åŸºç¡€çš„selfå˜é‡ ç”¨äºåé¢åœ¨__getitem__ä¸­è°ƒç”¨</li>
<li>å¾—åˆ°pathè·¯å¾„ä¸‹çš„æ‰€æœ‰å›¾ç‰‡çš„è·¯å¾„self.img_files</li>
<li>æ ¹æ®imgsè·¯å¾„æ‰¾åˆ°labelsçš„è·¯å¾„self.label_files</li>
<li>cache label</li>
<li>Read cache ç”Ÿæˆself.labelsã€self.shapesã€self.img_filesã€self.label_filesã€self.batchã€self.nã€self.indicesç­‰å˜é‡</li>
<li>ä¸ºRectangular Trainingä½œå‡†å¤‡: ç”Ÿæˆself.batch_shapes</li>
<li>æ˜¯å¦éœ€è¦cache image(ä¸€èˆ¬ä¸éœ€è¦ï¼Œå¤ªå¤§äº†)</li>
</ol>
<p>__init__å‡½æ•°ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a> <span class="k">class</span> <span class="nc">LoadImagesAndLabels</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="n">path</span><span class="p">,</span> 
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="n">img_size</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="n">hyp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>        <span class="n">rect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="n">image_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="n">cache_images</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="n">single_cls</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="n">stride</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="n">pad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="p">):</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="sd">    åˆå§‹åŒ–è¿‡ç¨‹å¹¶æ²¡æœ‰ä»€ä¹ˆå®è´¨æ€§çš„æ“ä½œ,æ›´å¤šæ˜¯ä¸€ä¸ªå®šä¹‰å‚æ•°çš„è¿‡ç¨‹ï¼ˆselfå‚æ•°ï¼‰,ä»¥ä¾¿åœ¨__getitem()__ä¸­è¿›è¡Œæ•°æ®å¢å¼ºæ“ä½œ,æ‰€ä»¥è¿™éƒ¨åˆ†ä»£ç åªéœ€è¦æŠ“ä½selfä¸­çš„å„ä¸ªå˜é‡çš„å«ä¹‰å°±ç®—å·®ä¸å¤šäº†</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="sd">    self.img_files: {list: N} å­˜æ”¾ç€æ•´ä¸ªæ•°æ®é›†å›¾ç‰‡çš„ç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="sd">    self.label_files: {list: N} å­˜æ”¾ç€æ•´ä¸ªæ•°æ®é›†å›¾ç‰‡çš„ç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="sd">    cache label -&gt; verify_image_label</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="sd">    self.labels: å¦‚æœæ•°æ®é›†æ‰€æœ‰å›¾ç‰‡ä¸­æ²¡æœ‰ä¸€ä¸ªå¤šè¾¹å½¢label  labelså­˜å‚¨çš„labelå°±éƒ½æ˜¯åŸå§‹label(éƒ½æ˜¯æ­£å¸¸çš„çŸ©å½¢label)</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="sd">                 å¦åˆ™å°†æ‰€æœ‰å›¾ç‰‡æ­£å¸¸gtçš„labelå­˜å…¥labels ä¸æ­£å¸¸gt(å­˜åœ¨ä¸€ä¸ªå¤šè¾¹å½¢)ç»è¿‡segments2boxesè½¬æ¢ä¸ºæ­£å¸¸çš„çŸ©å½¢label</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="sd">    self.shapes: æ‰€æœ‰å›¾ç‰‡çš„shape</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="sd">    self.segments: å¦‚æœæ•°æ®é›†æ‰€æœ‰å›¾ç‰‡ä¸­æ²¡æœ‰ä¸€ä¸ªå¤šè¾¹å½¢label  self.segments=None</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="sd">                   å¦åˆ™å­˜å‚¨æ•°æ®é›†ä¸­æ‰€æœ‰å­˜åœ¨å¤šè¾¹å½¢gtçš„å›¾ç‰‡çš„æ‰€æœ‰åŸå§‹label(è‚¯å®šæœ‰å¤šè¾¹å½¢label ä¹Ÿå¯èƒ½æœ‰çŸ©å½¢æ­£å¸¸label æœªçŸ¥æ•°)</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="sd">    self.batch: è®°è½½ç€æ¯å¼ å›¾ç‰‡å±äºå“ªä¸ªbatch</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="sd">    self.n: æ•°æ®é›†ä¸­æ‰€æœ‰å›¾ç‰‡çš„æ•°é‡</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="sd">    self.indices: è®°è½½ç€æ‰€æœ‰å›¾ç‰‡çš„index</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="sd">    self.rect=Trueæ—¶self.batch_shapesè®°è½½æ¯ä¸ªbatchçš„shape(åŒä¸€ä¸ªbatchçš„å›¾ç‰‡shapeç›¸åŒ)</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>       <span class="c1"># 1ã€èµ‹å€¼ä¸€äº›åŸºç¡€çš„selfå˜é‡ ç”¨äºåé¢åœ¨__getitem__ä¸­è°ƒç”¨</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>  <span class="c1"># ç»è¿‡æ•°æ®å¢å¼ºåçš„æ•°æ®å›¾ç‰‡çš„å¤§å°</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment</span> <span class="o">=</span> <span class="n">augment</span>    <span class="c1"># æ˜¯å¦å¯åŠ¨æ•°æ®å¢å¼º ä¸€èˆ¬è®­ç»ƒæ—¶æ‰“å¼€ éªŒè¯æ—¶å…³é—­</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="n">hyp</span>            <span class="c1"># è¶…å‚åˆ—è¡¨</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="c1"># å›¾ç‰‡æŒ‰æƒé‡é‡‡æ ·  Trueå°±å¯ä»¥æ ¹æ®ç±»åˆ«é¢‘ç‡(é¢‘ç‡é«˜çš„æƒé‡å°,åæ­£å¤§)æ¥è¿›è¡Œé‡‡æ ·  é»˜è®¤False: ä¸ä½œç±»åˆ«åŒºåˆ†</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_weights</span> <span class="o">=</span> <span class="n">image_weights</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rect</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">image_weights</span> <span class="k">else</span> <span class="n">rect</span>  <span class="c1"># æ˜¯å¦å¯åŠ¨çŸ©å½¢è®­ç»ƒ ä¸€èˆ¬è®­ç»ƒæ—¶å…³é—­ éªŒè¯æ—¶æ‰“å¼€ å¯ä»¥åŠ é€Ÿ</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mosaic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span>  <span class="c1"># load 4 images at a time into a mosaic (only during training)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="c1"># mosaicå¢å¼ºçš„è¾¹ç•Œå€¼  [-320, -320]</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mosaic_border</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">img_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">img_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>      <span class="c1"># æœ€å¤§ä¸‹é‡‡æ ·ç‡ 32</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>          <span class="c1"># å›¾ç‰‡è·¯å¾„</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">albumentations</span> <span class="o">=</span> <span class="n">Albumentations</span><span class="p">()</span> <span class="k">if</span> <span class="n">augment</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="c1"># 2ã€å¾—åˆ°pathè·¯å¾„ä¸‹çš„æ‰€æœ‰å›¾ç‰‡çš„è·¯å¾„self.img_files  è¿™é‡Œéœ€è¦è‡ªå·±debugä¸€ä¸‹ ä¸ä¼šå¤ªéš¾</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>            <span class="n">f</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># image files</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">path</span><span class="p">]:</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>                <span class="c1"># è·å–æ•°æ®é›†è·¯å¾„pathï¼ŒåŒ…å«å›¾ç‰‡è·¯å¾„çš„txtæ–‡ä»¶æˆ–è€…åŒ…å«å›¾ç‰‡çš„æ–‡ä»¶å¤¹è·¯å¾„</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>                <span class="c1"># ä½¿ç”¨pathlib.Pathç”Ÿæˆä¸æ“ä½œç³»ç»Ÿæ— å…³çš„è·¯å¾„ï¼Œå› ä¸ºä¸åŒæ“ä½œç³»ç»Ÿè·¯å¾„çš„â€˜/â€™ä¼šæœ‰æ‰€ä¸åŒ</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># os-agnostic</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>                <span class="c1"># å¦‚æœè·¯å¾„pathä¸ºåŒ…å«å›¾ç‰‡çš„æ–‡ä»¶å¤¹è·¯å¾„</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>  <span class="c1"># dir</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>                    <span class="c1"># glob.glab: è¿”å›æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨  é€’å½’è·å–pè·¯å¾„ä¸‹æ‰€æœ‰æ–‡ä»¶</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>                    <span class="n">f</span> <span class="o">+=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="s1">&#39;**&#39;</span> <span class="o">/</span> <span class="s1">&#39;*.*&#39;</span><span class="p">),</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>                    <span class="c1"># f = list(p.rglob(&#39;**/*.*&#39;))  # pathlib</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>                <span class="c1"># å¦‚æœè·¯å¾„pathä¸ºåŒ…å«å›¾ç‰‡è·¯å¾„çš„txtæ–‡ä»¶</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>                <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>  <span class="c1"># file</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>                        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>  <span class="c1"># è·å–å›¾ç‰‡è·¯å¾„ï¼Œæ›´æ¢ç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>                        <span class="c1"># è·å–æ•°æ®é›†è·¯å¾„çš„ä¸Šçº§çˆ¶ç›®å½•  os.sepä¸ºè·¯å¾„é‡Œçš„åˆ†éš”ç¬¦ï¼ˆä¸åŒè·¯å¾„çš„åˆ†éš”ç¬¦ä¸åŒï¼Œos.sepå¯ä»¥æ ¹æ®ç³»ç»Ÿè‡ªé€‚åº”ï¼‰</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>                        <span class="n">parent</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>                        <span class="n">f</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>  <span class="c1"># local to global path</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>                        <span class="c1"># f += [p.parent / x.lstrip(os.sep) for x in t]  # local to global path (pathlib)</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">p</span><span class="si">}</span><span class="s1"> does not exist&#39;</span><span class="p">)</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>            <span class="c1"># ç ´æŠ˜å·æ›¿æ¢ä¸ºos.sepï¼Œos.path.splitext(x)å°†æ–‡ä»¶åä¸æ‰©å±•ååˆ†å¼€å¹¶è¿”å›ä¸€ä¸ªåˆ—è¡¨</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>            <span class="c1"># ç­›é€‰fä¸­æ‰€æœ‰çš„å›¾ç‰‡æ–‡ä»¶</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">IMG_FORMATS</span><span class="p">)</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>            <span class="c1"># self.img_files = sorted([x for x in f if x.suffix[1:].lower() in IMG_FORMATS])  # pathlib</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_files</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">No images found&quot;</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Error loading data from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">See </span><span class="si">{</span><span class="n">HELP_URL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>        <span class="c1"># Check cache  3æ ¹æ®imgsè·¯å¾„æ‰¾åˆ°labelsçš„è·¯å¾„self.label_files</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label_files</span> <span class="o">=</span> <span class="n">img2label_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_files</span><span class="p">)</span>  <span class="c1"># labels</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>        <span class="c1"># 4ã€cache label ä¸‹æ¬¡è¿è¡Œè¿™ä¸ªè„šæœ¬çš„æ—¶å€™ç›´æ¥ä»cacheä¸­å–labelè€Œä¸æ˜¯å»æ–‡ä»¶ä¸­å–label é€Ÿåº¦æ›´å¿«</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>        <span class="n">cache_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.cache&quot;</span><span class="p">)</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>            <span class="c1"># å¦‚æœæœ‰cacheæ–‡ä»¶ï¼Œç›´æ¥åŠ è½½  exists=True: æ˜¯å¦å·²ä»cacheæ–‡ä»¶ä¸­è¯»å‡ºäº†nf, nm, ne, nc, nç­‰ä¿¡æ¯</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>            <span class="n">cache</span><span class="p">,</span> <span class="n">exists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="kc">True</span>  <span class="c1"># load dict</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>            <span class="k">assert</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_version</span>  <span class="c1"># matches current version</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>            <span class="k">assert</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;hash&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">get_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_files</span><span class="p">)</span>  <span class="c1"># identical hash</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>            <span class="c1"># å¦‚æœå›¾ç‰‡ç‰ˆæœ¬ä¿¡æ¯æˆ–è€…æ–‡ä»¶åˆ—è¡¨çš„hashå€¼å¯¹ä¸ä¸Šå· è¯´æ˜æœ¬åœ°æ•°æ®é›†å›¾ç‰‡å’Œlabelå¯èƒ½å‘ç”Ÿäº†å˜åŒ– å°±é‡æ–°cache labelæ–‡ä»¶</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>            <span class="n">cache</span><span class="p">,</span> <span class="n">exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_labels</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span> <span class="kc">False</span>  <span class="c1"># run cache ops</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>        <span class="c1"># Display cache</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>        <span class="c1"># æ‰“å°cacheçš„ç»“æœ nf nm ne nc n = æ‰¾åˆ°çš„æ ‡ç­¾æ•°é‡ï¼Œæ¼æ‰çš„æ ‡ç­¾æ•°é‡ï¼Œç©ºçš„æ ‡ç­¾æ•°é‡ï¼ŒæŸåçš„æ ‡ç­¾æ•°é‡ï¼Œæ€»çš„æ ‡ç­¾æ•°é‡</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>        <span class="n">nf</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">)</span>  <span class="c1"># found, missing, empty, corrupt, total</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>        <span class="c1"># å¦‚æœå·²ç»ä»cacheæ–‡ä»¶è¯»å‡ºäº†nf nm ne nc nç­‰ä¿¡æ¯ï¼Œç›´æ¥æ˜¾ç¤ºæ ‡ç­¾ä¿¡æ¯  msgsä¿¡æ¯ç­‰</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>        <span class="k">if</span> <span class="n">exists</span> <span class="ow">and</span> <span class="n">LOCAL_RANK</span> <span class="ow">in</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}:</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>            <span class="n">d</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Scanning &#39;</span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">&#39; images and labels... </span><span class="si">{</span><span class="n">nf</span><span class="si">}</span><span class="s2"> found, </span><span class="si">{</span><span class="n">nm</span><span class="si">}</span><span class="s2"> missing, </span><span class="si">{</span><span class="n">ne</span><span class="si">}</span><span class="s2"> empty, </span><span class="si">{</span><span class="n">nc</span><span class="si">}</span><span class="s2"> corrupt&quot;</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>            <span class="n">tqdm</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="n">BAR_FORMAT</span><span class="p">)</span>  <span class="c1"># display cache results</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>            <span class="k">if</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;msgs&quot;</span><span class="p">]:</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache</span><span class="p">[</span><span class="s2">&quot;msgs&quot;</span><span class="p">]))</span>  <span class="c1"># display warnings</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>        <span class="c1"># æ•°æ®é›†æ²¡æœ‰æ ‡ç­¾ä¿¡æ¯ å°±å‘å‡ºè­¦å‘Šå¹¶æ˜¾ç¤ºæ ‡ç­¾labelä¸‹è½½åœ°å€help_url</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>        <span class="k">assert</span> <span class="n">nf</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">augment</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">No labels in </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">. Can not train without labels. See </span><span class="si">{</span><span class="n">HELP_URL</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>         <span class="c1"># 5ã€Read cache  ä»cacheä¸­è¯»å‡ºæœ€æ–°å˜é‡èµ‹ç»™self  æ–¹ä¾¿ç»™forwardä¸­ä½¿ç”¨</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>        <span class="c1"># cacheä¸­çš„é”®å€¼å¯¹æœ€åˆæœ‰: cache[img_file]=[l, shape, segments] cache[hash] cache[results] cache[msg] cache[version]</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>        <span class="c1"># å…ˆä»cacheä¸­å»é™¤cacheæ–‡ä»¶ä¸­å…¶ä»–æ— å…³é”®å€¼å¦‚:&#39;hash&#39;, &#39;version&#39;, &#39;msgs&#39;ç­‰éƒ½åˆ é™¤</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>        <span class="p">[</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;msgs&#39;</span><span class="p">)]</span>  <span class="c1"># remove items</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>        <span class="c1"># popæ‰resultsã€hashã€versionã€msgsååªå‰©ä¸‹cache[img_file]=[l, shape, segments]</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>        <span class="c1"># cache.values(): å–cacheä¸­æ‰€æœ‰å€¼ å¯¹åº”æ‰€æœ‰l, shape, segments</span>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>        <span class="c1"># labels: å¦‚æœæ•°æ®é›†æ‰€æœ‰å›¾ç‰‡ä¸­æ²¡æœ‰ä¸€ä¸ªå¤šè¾¹å½¢label  labelså­˜å‚¨çš„labelå°±éƒ½æ˜¯åŸå§‹label(éƒ½æ˜¯æ­£å¸¸çš„çŸ©å½¢label)</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>        <span class="c1">#         å¦åˆ™å°†æ‰€æœ‰å›¾ç‰‡æ­£å¸¸gtçš„labelå­˜å…¥labels ä¸æ­£å¸¸gt(å­˜åœ¨ä¸€ä¸ªå¤šè¾¹å½¢)ç»è¿‡segments2boxesè½¬æ¢ä¸ºæ­£å¸¸çš„çŸ©å½¢label</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>        <span class="c1"># shapes: æ‰€æœ‰å›¾ç‰‡çš„shape</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>        <span class="c1"># self.segments: å¦‚æœæ•°æ®é›†æ‰€æœ‰å›¾ç‰‡ä¸­æ²¡æœ‰ä¸€ä¸ªå¤šè¾¹å½¢label  self.segments=None</span>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>        <span class="c1">#                å¦åˆ™å­˜å‚¨æ•°æ®é›†ä¸­æ‰€æœ‰å­˜åœ¨å¤šè¾¹å½¢gtçš„å›¾ç‰‡çš„æ‰€æœ‰åŸå§‹label(è‚¯å®šæœ‰å¤šè¾¹å½¢label ä¹Ÿå¯èƒ½æœ‰çŸ©å½¢æ­£å¸¸label æœªçŸ¥æ•°)</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>        <span class="c1"># zip æ˜¯å› ä¸ºcacheä¸­æ‰€æœ‰labelsã€shapesã€segmentsä¿¡æ¯éƒ½æ˜¯æŒ‰æ¯å¼ imgåˆ†å¼€å­˜å‚¨çš„, zipæ˜¯å°†æ‰€æœ‰å›¾ç‰‡å¯¹åº”çš„ä¿¡æ¯å åœ¨ä¸€èµ·</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>        <span class="n">labels</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">cache</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># segments: éƒ½æ˜¯[]</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">im_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># update</span>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label_files</span> <span class="o">=</span> <span class="n">img2label_paths</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># update  æ›´æ–°æ‰€æœ‰å›¾ç‰‡çš„label_filesä¿¡æ¯(å› ä¸ºimg_filesä¿¡æ¯å¯èƒ½å‘ç”Ÿäº†å˜åŒ–)</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>  <span class="c1"># number of images</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>        <span class="n">bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>  <span class="c1"># batch index</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>        <span class="n">nb</span> <span class="o">=</span> <span class="n">bi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># number of batches</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">bi</span>  <span class="c1"># batch index of image æ‰€æœ‰å›¾ç‰‡çš„index</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>        <span class="c1"># Update labels</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>        <span class="n">include_class</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># filter labels to include only these classes (optional)</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>        <span class="n">include_class_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">include_class</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">)):</span>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>            <span class="k">if</span> <span class="n">include_class</span><span class="p">:</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>                <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">label</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">include_class_array</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>                <span class="k">if</span> <span class="n">segment</span><span class="p">:</span>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>            <span class="k">if</span> <span class="n">single_cls</span><span class="p">:</span>  <span class="c1"># single-class training, merge all classes into 0</span>
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>                <span class="k">if</span> <span class="n">segment</span><span class="p">:</span>
<a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>
<a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>        <span class="c1"># Rectangular Training</span>
<a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>        <span class="c1"># 6ã€ä¸ºRectangular Trainingä½œå‡†å¤‡</span>
<a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>        <span class="c1"># è¿™é‡Œä¸»è¦æ˜¯æ³¨æ„shapesçš„ç”Ÿæˆ è¿™ä¸€æ­¥å¾ˆé‡è¦ å› ä¸ºå¦‚æœé‡‡æ ·çŸ©å½¢è®­ç»ƒé‚£ä¹ˆæ•´ä¸ªbatchçš„å½¢çŠ¶è¦ä¸€æ · å°±è¦è®¡ç®—è¿™ä¸ªç¬¦åˆæ•´ä¸ªbatchçš„shape</span>
<a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>        <span class="c1"># è€Œä¸”è¿˜è¦å¯¹æ•°æ®é›†æŒ‰ç…§é«˜å®½æ¯”è¿›è¡Œæ’åº è¿™æ ·æ‰èƒ½ä¿è¯åŒä¸€ä¸ªbatchçš„å›¾ç‰‡çš„å½¢çŠ¶å·®ä¸å¤šç›¸åŒ å†é€‰åˆ™ä¸€ä¸ªå…±åŒçš„shapeä»£ä»·ä¹Ÿæ¯”è¾ƒå°</span>
<a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">:</span>
<a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>            <span class="c1"># Sort by aspect ratio</span>
<a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span>  <span class="c1"># wh</span>
<a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>            <span class="n">ar</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># aspect ratio</span>
<a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>            <span class="n">irect</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>  <span class="c1"># æ ¹æ®é«˜å®½æ¯”æ’åº</span>
<a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">irect</span><span class="p">]</span>      <span class="c1"># è·å–æ’åºåçš„img_files</span>
<a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">label_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">irect</span><span class="p">]</span>  <span class="c1"># è·å–æ’åºåçš„label_files</span>
<a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">irect</span><span class="p">]</span>            <span class="c1"># è·å–æ’åºåçš„labels</span>
<a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shapes</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">irect</span><span class="p">]</span>                                   <span class="c1"># è·å–æ’åºåçš„wh</span>
<a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>            <span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="p">[</span><span class="n">irect</span><span class="p">]</span>                                           <span class="c1"># è·å–æ’åºåçš„aspect ratio</span>
<a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>
<a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>            <span class="c1"># è®¡ç®—æ¯ä¸ªbatché‡‡ç”¨çš„ç»Ÿä¸€å°ºåº¦ Set training image shapes</span>
<a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">nb</span>    <span class="c1"># nb: number of batches</span>
<a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">):</span>
<a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>                <span class="n">ari</span> <span class="o">=</span> <span class="n">ar</span><span class="p">[</span><span class="n">bi</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>     <span class="c1"># bi: batch index</span>
<a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>                <span class="n">mini</span><span class="p">,</span> <span class="n">maxi</span> <span class="o">=</span> <span class="n">ari</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ari</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>   <span class="c1"># è·å–ç¬¬iä¸ªbatchä¸­ï¼Œæœ€å°å’Œæœ€å¤§é«˜å®½æ¯”</span>
<a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>                <span class="c1"># å¦‚æœé«˜/å®½å°äº1(w &gt; h)ï¼Œå°†wè®¾ä¸ºimg_sizeï¼ˆä¿è¯åŸå›¾åƒå°ºåº¦ä¸å˜è¿›è¡Œç¼©æ”¾ï¼‰</span>
<a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a>                <span class="k">if</span> <span class="n">maxi</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a>                    <span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">maxi</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>   <span class="c1"># maxi: hç›¸å¯¹æŒ‡å®šå°ºåº¦çš„æ¯”ä¾‹  1: wç›¸å¯¹æŒ‡å®šå°ºåº¦çš„æ¯”ä¾‹</span>
<a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a>                <span class="c1"># å¦‚æœé«˜/å®½å¤§äº1(w &lt; h)ï¼Œå°†hè®¾ç½®ä¸ºimg_sizeï¼ˆä¿è¯åŸå›¾åƒå°ºåº¦ä¸å˜è¿›è¡Œç¼©æ”¾ï¼‰</span>
<a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a>                <span class="k">elif</span> <span class="n">mini</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>                    <span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">mini</span><span class="p">]</span>
<a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>
<a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>            <span class="c1"># è®¡ç®—æ¯ä¸ªbatchè¾“å…¥ç½‘ç»œçš„shapeå€¼(å‘ä¸Šè®¾ç½®ä¸º32çš„æ•´æ•°å€)</span>
<a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>            <span class="c1"># è¦æ±‚æ¯ä¸ªbatch_shapesçš„é«˜å®½éƒ½æ˜¯32çš„æ•´æ•°å€ï¼Œæ‰€ä»¥è¦å…ˆé™¤ä»¥32ï¼Œå–æ•´å†ä¹˜ä»¥32ï¼ˆä¸è¿‡img_sizeå¦‚æœæ˜¯32å€æ•°è¿™é‡Œå°±æ²¡å¿…è¦äº†ï¼‰</span>
<a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">batch_shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_size</span> <span class="o">/</span> <span class="n">stride</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">stride</span>
<a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a>
<a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>        <span class="c1"># 7ã€æ˜¯å¦éœ€è¦cache image ä¸€èˆ¬æ˜¯False å› ä¸ºRAMä¼šä¸è¶³  cache labelè¿˜å¯ä»¥ ä½†æ˜¯cache imageå°±å¤ªå¤§äº† æ‰€ä»¥ä¸€èˆ¬ä¸ç”¨</span>
<a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>        <span class="c1"># Cache images into RAM/disk for faster training (WARNING: large datasets may exceed system resources)</span>
<a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
<a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">npy_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.npy&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_files</span><span class="p">]</span>
<a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a>        <span class="k">if</span> <span class="n">cache_images</span><span class="p">:</span>
<a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a>            <span class="n">gb</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Gigabytes of cached images</span>
<a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_hw0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_hw</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
<a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a>            <span class="n">fcn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_images_to_disk</span> <span class="k">if</span> <span class="n">cache_images</span> <span class="o">==</span> <span class="s2">&quot;disk&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span>
<a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">NUM_THREADS</span><span class="p">)</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">fcn</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a>            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="n">BAR_FORMAT</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">LOCAL_RANK</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>                <span class="k">if</span> <span class="n">cache_images</span> <span class="o">==</span> <span class="s2">&quot;disk&quot;</span><span class="p">:</span>
<a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a>                    <span class="n">gb</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">npy_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
<a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># &#39;ram&#39;</span>
<a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>                    <span class="p">(</span>
<a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ims</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">im_hw0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">im_hw</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a>                    <span class="p">)</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># im, hw_orig, hw_resized = load_image(self, i)</span>
<a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>                    <span class="n">gb</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nbytes</span>
<a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>                <span class="n">pbar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Caching images (</span><span class="si">{</span><span class="n">gb</span> <span class="o">/</span> <span class="mf">1E9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">GB </span><span class="si">{</span><span class="n">cache_images</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a>            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<h3 id="42-cache_labels">4.2 cache_labels</h3>
<p>è¿™ä¸ªå‡½æ•°ç”¨äºåŠ è½½æ–‡ä»¶è·¯å¾„ä¸­çš„labelä¿¡æ¯ç”Ÿæˆcacheæ–‡ä»¶ã€‚cacheæ–‡ä»¶ä¸­åŒ…æ‹¬çš„ä¿¡æ¯æœ‰ï¼šim_file, l, shape, segments, hash, results, msgs, versionç­‰ï¼Œå…·ä½“çœ‹ä»£ç æ³¨é‡Šã€‚</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span> <span class="nf">cache_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./labels.cache&#39;</span><span class="p">),</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åœ¨__init__å‡½æ•°ä¸­  cacheæ•°æ®é›†label</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="sd">    åŠ è½½labelä¿¡æ¯ç”Ÿæˆcacheæ–‡ä»¶   Cache dataset labels, check images and read shapes</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="sd">    :params path: cacheæ–‡ä»¶ä¿å­˜åœ°å€</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="sd">    :params prefix: æ—¥å¿—å¤´éƒ¨ä¿¡æ¯(å½©æ‰“é«˜äº®éƒ¨åˆ†)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="sd">    :return x: cacheä¸­ä¿å­˜çš„å­—å…¸</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="sd">           åŒ…æ‹¬çš„ä¿¡æ¯æœ‰: x[im_file] = [l, shape, segments]</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="sd">                      ä¸€å¼ å›¾ç‰‡ä¸€ä¸ªlabelç›¸å¯¹åº”çš„ä¿å­˜åˆ°x, æœ€ç»ˆxä¼šä¿å­˜æ‰€æœ‰å›¾ç‰‡çš„ç›¸å¯¹è·¯å¾„ã€gtæ¡†çš„ä¿¡æ¯ã€å½¢çŠ¶shapeã€æ‰€æœ‰çš„å¤šè¾¹å½¢gtä¿¡æ¯</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="sd">                          im_file: å½“å‰è¿™å¼ å›¾ç‰‡çš„pathç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="sd">                          l: å½“å‰è¿™å¼ å›¾ç‰‡çš„æ‰€æœ‰gtæ¡†çš„labelä¿¡æ¯(ä¸åŒ…å«segmentå¤šè¾¹å½¢æ ‡ç­¾) [gt_num, cls+xywh(normalized)]</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="sd">                          shape: å½“å‰è¿™å¼ å›¾ç‰‡çš„å½¢çŠ¶ shape</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="sd">                          segments: å½“å‰è¿™å¼ å›¾ç‰‡æ‰€æœ‰gtçš„labelä¿¡æ¯(åŒ…å«segmentå¤šè¾¹å½¢æ ‡ç­¾) [gt_num, xy1...]</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="sd">                       hash: å½“å‰å›¾ç‰‡å’Œlabelæ–‡ä»¶çš„hashå€¼  1</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="sd">                       results: æ‰¾åˆ°çš„labelä¸ªæ•°nf, ä¸¢å¤±labelä¸ªæ•°nm, ç©ºlabelä¸ªæ•°ne, ç ´æŸlabelä¸ªæ•°nc, æ€»img/labelä¸ªæ•°len(self.img_files)</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="sd">                       msgs: æ‰€æœ‰æ•°æ®é›†çš„msgsä¿¡æ¯</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="sd">                       version: å½“å‰cache version</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="n">x</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># åˆå§‹åŒ–æœ€ç»ˆcacheä¸­ä¿å­˜çš„å­—å…¸dict</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="c1"># åˆå§‹åŒ–number missing, found, empty, corrupt, messages</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    <span class="c1"># åˆå§‹åŒ–æ•´ä¸ªæ•°æ®é›†: æ¼æ‰çš„æ ‡ç­¾(label)æ€»æ•°é‡, æ‰¾åˆ°çš„æ ‡ç­¾(label)æ€»æ•°é‡, ç©ºçš„æ ‡ç­¾(label)æ€»æ•°é‡, é”™è¯¯æ ‡ç­¾(label)æ€»æ•°é‡, æ‰€æœ‰é”™è¯¯ä¿¡æ¯</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>    <span class="n">nm</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Scanning &#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">&#39; images and labels...&quot;</span>  <span class="c1"># æ—¥å¿—</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    <span class="c1"># å¤šè¿›ç¨‹è°ƒç”¨verify_image_labelå‡½æ•°</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="c1"># å®šä¹‰pbarè¿›åº¦æ¡</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="c1"># pool.imap_unordered: å¯¹å¤§é‡æ•°æ®éå†å¤šè¿›ç¨‹è®¡ç®— è¿”å›ä¸€ä¸ªè¿­ä»£å™¨</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="c1"># æŠŠself.img_files, self.label_files, repeat(prefix) listä¸­çš„å€¼ä½œä¸ºå‚æ•°ä¾æ¬¡é€å…¥(ä¸€æ¬¡é€ä¸€ä¸ª)verify_image_labelå‡½æ•°</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">verify_image_label</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_files</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">prefix</span><span class="p">))),</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>                    <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">))</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="c1"># im_file: å½“å‰è¿™å¼ å›¾ç‰‡çš„pathç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="c1"># l: [gt_num, cls+xywh(normalized)]</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="c1">#    å¦‚æœè¿™å¼ å›¾ç‰‡æ²¡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾ lå°±å­˜å‚¨åŸlabel(å…¨éƒ¨æ˜¯æ­£å¸¸çŸ©å½¢æ ‡ç­¾)</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="c1">#    å¦‚æœè¿™å¼ å›¾ç‰‡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾  lå°±å­˜å‚¨ç»è¿‡segments2boxeså¤„ç†å¥½çš„æ ‡ç­¾(æ­£å¸¸çŸ©å½¢æ ‡ç­¾ä¸å¤„ç† å¤šè¾¹å½¢æ ‡ç­¾è½¬åŒ–ä¸ºçŸ©å½¢æ ‡ç­¾)</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="c1"># shape: å½“å‰è¿™å¼ å›¾ç‰‡çš„å½¢çŠ¶ shape</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="c1"># segments: å¦‚æœè¿™å¼ å›¾ç‰‡æ²¡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾ å­˜å‚¨None</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>        <span class="c1">#           å¦‚æœè¿™å¼ å›¾ç‰‡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾ å°±æŠŠè¿™å¼ å›¾ç‰‡çš„æ‰€æœ‰labelå­˜å‚¨åˆ°segmentsä¸­(è‹¥å¹²ä¸ªæ­£å¸¸gt è‹¥å¹²ä¸ªå¤šè¾¹å½¢æ ‡ç­¾) [gt_num, xy1...]</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="c1"># nm_f(nm): number missing å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ˜¯å¦ä¸¢å¤±         ä¸¢å¤±=1    å­˜åœ¨=0</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="c1"># nf_f(nf): number found å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ˜¯å¦å­˜åœ¨           å­˜åœ¨=1    ä¸¢å¤±=0</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="c1"># ne_f(ne): number empty å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ˜¯å¦æ˜¯ç©ºçš„         ç©ºçš„=1    æ²¡ç©º=0</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>        <span class="c1"># nc_f(nc): number corrupt å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ–‡ä»¶æ˜¯å¦æ˜¯ç ´æŸçš„  ç ´æŸçš„=1  æ²¡ç ´æŸ=0</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="c1"># msg: è¿”å›çš„msgä¿¡æ¯  labelæ–‡ä»¶å®Œå¥½=â€˜â€™  labelæ–‡ä»¶ç ´æŸ=warningä¿¡æ¯</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="k">for</span> <span class="n">im_file</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">nm_f</span><span class="p">,</span> <span class="n">nf_f</span><span class="p">,</span> <span class="n">ne_f</span><span class="p">,</span> <span class="n">nc_f</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>            <span class="n">nm</span> <span class="o">+=</span> <span class="n">nm_f</span>  <span class="c1"># ç´¯åŠ æ€»number missing label</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>            <span class="n">nf</span> <span class="o">+=</span> <span class="n">nf_f</span>  <span class="c1"># ç´¯åŠ æ€»number found label</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>            <span class="n">ne</span> <span class="o">+=</span> <span class="n">ne_f</span>  <span class="c1"># ç´¯åŠ æ€»number empty label</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>            <span class="n">nc</span> <span class="o">+=</span> <span class="n">nc_f</span>  <span class="c1"># ç´¯åŠ æ€»number corrupt label</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>            <span class="k">if</span> <span class="n">im_file</span><span class="p">:</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>                <span class="n">x</span><span class="p">[</span><span class="n">im_file</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">segments</span><span class="p">]</span>  <span class="c1"># ä¿¡æ¯å­˜å…¥å­—å…¸ key=im_file  value=[l, shape, segments]</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>                <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  <span class="c1"># å°†msgåŠ å…¥æ€»msg</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>            <span class="n">pbar</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}{</span><span class="n">nf</span><span class="si">}</span><span class="s2"> found, </span><span class="si">{</span><span class="n">nm</span><span class="si">}</span><span class="s2"> missing, </span><span class="si">{</span><span class="n">ne</span><span class="si">}</span><span class="s2"> empty, </span><span class="si">{</span><span class="n">nc</span><span class="si">}</span><span class="s2"> corrupted&quot;</span>  <span class="c1"># æ—¥å¿—</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>    <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># å…³é—­è¿›åº¦æ¡</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>    <span class="c1"># æ—¥å¿—æ‰“å°æ‰€æœ‰msgä¿¡æ¯</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>    <span class="k">if</span> <span class="n">msgs</span><span class="p">:</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgs</span><span class="p">))</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>    <span class="c1"># ä¸€å¼ labeléƒ½æ²¡æ‰¾åˆ° æ—¥å¿—æ‰“å°help_urlä¸‹è½½åœ°å€</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>    <span class="k">if</span> <span class="n">nf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">WARNING: No labels found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">. See </span><span class="si">{</span><span class="n">help_url</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_files</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">)</span>  <span class="c1"># å°†å½“å‰å›¾ç‰‡å’Œlabelæ–‡ä»¶çš„hashå€¼å­˜å…¥æœ€ç»ˆå­—å…¸dist</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nf</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_files</span><span class="p">)</span>  <span class="c1"># å°†nf, nm, ne, nc, len(self.img_files)å­˜å…¥æœ€ç»ˆå­—å…¸dist</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;msgs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msgs</span>  <span class="c1"># å°†æ‰€æœ‰æ•°æ®é›†çš„msgsä¿¡æ¯å­˜å…¥æœ€ç»ˆå­—å…¸dist</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># å°†å½“å‰cache versionå­˜å…¥æœ€ç»ˆå­—å…¸dist</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>  <span class="c1"># save cache to path</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">New cache created: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">WARNING: Cache directory </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s1"> is not writeable: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># path not writeable</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<h3 id="43-getitem">4.3 <strong>getitem</strong></h3>
<p>&emsp;è¿™éƒ¨åˆ†æ˜¯æ•°æ®å¢å¼ºå‡½æ•°ï¼Œä¸€èˆ¬ä¸€æ¬¡æ€§æ‰§è¡Œbatch_sizeæ¬¡ã€‚</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>          <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="sd">        è¿™éƒ¨åˆ†æ˜¯æ•°æ®å¢å¼ºå‡½æ•°ï¼Œä¸€èˆ¬ä¸€æ¬¡æ€§æ‰§è¡Œbatch_sizeæ¬¡ã€‚</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="sd">        è®­ç»ƒ æ•°æ®å¢å¼º: mosaic(random_perspective) + hsv + ä¸Šä¸‹å·¦å³ç¿»è½¬</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="sd">        æµ‹è¯• æ•°æ®å¢å¼º: letterbox</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="sd">        :return torch.from_numpy(img): è¿™ä¸ªindexçš„å›¾ç‰‡æ•°æ®(å¢å¼ºå) [3, 640, 640]</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="sd">        :return labels_out: è¿™ä¸ªindexå›¾ç‰‡çš„gt label [6, 6] = [gt_num, 0+class+xywh(normalized)]</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="sd">        :return self.img_files[index]: è¿™ä¸ªindexå›¾ç‰‡çš„è·¯å¾„åœ°å€</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="sd">        :return shapes: è¿™ä¸ªbatchçš„å›¾ç‰‡çš„shapes æµ‹è¯•æ—¶(çŸ©å½¢è®­ç»ƒ)æ‰æœ‰  éªŒè¯æ—¶ä¸ºNone   for COCO mAP rescaling</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        <span class="c1"># è¿™é‡Œå¯ä»¥é€šè¿‡ä¸‰ç§å½¢å¼è·å–è¦è¿›è¡Œæ•°æ®å¢å¼ºçš„å›¾ç‰‡index  linear, shuffled, or image_weights</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># linear, shuffled, or image_weights</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>        <span class="n">hyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span>   <span class="c1"># è¶…å‚ åŒ…å«ä¼—å¤šæ•°æ®å¢å¼ºè¶…å‚</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        <span class="n">mosaic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mosaic</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;mosaic&quot;</span><span class="p">]</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        <span class="c1"># mosaicå¢å¼º å¯¹å›¾åƒè¿›è¡Œ4å¼ å›¾æ‹¼æ¥è®­ç»ƒ  ä¸€èˆ¬è®­ç»ƒæ—¶è¿è¡Œ</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>        <span class="c1"># mosaic + MixUp</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>        <span class="k">if</span> <span class="n">mosaic</span><span class="p">:</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>            <span class="c1"># Load mosaic</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>            <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_mosaic</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>            <span class="n">shapes</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>            <span class="c1"># MixUp augmentation</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;mixup&quot;</span><span class="p">]:</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>                <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">mixup</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">load_mosaic</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>            <span class="c1"># Load image</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>            <span class="c1"># è½½å…¥å›¾ç‰‡  è½½å…¥å›¾ç‰‡åè¿˜ä¼šè¿›è¡Œä¸€æ¬¡resize  å°†å½“å‰å›¾ç‰‡çš„æœ€é•¿è¾¹ç¼©æ”¾åˆ°æŒ‡å®šçš„å¤§å°(512), è¾ƒå°è¾¹åŒæ¯”ä¾‹ç¼©æ”¾</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>            <span class="c1"># load image img=(343, 512, 3)=(h, w, c)  (h0, w0)=(335, 500)  numpy  index=4</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>            <span class="c1"># img: resizeåçš„å›¾ç‰‡   (h0, w0): åŸå§‹å›¾ç‰‡çš„hw  (h, w): resizeåçš„å›¾ç‰‡çš„hw</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>            <span class="c1"># è¿™ä¸€æ­¥æ˜¯å°†(335, 500, 3) resize-&gt; (343, 512, 3)</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>            <span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">),</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>            <span class="c1"># Letterbox</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>            <span class="c1"># letterboxä¹‹å‰ç¡®å®šè¿™å¼ å½“å‰å›¾ç‰‡letterboxä¹‹åçš„shape  </span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>            <span class="c1"># å¦‚æœä¸ç”¨self.rectçŸ©å½¢è®­ç»ƒshapeå°±æ˜¯self.img_size</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>            <span class="c1"># å¦‚æœä½¿ç”¨self.rectçŸ©å½¢è®­ç»ƒshapeå°±æ˜¯å½“å‰batchçš„shape</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>            <span class="c1"># å› ä¸ºçŸ©å½¢è®­ç»ƒçš„è¯æˆ‘ä»¬æ•´ä¸ªbatchçš„shapeå¿…é¡»ç»Ÿä¸€(åœ¨__init__å‡½æ•°ç¬¬6èŠ‚å†…å®¹)</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_shapes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span>  <span class="c1"># final letterboxed shape</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>            <span class="n">img</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">pad</span> <span class="o">=</span> <span class="n">letterbox</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scaleup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment</span><span class="p">)</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>            <span class="n">shapes</span> <span class="o">=</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">),</span> <span class="p">((</span><span class="n">h</span> <span class="o">/</span> <span class="n">h0</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w0</span><span class="p">),</span> <span class="n">pad</span><span class="p">)</span>  <span class="c1"># for COCO mAP rescaling</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>            <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>  <span class="c1"># normalized xywh to pixel xyxy format</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>                <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">xywhn2xyxy</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">padw</span><span class="o">=</span><span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">padh</span><span class="o">=</span><span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment</span><span class="p">:</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>                <span class="c1"># random_perspectiveå¢å¼º: éšæœºå¯¹å›¾ç‰‡è¿›è¡Œæ—‹è½¬ï¼Œå¹³ç§»ï¼Œç¼©æ”¾ï¼Œè£å‰ªï¼Œé€è§†å˜æ¢</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>                <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">random_perspective</span><span class="p">(</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>                    <span class="n">img</span><span class="p">,</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>                    <span class="n">labels</span><span class="p">,</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>                    <span class="n">degrees</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;degrees&quot;</span><span class="p">],</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>                    <span class="n">translate</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;translate&quot;</span><span class="p">],</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>                    <span class="n">scale</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>                    <span class="n">shear</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;shear&quot;</span><span class="p">],</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>                    <span class="n">perspective</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;perspective&quot;</span><span class="p">],</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>                <span class="p">)</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>        <span class="n">nl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>  <span class="c1"># number of labels</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>        <span class="k">if</span> <span class="n">nl</span><span class="p">:</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyxy2xywhn</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment</span><span class="p">:</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>            <span class="c1"># Albumentations</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>            <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">albumentations</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>            <span class="n">nl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>  <span class="c1"># update after albumentations</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>            <span class="c1"># HSV color-space è‰²åŸŸç©ºé—´å¢å¼ºAugment colorspace</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>            <span class="n">augment_hsv</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">hgain</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;hsv_h&quot;</span><span class="p">],</span> <span class="n">sgain</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;hsv_s&quot;</span><span class="p">],</span> <span class="n">vgain</span><span class="o">=</span><span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;hsv_v&quot;</span><span class="p">])</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>            <span class="c1"># Flip up-down</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;flipud&quot;</span><span class="p">]:</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>                <span class="k">if</span> <span class="n">nl</span><span class="p">:</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>                    <span class="n">labels</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>            <span class="c1"># Flip left-right éšæœºå·¦å³ç¿»è½¬ </span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">hyp</span><span class="p">[</span><span class="s2">&quot;fliplr&quot;</span><span class="p">]:</span>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>                <span class="k">if</span> <span class="n">nl</span><span class="p">:</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>                    <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>            <span class="c1"># Cutouts</span>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>            <span class="c1"># labels = cutout(img, labels, p=0.5)</span>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>            <span class="c1"># nl = len(labels)  # update after cutout</span>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>        <span class="c1"># 6ä¸ªå€¼çš„tensor åˆå§‹åŒ–æ ‡ç­¾æ¡†å¯¹åº”çš„å›¾ç‰‡åºå·, é…åˆä¸‹é¢çš„collate_fnä½¿ç”¨</span>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>        <span class="n">labels_out</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nl</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>        <span class="k">if</span> <span class="n">nl</span><span class="p">:</span>
<a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a>            <span class="n">labels_out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a>
<a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>        <span class="c1"># Convert</span>
<a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># HWC to CHW, BGR to RGB</span>
<a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="c1"># imgå˜æˆå†…å­˜è¿ç»­çš„æ•°æ®  åŠ å¿«è¿ç®—                                                                                     </span>
<a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>
<a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>        <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">labels_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_files</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">shapes</span>
</code></pre></div>
<h3 id="44-collate_fn">4.4 collate_fn</h3>
<p>&emsp;collate_fn ä¸€èˆ¬ä¹Ÿå¯ä»¥å«è°ƒæ•´å‡½æ•°,å¾ˆå¤šäººä»¥ä¸ºå†™å®Œ <strong>init</strong> å’Œ <strong>getitem</strong> å‡½æ•°æ•°æ®å¢å¼ºå°±åšå®Œäº†ï¼Œæˆ‘ä»¬åœ¨åˆ†ç±»ä»»åŠ¡ä¸­çš„ç¡®å†™å®Œè¿™ä¸¤ä¸ªå‡½æ•°å°±å¯ä»¥äº†ï¼Œå› ä¸ºç³»ç»Ÿä¸­æ˜¯ç»™æˆ‘ä»¬å†™å¥½äº†ä¸€ä¸ªcollate_fnå‡½æ•°çš„ï¼Œä½†æ˜¯åœ¨ç›®æ ‡æ£€æµ‹ä¸­æˆ‘ä»¬å´éœ€è¦é‡å†™collate_fnå‡½æ•°ï¼Œä¸‹é¢æˆ‘ä¼šä»”ç»†çš„è®²è§£è¿™æ ·åšçš„åŸå› ï¼ˆä»£ç ä¸­æ³¨é‡Šï¼‰ã€‚</p>
<p>åŒæ ·åœ¨create_dataloaderä¸­ç”Ÿæˆdataloaderæ—¶è°ƒç”¨ï¼š
<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/640ac163ee26a8b13bb2e94f348fb3752a250886/utils/dataloaders.py#L183-L195
"  target="blank"> 
<img alt="image" src="https://user-images.githubusercontent.com/109639975/199916498-ee01bd46-9bdc-4cf8-90ce-958f483ce257.png" />
</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="k">def</span> <span class="nf">collate_fn4</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>        <span class="sd">&quot;&quot;&quot;åŒæ ·åœ¨create_dataloaderä¸­ç”Ÿæˆdataloaderæ—¶è°ƒç”¨ï¼š</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="sd">        è¿™é‡Œæ˜¯yolo-v5ä½œè€…å®éªŒæ€§çš„ä¸€ä¸ªä»£ç  quad-collate function å½“train.pyçš„optå‚æ•°quad=True åˆ™è°ƒç”¨collate_fn4ä»£æ›¿collate_fn</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="sd">        ä½œç”¨:  å¦‚ä¹‹å‰ç”¨collate_fnå¯ä»¥è¿”å›å›¾ç‰‡[16, 3, 640, 640] ç»è¿‡collate_fn4åˆ™è¿”å›å›¾ç‰‡[4, 3, 1280, 1280]</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="sd">              å°†4å¼ mosaicå›¾ç‰‡[1, 3, 640, 640]åˆæˆä¸€å¼ å¤§çš„mosaicå›¾ç‰‡[1, 3, 1280, 1280]</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="sd">              å°†ä¸€ä¸ªbatchçš„å›¾ç‰‡æ¯å››å¼ å¤„ç†, 0.5çš„æ¦‚ç‡å°†å››å¼ å›¾ç‰‡æ‹¼æ¥åˆ°ä¸€å¼ å¤§å›¾ä¸Šè®­ç»ƒ, 0.5æ¦‚ç‡ç›´æ¥å°†æŸå¼ å›¾ç‰‡ä¸Šé‡‡æ ·ä¸¤å€è®­ç»ƒ</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        <span class="c1"># img: æ•´ä¸ªbatchçš„å›¾ç‰‡ [16, 3, 640, 640]</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        <span class="c1"># label: æ•´ä¸ªbatchçš„labelæ ‡ç­¾ [num_target, img_index+class_index+xywh(normalized)]</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>        <span class="c1"># path: æ•´ä¸ªbatchæ‰€æœ‰å›¾ç‰‡çš„è·¯å¾„</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="c1"># shapes: (h0, w0), ((h / h0, w / w0), pad)    for COCO mAP rescaling</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>  <span class="c1"># transposed</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span> <span class="c1"># collate_fn4å¤„ç†åè¿™ä¸ªbatchä¸­å›¾ç‰‡çš„ä¸ªæ•°</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="n">im4</span><span class="p">,</span> <span class="n">label4</span><span class="p">,</span> <span class="n">path4</span><span class="p">,</span> <span class="n">shapes4</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">path</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">shapes</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="c1"># åˆå§‹åŒ–</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="n">ho</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="n">wo</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]])</span>  <span class="c1"># scale</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>  <span class="c1"># zidane flow.zeros(16,3,720,1280)  # BCHW</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="n">i</span> <span class="o">*=</span> <span class="mi">4</span> <span class="c1"># é‡‡æ · [0, 4, 8, 16]</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span> <span class="c1"># éšæœºæ•°å°äº0.5å°±ç›´æ¥å°†æŸå¼ å›¾ç‰‡ä¸Šé‡‡æ ·ä¸¤å€è®­ç»ƒ</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">,)[</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>                    <span class="mi">0</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>                <span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>                <span class="n">lb</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>                <span class="c1"># éšæœºæ•°å¤§äº0.5å°±å°†å››å¼ å›¾ç‰‡(mosaicåçš„)æ‹¼æ¥åˆ°ä¸€å¼ å¤§å›¾ä¸Šè®­ç»ƒ</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>                    <span class="p">(</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>                        <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>                        <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]),</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>                    <span class="p">),</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>                    <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>                <span class="p">)</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>                <span class="n">lb</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">label</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ho</span><span class="p">,</span> <span class="n">label</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">wo</span><span class="p">,</span> <span class="n">label</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">ho</span> <span class="o">+</span> <span class="n">wo</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>            <span class="n">im4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>            <span class="n">label4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="c1"># åé¢è¿”å›çš„éƒ¨åˆ†å’Œcollate_fnå°±å·®ä¸å¤šäº† åŸå› å’Œè§£é‡Šéƒ½å†™åœ¨ä¸Šä¸€ä¸ªå‡½æ•°äº† è‡ªå·±debugçœ‹ä¸€ä¸‹å§</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label4</span><span class="p">):</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>            <span class="n">lb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># add target image index for build_targets()</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>        <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">im4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">label4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">path4</span><span class="p">,</span> <span class="n">shapes4</span>
</code></pre></div>
<h2 id="5-img2label_paths">5. img2label_paths</h2>
<p>&emsp;è¿™ä¸ªæ–‡ä»¶æ˜¯æ ¹æ®æ•°æ®é›†ä¸­æ‰€æœ‰å›¾ç‰‡çš„è·¯å¾„æ‰¾åˆ°æ•°æ®é›†ä¸­æ‰€æœ‰labelså¯¹åº”çš„è·¯å¾„ã€‚</p>
<p>ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__init__å‡½æ•°ä¸­ã€‚</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">def</span> <span class="nf">img2label_paths</span><span class="p">(</span><span class="n">img_paths</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__init__å‡½æ•°ä¸­</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="sd">    æ ¹æ®imgså›¾ç‰‡çš„è·¯å¾„æ‰¾åˆ°å¯¹åº”labelsçš„è·¯å¾„</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="sd">    Define label paths as a function of image paths</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="sd">    :params img_paths: {list: 50}  æ•´ä¸ªæ•°æ®é›†çš„å›¾ç‰‡ç›¸å¯¹è·¯å¾„  ä¾‹å¦‚: &#39;..\\datasets\\VOC\\images\\train2007\\000012.jpg&#39;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="sd">                                                        =&gt;   &#39;..\\datasets\\VOC\\labels\\train2007\\000012.jpg&#39;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="c1"># å› ä¸ºpythonæ˜¯è·¨å¹³å°çš„,åœ¨Windowsä¸Š,æ–‡ä»¶çš„è·¯å¾„åˆ†éš”ç¬¦æ˜¯&#39;\&#39;,åœ¨Linuxä¸Šæ˜¯&#39;/&#39;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="c1"># ä¸ºäº†è®©ä»£ç åœ¨ä¸åŒçš„å¹³å°ä¸Šéƒ½èƒ½è¿è¡Œï¼Œé‚£ä¹ˆè·¯å¾„åº”è¯¥å†™&#39;\&#39;è¿˜æ˜¯&#39;/&#39;å‘¢ï¼Ÿ os.sepæ ¹æ®ä½ æ‰€å¤„çš„å¹³å°, è‡ªåŠ¨é‡‡ç”¨ç›¸åº”çš„åˆ†éš”ç¬¦å·</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="c1"># sa: &#39;\\images\\&#39;    sb: &#39;\\labels\\&#39;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;images&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;labels&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>  <span class="c1"># /images/, /labels/ substrings</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="c1"># æŠŠimg_pathsä¸­æ‰€ä»¥å›¾ç‰‡è·¯å¾„ä¸­çš„imagesæ›¿æ¢ä¸ºlabels</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">sb</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="p">]</span>
</code></pre></div>
<h2 id="6-verify_image_label">6. verify_image_label</h2>
<p>&emsp;è¿™ä¸ªå‡½æ•°ç”¨äºæ£€æŸ¥æ¯ä¸€å¼ å›¾ç‰‡å’Œæ¯ä¸€å¼ labelæ–‡ä»¶æ˜¯å¦å®Œå¥½ã€‚</p>
<p>&emsp; å›¾ç‰‡æ–‡ä»¶: æ£€æŸ¥å†…å®¹ã€æ ¼å¼ã€å¤§å°ã€å®Œæ•´æ€§</p>
<p>&emsp; labelæ–‡ä»¶: æ£€æŸ¥æ¯ä¸ªgtå¿…é¡»æ˜¯çŸ©å½¢(æ¯è¡Œéƒ½å¾—æ˜¯5ä¸ªæ•° class+xywh) + æ ‡ç­¾æ˜¯å¦å…¨éƒ¨&gt;=0 + æ ‡ç­¾åæ ‡xywhæ˜¯å¦å½’ä¸€åŒ– + æ ‡ç­¾ä¸­æ˜¯å¦æœ‰é‡å¤çš„åæ ‡</p>
<p>verify_image_labelå‡½æ•°ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span> <span class="nf">verify_image_label</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åœ¨cache_labelså‡½æ•°ä¸­</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="sd">    æ£€æµ‹æ•°æ®é›†ä¸­æ¯å¼ å›¾ç‰‡å’Œæ¯å¼ laeblæ˜¯å¦å®Œå¥½</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="sd">    å›¾ç‰‡æ–‡ä»¶: å†…å®¹ã€æ ¼å¼ã€å¤§å°ã€å®Œæ•´æ€§</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="sd">    labelæ–‡ä»¶: æ¯ä¸ªgtå¿…é¡»æ˜¯çŸ©å½¢(æ¯è¡Œéƒ½å¾—æ˜¯5ä¸ªæ•° class+xywh) + æ ‡ç­¾æ˜¯å¦å…¨éƒ¨&gt;=0 + æ ‡ç­¾åæ ‡xywhæ˜¯å¦å½’ä¸€åŒ– + æ ‡ç­¾ä¸­æ˜¯å¦æœ‰é‡å¤çš„åæ ‡</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="sd">    :params im_file: æ•°æ®é›†ä¸­ä¸€å¼ å›¾ç‰‡çš„pathç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="sd">    :params lb_file: æ•°æ®é›†ä¸­ä¸€å¼ å›¾ç‰‡çš„labelç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="sd">    :params prefix: æ—¥å¿—å¤´éƒ¨ä¿¡æ¯(å½©æ‰“é«˜äº®éƒ¨åˆ†)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="sd">    :return im_file: å½“å‰è¿™å¼ å›¾ç‰‡çš„pathç›¸å¯¹è·¯å¾„</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="sd">    :return l: [gt_num, cls+xywh(normalized)]</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="sd">               å¦‚æœè¿™å¼ å›¾ç‰‡æ²¡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾ lå°±å­˜å‚¨åŸlabel(å…¨éƒ¨æ˜¯æ­£å¸¸çŸ©å½¢æ ‡ç­¾)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="sd">               å¦‚æœè¿™å¼ å›¾ç‰‡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾  lå°±å­˜å‚¨ç»è¿‡segments2boxeså¤„ç†å¥½çš„æ ‡ç­¾(æ­£å¸¸çŸ©å½¢æ ‡ç­¾ä¸å¤„ç† å¤šè¾¹å½¢æ ‡ç­¾è½¬åŒ–ä¸ºçŸ©å½¢æ ‡ç­¾)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="sd">    :return shape: å½“å‰è¿™å¼ å›¾ç‰‡çš„å½¢çŠ¶ shape</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="sd">    :return segments: å¦‚æœè¿™å¼ å›¾ç‰‡æ²¡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾ å­˜å‚¨None</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="sd">                      å¦‚æœè¿™å¼ å›¾ç‰‡æœ‰ä¸€ä¸ªsegmentå¤šè¾¹å½¢æ ‡ç­¾ å°±æŠŠè¿™å¼ å›¾ç‰‡çš„æ‰€æœ‰labelå­˜å‚¨åˆ°segmentsä¸­(è‹¥å¹²ä¸ªæ­£å¸¸gt è‹¥å¹²ä¸ªå¤šè¾¹å½¢æ ‡ç­¾) [gt_num, xy1...]</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="sd">    :return nm: number missing å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ˜¯å¦ä¸¢å¤±         ä¸¢å¤±=1    å­˜åœ¨=0</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="sd">    :return nf: number found å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ˜¯å¦å­˜åœ¨           å­˜åœ¨=1    ä¸¢å¤±=0</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="sd">    :return ne: number empty å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ˜¯å¦æ˜¯ç©ºçš„         ç©ºçš„=1    æ²¡ç©º=0</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="sd">    :return nc: number corrupt å½“å‰è¿™å¼ å›¾ç‰‡çš„labelæ–‡ä»¶æ˜¯å¦æ˜¯ç ´æŸçš„  ç ´æŸçš„=1  æ²¡ç ´æŸ=0</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="sd">    :return msg: è¿”å›çš„msgä¿¡æ¯  labelæ–‡ä»¶å®Œå¥½=â€˜â€™  labelæ–‡ä»¶ç ´æŸ=warningä¿¡æ¯</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>    <span class="c1"># Verify one image-label pair</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="n">im_file</span><span class="p">,</span> <span class="n">lb_file</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">args</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="n">nm</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">segments</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>        <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>        <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>        <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>        <span class="p">[],</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>    <span class="p">)</span>  <span class="c1"># number (missing, found, empty, corrupt), message, segments</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>        <span class="c1"># verify images   æ£€æŸ¥è¿™å¼ å›¾ç‰‡(å†…å®¹ã€æ ¼å¼ã€å¤§å°ã€å®Œæ•´æ€§) verify images</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">im_file</span><span class="p">)</span> <span class="c1"># æ‰“å¼€å›¾ç‰‡æ–‡ä»¶</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>        <span class="n">im</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>  <span class="c1"># PIL verify  æ£€æŸ¥å›¾ç‰‡å†…å®¹å’Œæ ¼å¼æ˜¯å¦æ­£å¸¸</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">exif_size</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  <span class="c1"># image size å½“å‰å›¾ç‰‡çš„å¤§å° image size</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>        <span class="c1"># å›¾ç‰‡å¤§å°å¿…é¡»å¤§äº9ä¸ªpixels</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>        <span class="k">assert</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;image size </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2"> &lt;10 pixels&quot;</span> 
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>        <span class="c1"># å›¾ç‰‡æ ¼å¼å¿…é¡»åœ¨img_formatä¸­</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>        <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">IMG_FORMATS</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;invalid image format </span><span class="si">{</span><span class="n">im</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">):</span> <span class="c1"># æ£€æŸ¥jpgæ ¼å¼æ–‡ä»¶</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">im_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>                <span class="c1"># f.seek: -2 åç§»é‡ å‘æ–‡ä»¶å¤´æ–¹å‘ä¸­ç§»åŠ¨çš„å­—èŠ‚æ•°   2 ç›¸å¯¹ä½ç½® ä»æ–‡ä»¶å°¾å¼€å§‹åç§»</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> 
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>                <span class="c1"># f.read(): è¯»å–å›¾ç‰‡æ–‡ä»¶  æŒ‡ä»¤: \xff\xd9  æ£€æµ‹æ•´å¼ å›¾ç‰‡æ˜¯å¦å®Œæ•´  å¦‚æœä¸å®Œæ•´å°±è¿”å›corrupted JPEG</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xff\xd9</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># corrupt JPEG</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>                    <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">im_file</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">im_file</span><span class="p">,</span> <span class="s2">&quot;JPEG&quot;</span><span class="p">,</span> <span class="n">subsampling</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">WARNING: </span><span class="si">{</span><span class="n">im_file</span><span class="si">}</span><span class="s2">: corrupt JPEG restored and saved&quot;</span>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>        <span class="c1"># verify labels</span>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">lb_file</span><span class="p">):</span>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>            <span class="n">nf</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># label found</span>
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lb_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>                <span class="c1"># è¯»å–å½“å‰labelæ–‡ä»¶çš„æ¯ä¸€è¡Œ: æ¯ä¸€è¡Œéƒ½æ˜¯å½“å‰å›¾ç‰‡çš„ä¸€ä¸ªgt</span>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>                <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>                <span class="c1"># any() å‡½æ•°ç”¨äºåˆ¤æ–­ç»™å®šçš„å¯è¿­ä»£å‚æ•° æ˜¯å¦å…¨éƒ¨ä¸ºFalse,åˆ™è¿”å› False; å¦‚æœæœ‰ä¸€ä¸ªä¸º True,åˆ™è¿”å›True</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>                <span class="c1"># å¦‚æœå½“å‰å›¾ç‰‡çš„labelæ–‡ä»¶æŸä¸€åˆ—æ•°å¤§äº8, åˆ™è®¤ä¸ºlabelæ˜¯å­˜åœ¨segmentçš„polygonç‚¹(å¤šè¾¹å½¢) </span>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>                <span class="c1"># å°±ä¸æ˜¯çŸ©é˜µ åˆ™å°†labelä¿¡æ¯å­˜å…¥segmentä¸­</span>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lb</span><span class="p">):</span>  <span class="c1"># is segment</span>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>                    <span class="c1"># å½“å‰å›¾ç‰‡ä¸­æ‰€æœ‰gtæ¡†çš„ç±»åˆ«</span>
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>                    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lb</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>                    <span class="c1"># è·å¾—è¿™å¼ å›¾ä¸­æ‰€æœ‰gtæ¡†çš„labelä¿¡æ¯(åŒ…å«segmentå¤šè¾¹å½¢æ ‡ç­¾)</span>
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>                    <span class="c1"># å› ä¸ºsegmentæ ‡ç­¾å¯ä»¥æ˜¯ä¸åŒé•¿åº¦ï¼Œæ‰€ä»¥è¿™é‡Œsegmentsæ˜¯ä¸€ä¸ªåˆ—è¡¨ [gt_num, xy1...(normalized)]</span>
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>                    <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lb</span><span class="p">]</span>  <span class="c1"># (cls, xy1...)</span>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>                    <span class="c1"># è·å¾—è¿™å¼ å›¾ä¸­æ‰€æœ‰gtæ¡†çš„labelä¿¡æ¯(ä¸åŒ…å«segmentå¤šè¾¹å½¢æ ‡ç­¾)</span>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>                    <span class="c1"># segments(å¤šè¾¹å½¢) -&gt; bbox(æ­£æ–¹å½¢), å¾—åˆ°æ–°æ ‡ç­¾  [gt_num, cls+xywh(normalized)]</span>
<a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>                    <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">classes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">segments2boxes</span><span class="p">(</span><span class="n">segments</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (cls, xywh)</span>
<a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>                <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>            <span class="n">nl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
<a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>            <span class="k">if</span> <span class="n">nl</span><span class="p">:</span> 
<a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>                <span class="c1"># åˆ¤æ–­æ ‡ç­¾æ˜¯å¦æœ‰äº”åˆ—</span>
<a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>                <span class="k">assert</span> <span class="n">lb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;labels require 5 columns, </span><span class="si">{</span><span class="n">lb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> columns detected&quot;</span>
<a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>                <span class="c1"># åˆ¤æ–­æ ‡ç­¾æ˜¯å¦å…¨éƒ¨&gt;=0</span>
<a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>                <span class="k">assert</span> <span class="p">(</span><span class="n">lb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;negative label values </span><span class="si">{</span><span class="n">lb</span><span class="p">[</span><span class="n">lb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>                <span class="c1"># åˆ¤æ–­æ ‡ç­¾ä¸­æ˜¯å¦æœ‰é‡å¤çš„åæ ‡</span>
<a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>                <span class="k">assert</span> <span class="p">(</span><span class="n">lb</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;non-normalized or out of bounds coordinates </span><span class="si">{</span><span class="n">lb</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:][</span><span class="n">lb</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>                <span class="n">_</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="p">:</span>  <span class="c1"># duplicate row check</span>
<a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>                    <span class="n">lb</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># remove duplicates</span>
<a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>                    <span class="k">if</span> <span class="n">segments</span><span class="p">:</span>
<a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a>                        <span class="n">segments</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">WARNING: </span><span class="si">{</span><span class="n">im_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">nl</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate labels removed&quot;</span>
<a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>                <span class="n">ne</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># label empty  l.shape[0] == 0åˆ™ä¸ºç©ºçš„æ ‡ç­¾ï¼Œne=1</span>
<a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>                <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> 
<a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>            <span class="n">nm</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># label missing</span>
<a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>            <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>        <span class="k">return</span> <span class="n">im_file</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">msg</span>
<a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>        <span class="n">nc</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">WARNING: </span><span class="si">{</span><span class="n">im_file</span><span class="si">}</span><span class="s2">: ignoring corrupt image/label: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a>        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">msg</span><span class="p">]</span>
</code></pre></div>
<h2 id="7-load_image">7. load_image</h2>
<p>&emsp;è¿™ä¸ªå‡½æ•°æ˜¯æ ¹æ®å›¾ç‰‡indexï¼Œä»selfæˆ–è€…ä»å¯¹åº”å›¾ç‰‡è·¯å¾„ä¸­è½½å…¥å¯¹åº”indexçš„å›¾ç‰‡</p>
<p>å¹¶å°†åŸå›¾ä¸­hwä¸­è¾ƒå¤§è€…æ‰©å±•åˆ°self.img_size, è¾ƒå°è€…åŒæ¯”ä¾‹æ‰©å±•ã€‚</p>
<p>ä¼šè¢«ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__getitem__å‡½æ•°å’Œload_mosaicæ¨¡å—ä¸­è½½å…¥å¯¹åº”indexçš„å›¾ç‰‡ï¼š</p>
<p>load_imageå‡½æ•°ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>         <span class="sd">&quot;&quot;&quot;ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__getitem__å‡½æ•°å’Œload_mosaicæ¨¡å—ä¸­</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="sd">        ä»selfæˆ–è€…ä»å¯¹åº”å›¾ç‰‡è·¯å¾„ä¸­è½½å…¥å¯¹åº”indexçš„å›¾ç‰‡ å¹¶å°†åŸå›¾ä¸­hwä¸­è¾ƒå¤§è€…æ‰©å±•åˆ°self.img_size, è¾ƒå°è€…åŒæ¯”ä¾‹æ‰©å±•</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="sd">        loads 1 image from dataset, returns img, original hw, resized hw</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="sd">        :params self: ä¸€èˆ¬æ˜¯å¯¼å…¥LoadImagesAndLabelsä¸­çš„self</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="sd">        :param index: å½“å‰å›¾ç‰‡çš„index</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="sd">        :return: img: resizeåçš„å›¾ç‰‡</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="sd">                (h0, w0): hw_original  åŸå›¾çš„hw</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="sd">                img.shape[:2]: hw_resized resizeåçš„å›¾ç‰‡hw(hwä¸­è¾ƒå¤§è€…æ‰©å±•åˆ°self.img_size, è¾ƒå°è€…åŒæ¯”ä¾‹æ‰©å±•)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        <span class="n">im</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ims</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">im_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">npy_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        <span class="p">)</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="k">if</span> <span class="n">im</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># not cached in RAM</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>            <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># load npy</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># read image</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># BGR</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>                <span class="k">assert</span> <span class="n">im</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image Not Found </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>            <span class="n">h0</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># orig hw</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span>  <span class="c1"># ratio</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if sizes are not equal</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>            <span class="c1"># cv2.INTER_AREA: åŸºäºåŒºåŸŸåƒç´ å…³ç³»çš„ä¸€ç§é‡é‡‡æ ·æˆ–è€…æ’å€¼æ–¹å¼.è¯¥æ–¹æ³•æ˜¯å›¾åƒæŠ½å–çš„é¦–é€‰æ–¹æ³•, å®ƒå¯ä»¥äº§ç”Ÿæ›´å°‘çš„æ³¢çº¹</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>            <span class="c1"># cv2.INTER_LINEAR: åŒçº¿æ€§æ’å€¼,é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨è¯¥æ–¹å¼è¿›è¡Œæ’å€¼   æ ¹æ®ratioé€‰æ‹©ä¸åŒçš„æ’å€¼æ–¹å¼</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>            <span class="c1"># å°†åŸå›¾ä¸­hwä¸­è¾ƒå¤§è€…æ‰©å±•åˆ°self.img_size, è¾ƒå°è€…åŒæ¯”ä¾‹æ‰©å±•</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>                <span class="n">interp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">augment</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w0</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h0</span> <span class="o">*</span> <span class="n">r</span><span class="p">)),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>            <span class="k">return</span> <span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">w0</span><span class="p">),</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># im, hw_original, hw_resized</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ims</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_hw0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># im, hw_original, hw_resized</span>
</code></pre></div>
<h2 id="8-augment_hsv">8. augment_hsv</h2>
<p>&emsp;è¿™ä¸ªå‡½æ•°æ˜¯å…³äºå›¾ç‰‡çš„è‰²åŸŸå¢å¼ºæ¨¡å—ï¼Œå›¾ç‰‡å¹¶ä¸å‘ç”Ÿç§»åŠ¨ï¼Œæ‰€æœ‰ä¸éœ€è¦æ”¹å˜labelï¼Œåªéœ€è¦ img å¢å¼ºå³å¯ã€‚</p>
<p>augment_hsvæ¨¡å—ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">def</span> <span class="nf">augment_hsv</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">hgain</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sgain</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vgain</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__getitem__å‡½æ•°</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="sd">    hsvè‰²åŸŸå¢å¼º  å¤„ç†å›¾åƒhsvï¼Œä¸å¯¹labelè¿›è¡Œä»»ä½•å¤„ç†</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="sd">    :param img: å¾…å¤„ç†å›¾ç‰‡  BGR [736, 736]</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="sd">    :param hgain: hé€šé“è‰²åŸŸå‚æ•° ç”¨äºç”Ÿæˆæ–°çš„hé€šé“</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="sd">    :param sgain: hé€šé“è‰²åŸŸå‚æ•° ç”¨äºç”Ÿæˆæ–°çš„sé€šé“</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="sd">    :param vgain: hé€šé“è‰²åŸŸå‚æ•° ç”¨äºç”Ÿæˆæ–°çš„vé€šé“</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="sd">    :return: è¿”å›hsvå¢å¼ºåçš„å›¾ç‰‡ img</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="k">if</span> <span class="n">hgain</span> <span class="ow">or</span> <span class="n">sgain</span> <span class="ow">or</span> <span class="n">vgain</span><span class="p">:</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>        <span class="c1"># éšæœºå–-1åˆ°1ä¸‰ä¸ªå®æ•°ï¼Œä¹˜ä»¥hypä¸­çš„hsvä¸‰é€šé“çš„ç³»æ•°  ç”¨äºç”Ÿæˆæ–°çš„hsvé€šé“</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">hgain</span><span class="p">,</span> <span class="n">sgain</span><span class="p">,</span> <span class="n">vgain</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># random gains</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="n">hue</span><span class="p">,</span> <span class="n">sat</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">))</span>  <span class="c1"># å›¾åƒçš„é€šé“æ‹†åˆ† h s v</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span>  <span class="c1"># uint8</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>        <span class="n">lut_hue</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="mi">180</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>         <span class="c1"># ç”Ÿæˆæ–°çš„hé€šé“</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>        <span class="n">lut_sat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># ç”Ÿæˆæ–°çš„sé€šé“</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>        <span class="n">lut_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># ç”Ÿæˆæ–°çš„vé€šé“</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>        <span class="c1"># å›¾åƒçš„é€šé“åˆå¹¶ img_hsv=h+s+v  éšæœºè°ƒæ•´hsvä¹‹åé‡æ–°ç»„åˆhsvé€šé“</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>        <span class="c1"># cv2.LUT(hue, lut_hue)   é€šé“è‰²åŸŸå˜æ¢ è¾“å…¥å˜æ¢å‰é€šé“hue å’Œå˜æ¢åé€šé“lut_hue</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>        <span class="n">img_hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">((</span><span class="n">cv2</span><span class="o">.</span><span class="n">LUT</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">lut_hue</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LUT</span><span class="p">(</span><span class="n">sat</span><span class="p">,</span> <span class="n">lut_sat</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LUT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">lut_val</span><span class="p">)))</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>        <span class="c1"># no return needed  dst:è¾“å‡ºå›¾åƒ</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2BGR</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># no return needed  hsv-&gt;bgr</span>
</code></pre></div>
<p>è¿˜è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªhsvå¢å¼ºæ˜¯éšæœºç”Ÿæˆå„ä¸ªè‰²åŸŸå‚æ•°çš„ï¼Œæ‰€ä»¥æ¯æ¬¡å¢å¼ºçš„æ•ˆæœéƒ½æ˜¯ä¸åŒçš„ï¼š</p>
<p>è¿™ä¸ªå‡½æ•°ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__getitem__å‡½æ•°ä¸­ï¼š
<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/640ac163ee26a8b13bb2e94f348fb3752a250886/utils/dataloaders.py#L707" target="blank"></p>
<p><img alt="image" src="https://user-images.githubusercontent.com/109639975/199916719-8917e8eb-e3c8-4be8-9d5b-f9174a77195f.png" /></p>
<p></a></p>
<p>å¦å¤–ï¼Œè¿™é‡Œæ¶‰åŠåˆ°çš„ä¸‰ä¸ªå˜é‡æ¥è‡ªhyp.yamlè¶…å‚æ–‡ä»¶ï¼š
<img alt="image" src="https://user-images.githubusercontent.com/109639975/199916836-d2277200-0763-47f7-8b4e-65cd7d62ca3b.png" /></p>
<h2 id="9-load_mosaicload_mosaic9">9. load_mosaicã€load_mosaic9</h2>
<p>&emsp;è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯mosaicæ•°æ®å¢å¼ºï¼Œåªä¸è¿‡load_mosaicå‡½æ•°æ˜¯æ‹¼æ¥å››å¼ å›¾ï¼Œè€Œload_mosaic9å‡½æ•°æ˜¯æ‹¼æ¥ä¹å¼ å›¾ã€‚
æ›´å¤šè¯·å‚é˜…<a href="https://start.oneflow.org/oneflow-yolo-doc/tutorials/04_chapter/mosaic.html">ã€Šmosaic è§£è¯»ã€‹</a></p>
<h3 id="91-load_mosaic">9.1 load_mosaic</h3>
<p><img alt="image" src="https://user-images.githubusercontent.com/109639975/199916906-07ba8364-148b-4298-b7eb-bd0d52d98f0e.png" />
&emsp;è¿™ä¸ªæ¨¡å—å°±æ˜¯å¾ˆæœ‰åçš„mosaicå¢å¼ºæ¨¡å—ï¼Œå‡ ä¹è®­ç»ƒçš„æ—¶å€™éƒ½ä¼šç”¨å®ƒï¼Œå¯ä»¥æ˜¾è‘—çš„æé«˜å°æ ·æœ¬çš„mAPã€‚</p>
<p>ä»£ç æ˜¯æ•°æ®å¢å¼ºé‡Œé¢æœ€éš¾çš„, ä¹Ÿæ˜¯æœ€æœ‰ä»·å€¼çš„ï¼Œmosaicæ˜¯éå¸¸éå¸¸æœ‰ç”¨çš„æ•°æ®å¢å¼ºtrick, ä¸€å®šè¦ç†Ÿç»ƒæŒæ¡ã€‚</p>
<p>load_mosaicæ¨¡å—ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span> <span class="nf">load_mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__getitem__å‡½æ•° è¿›è¡Œmosaicæ•°æ®å¢å¼º</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="sd">    å°†å››å¼ å›¾ç‰‡æ‹¼æ¥åœ¨ä¸€å¼ é©¬èµ›å…‹å›¾åƒä¸­  loads images in a 4-mosaic</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="sd">    :param index: éœ€è¦è·å–çš„å›¾åƒç´¢å¼•</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="sd">    :return: img4: mosaicå’Œéšæœºé€è§†å˜æ¢åçš„ä¸€å¼ å›¾ç‰‡  numpy(640, 640, 3)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="sd">             labels4: img4å¯¹åº”çš„target  [M, cls+x1y1x2y2]</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="c1"># labels4: ç”¨äºå­˜æ”¾æ‹¼æ¥å›¾åƒï¼ˆ4å¼ å›¾æ‹¼æˆä¸€å¼ ï¼‰çš„labelä¿¡æ¯(ä¸åŒ…å«segmentså¤šè¾¹å½¢)</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="c1"># segments4: ç”¨äºå­˜æ”¾æ‹¼æ¥å›¾åƒï¼ˆ4å¼ å›¾æ‹¼æˆä¸€å¼ ï¼‰çš„labelä¿¡æ¯(åŒ…å«segmentså¤šè¾¹å½¢)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="n">labels4</span><span class="p">,</span> <span class="n">segments4</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span>  <span class="c1"># ä¸€èˆ¬çš„å›¾ç‰‡å¤§å°</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="c1"># éšæœºåˆå§‹åŒ–æ‹¼æ¥å›¾åƒçš„ä¸­å¿ƒç‚¹åæ ‡  [0, s*2]ä¹‹é—´éšæœºå–2ä¸ªæ•°ä½œä¸ºæ‹¼æ¥å›¾åƒçš„ä¸­å¿ƒåæ ‡</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mosaic_border</span><span class="p">]</span>  <span class="c1"># mosaic center x, y</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="c1"># ä»datasetä¸­éšæœºå¯»æ‰¾é¢å¤–çš„ä¸‰å¼ å›¾åƒè¿›è¡Œæ‹¼æ¥ [14, 26, 2, 16] å†éšæœºé€‰ä¸‰å¼ å›¾ç‰‡çš„index</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 3 additional image indices</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="c1"># éå†å››å¼ å›¾åƒè¿›è¡Œæ‹¼æ¥ 4å¼ ä¸åŒå¤§å°çš„å›¾åƒ =&gt; 1å¼ [1472, 1472, 3]çš„å›¾åƒ</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="c1"># load image   æ¯æ¬¡æ‹¿ä¸€å¼ å›¾ç‰‡ å¹¶å°†è¿™å¼ å›¾ç‰‡resizeåˆ°self.size(h,w)</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>        <span class="n">img</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="c1"># place img in img4</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># top left  åŸå›¾[375, 500, 3] load_image-&gt;[552, 736, 3]   hwc</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>            <span class="c1"># åˆ›å»ºé©¬èµ›å…‹å›¾åƒ [1472, 1472, 3]=[h, w, c]</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>            <span class="n">img4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">114</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># base image with 4 tiles</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>            <span class="c1"># è®¡ç®—é©¬èµ›å…‹å›¾åƒä¸­çš„åæ ‡ä¿¡æ¯(å°†å›¾åƒå¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­)   w=736  h = 552  é©¬èµ›å…‹å›¾åƒï¼š(x1a,y1a)å·¦ä¸Šè§’ (x2a,y2a)å³ä¸‹è§’</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span>  <span class="c1"># xmin, ymin, xmax, ymax (large image)</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>            <span class="c1"># è®¡ç®—æˆªå–çš„å›¾åƒåŒºåŸŸä¿¡æ¯(ä»¥xc,ycä¸ºç¬¬ä¸€å¼ å›¾åƒçš„å³ä¸‹è§’åæ ‡å¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­ï¼Œä¸¢å¼ƒè¶Šç•Œçš„åŒºåŸŸ)  å›¾åƒï¼š(x1b,y1b)å·¦ä¸Šè§’ (x2b,y2b)å³ä¸‹è§’</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="p">(</span><span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">),</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span>  <span class="c1"># xmin, ymin, xmax, ymax (small image)</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># top right</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>            <span class="c1"># è®¡ç®—é©¬èµ›å…‹å›¾åƒä¸­çš„åæ ‡ä¿¡æ¯(å°†å›¾åƒå¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­)</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="n">xc</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">yc</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>            <span class="c1"># è®¡ç®—æˆªå–çš„å›¾åƒåŒºåŸŸä¿¡æ¯(ä»¥xc,ycä¸ºç¬¬äºŒå¼ å›¾åƒçš„å·¦ä¸‹è§’åæ ‡å¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­ï¼Œä¸¢å¼ƒè¶Šç•Œçš„åŒºåŸŸ)</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="n">h</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># bottom left</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>            <span class="c1"># è®¡ç®—é©¬èµ›å…‹å›¾åƒä¸­çš„åæ ‡ä¿¡æ¯(å°†å›¾åƒå¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­)</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>            <span class="c1"># è®¡ç®—æˆªå–çš„å›¾åƒåŒºåŸŸä¿¡æ¯(ä»¥xc,ycä¸ºç¬¬ä¸‰å¼ å›¾åƒçš„å³ä¸Šè§’åæ ‡å¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­ï¼Œä¸¢å¼ƒè¶Šç•Œçš„åŒºåŸŸ)</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="p">(</span><span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># bottom right</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>            <span class="c1"># è®¡ç®—é©¬èµ›å…‹å›¾åƒä¸­çš„åæ ‡ä¿¡æ¯(å°†å›¾åƒå¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­)</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>            <span class="n">x1a</span><span class="p">,</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">x2a</span><span class="p">,</span> <span class="n">y2a</span> <span class="o">=</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">xc</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">yc</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>            <span class="c1"># è®¡ç®—æˆªå–çš„å›¾åƒåŒºåŸŸä¿¡æ¯(ä»¥xc,ycä¸ºç¬¬å››å¼ å›¾åƒçš„å·¦ä¸Šè§’åæ ‡å¡«å……åˆ°é©¬èµ›å…‹å›¾åƒä¸­ï¼Œä¸¢å¼ƒè¶Šç•Œçš„åŒºåŸŸ)</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>            <span class="n">x1b</span><span class="p">,</span> <span class="n">y1b</span><span class="p">,</span> <span class="n">x2b</span><span class="p">,</span> <span class="n">y2b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x2a</span> <span class="o">-</span> <span class="n">x1a</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y2a</span> <span class="o">-</span> <span class="n">y1a</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>        <span class="c1"># å°†æˆªå–çš„å›¾åƒåŒºåŸŸå¡«å……åˆ°é©¬èµ›å…‹å›¾åƒçš„ç›¸åº”ä½ç½®   img4[h, w, c]</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>        <span class="c1"># å°†å›¾åƒimgçš„ã€(x1b,y1b)å·¦ä¸Šè§’ (x2b,y2b)å³ä¸‹è§’ã€‘åŒºåŸŸæˆªå–å‡ºæ¥å¡«å……åˆ°é©¬èµ›å…‹å›¾åƒçš„ã€(x1a,y1a)å·¦ä¸Šè§’ (x2a,y2a)å³ä¸‹è§’ã€‘åŒºåŸŸ</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>        <span class="n">img4</span><span class="p">[</span><span class="n">y1a</span><span class="p">:</span><span class="n">y2a</span><span class="p">,</span> <span class="n">x1a</span><span class="p">:</span><span class="n">x2a</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y1b</span><span class="p">:</span><span class="n">y2b</span><span class="p">,</span> <span class="n">x1b</span><span class="p">:</span><span class="n">x2b</span><span class="p">]</span>  <span class="c1"># img4[ymin:ymax, xmin:xmax]</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>        <span class="c1"># è®¡ç®—pad(å½“å‰å›¾åƒè¾¹ç•Œä¸é©¬èµ›å…‹è¾¹ç•Œçš„è·ç¦»ï¼Œè¶Šç•Œçš„æƒ…å†µpadw/padhä¸ºè´Ÿå€¼)  ç”¨äºåé¢çš„labelæ˜ å°„</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>        <span class="n">padw</span> <span class="o">=</span> <span class="n">x1a</span> <span class="o">-</span> <span class="n">x1b</span>   <span class="c1"># å½“å‰å›¾åƒä¸é©¬èµ›å…‹å›¾åƒåœ¨wç»´åº¦ä¸Šç›¸å·®å¤šå°‘</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>        <span class="n">padh</span> <span class="o">=</span> <span class="n">y1a</span> <span class="o">-</span> <span class="n">y1b</span>   <span class="c1"># å½“å‰å›¾åƒä¸é©¬èµ›å…‹å›¾åƒåœ¨hç»´åº¦ä¸Šç›¸å·®å¤šå°‘</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>        <span class="c1"># labels: è·å–å¯¹åº”æ‹¼æ¥å›¾åƒçš„æ‰€æœ‰æ­£å¸¸labelä¿¡æ¯(å¦‚æœæœ‰segmentså¤šè¾¹å½¢ä¼šè¢«è½¬åŒ–ä¸ºçŸ©å½¢label)</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>        <span class="c1"># segments: è·å–å¯¹åº”æ‹¼æ¥å›¾åƒçš„æ‰€æœ‰ä¸æ­£å¸¸labelä¿¡æ¯(åŒ…å«segmentså¤šè¾¹å½¢ä¹ŸåŒ…å«æ­£å¸¸gt)</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>        <span class="n">labels</span><span class="p">,</span> <span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>        <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>            <span class="c1"># normalized xywh normalized to pixel xyxy format</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">xywhn2xyxy</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">padw</span><span class="p">,</span> <span class="n">padh</span><span class="p">)</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>            <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyn2xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">padw</span><span class="p">,</span> <span class="n">padh</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>        <span class="n">labels4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>      <span class="c1"># æ›´æ–°labels4</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>        <span class="n">segments4</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>  <span class="c1"># æ›´æ–°segments4</span>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>    <span class="c1"># Concat/clip labels4 æŠŠlabels4ï¼ˆ[(2, 5), (1, 5), (3, 5), (1, 5)] =&gt; (7, 5)ï¼‰å‹ç¼©åˆ°ä¸€èµ·</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>    <span class="n">labels4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>    <span class="c1"># é˜²æ­¢è¶Šç•Œ  label[:, 1:]ä¸­çš„æ‰€æœ‰å…ƒç´ çš„å€¼ï¼ˆä½ç½®ä¿¡æ¯ï¼‰å¿…é¡»åœ¨[0, 2*s]ä¹‹é—´,å°äº0å°±ä»¤å…¶ç­‰äº0,å¤§äº2*så°±ç­‰äº2*s   out: è¿”å›</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">labels4</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="o">*</span><span class="n">segments4</span><span class="p">):</span>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a>        <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># clip when using random_perspective()</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a>    <span class="c1"># æµ‹è¯•ä»£ç   æµ‹è¯•å‰é¢çš„mosaicæ•ˆæœ</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a>    <span class="c1"># cv2.imshow(&quot;mosaic&quot;, img4)</span>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a>    <span class="c1"># cv2.waitKey(0)</span>
<a id="__codelineno-12-71" name="__codelineno-12-71" href="#__codelineno-12-71"></a>    <span class="c1"># cv2.destroyAllWindows()</span>
<a id="__codelineno-12-72" name="__codelineno-12-72" href="#__codelineno-12-72"></a>    <span class="c1"># print(img4.shape)   # (1280, 1280, 3)</span>
<a id="__codelineno-12-73" name="__codelineno-12-73" href="#__codelineno-12-73"></a>
<a id="__codelineno-12-74" name="__codelineno-12-74" href="#__codelineno-12-74"></a>    <span class="c1"># éšæœºåç§»æ ‡ç­¾ä¸­å¿ƒï¼Œç”Ÿæˆæ–°çš„æ ‡ç­¾ä¸åŸæ ‡ç­¾ç»“åˆ replicate</span>
<a id="__codelineno-12-75" name="__codelineno-12-75" href="#__codelineno-12-75"></a>    <span class="c1"># img4, labels4 = replicate(img4, labels4)</span>
<a id="__codelineno-12-76" name="__codelineno-12-76" href="#__codelineno-12-76"></a>    <span class="c1">#</span>
<a id="__codelineno-12-77" name="__codelineno-12-77" href="#__codelineno-12-77"></a>    <span class="c1"># # æµ‹è¯•ä»£ç   æµ‹è¯•replicateæ•ˆæœ</span>
<a id="__codelineno-12-78" name="__codelineno-12-78" href="#__codelineno-12-78"></a>    <span class="c1"># cv2.imshow(&quot;replicate&quot;, img4)</span>
<a id="__codelineno-12-79" name="__codelineno-12-79" href="#__codelineno-12-79"></a>    <span class="c1"># cv2.waitKey(0)</span>
<a id="__codelineno-12-80" name="__codelineno-12-80" href="#__codelineno-12-80"></a>    <span class="c1"># cv2.destroyAllWindows()</span>
<a id="__codelineno-12-81" name="__codelineno-12-81" href="#__codelineno-12-81"></a>    <span class="c1"># print(img4.shape)   # (1280, 1280, 3)</span>
<a id="__codelineno-12-82" name="__codelineno-12-82" href="#__codelineno-12-82"></a>
<a id="__codelineno-12-83" name="__codelineno-12-83" href="#__codelineno-12-83"></a>    <span class="c1"># Augment</span>
<a id="__codelineno-12-84" name="__codelineno-12-84" href="#__codelineno-12-84"></a>    <span class="c1"># random_perspective Augment  éšæœºé€è§†å˜æ¢ [1280, 1280, 3] =&gt; [640, 640, 3]</span>
<a id="__codelineno-12-85" name="__codelineno-12-85" href="#__codelineno-12-85"></a>    <span class="c1"># å¯¹mosaicæ•´åˆåçš„å›¾ç‰‡è¿›è¡Œéšæœºæ—‹è½¬ã€å¹³ç§»ã€ç¼©æ”¾ã€è£å‰ªï¼Œé€è§†å˜æ¢ï¼Œå¹¶resizeä¸ºè¾“å…¥å¤§å°img_size</span>
<a id="__codelineno-12-86" name="__codelineno-12-86" href="#__codelineno-12-86"></a>    <span class="n">img4</span><span class="p">,</span> <span class="n">labels4</span> <span class="o">=</span> <span class="n">random_perspective</span><span class="p">(</span><span class="n">img4</span><span class="p">,</span> <span class="n">labels4</span><span class="p">,</span> <span class="n">segments4</span><span class="p">,</span>
<a id="__codelineno-12-87" name="__codelineno-12-87" href="#__codelineno-12-87"></a>                                       <span class="n">degrees</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;degrees&#39;</span><span class="p">],</span>
<a id="__codelineno-12-88" name="__codelineno-12-88" href="#__codelineno-12-88"></a>                                       <span class="n">translate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;translate&#39;</span><span class="p">],</span>
<a id="__codelineno-12-89" name="__codelineno-12-89" href="#__codelineno-12-89"></a>                                       <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">],</span>
<a id="__codelineno-12-90" name="__codelineno-12-90" href="#__codelineno-12-90"></a>                                       <span class="n">shear</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">],</span>
<a id="__codelineno-12-91" name="__codelineno-12-91" href="#__codelineno-12-91"></a>                                       <span class="n">perspective</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;perspective&#39;</span><span class="p">],</span>
<a id="__codelineno-12-92" name="__codelineno-12-92" href="#__codelineno-12-92"></a>                                       <span class="n">border</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mosaic_border</span><span class="p">)</span>  <span class="c1"># border to remove</span>
<a id="__codelineno-12-93" name="__codelineno-12-93" href="#__codelineno-12-93"></a>
<a id="__codelineno-12-94" name="__codelineno-12-94" href="#__codelineno-12-94"></a>    <span class="c1"># æµ‹è¯•ä»£ç  æµ‹è¯•mosaic + random_perspectiveéšæœºä»¿å°„å˜æ¢æ•ˆæœ</span>
<a id="__codelineno-12-95" name="__codelineno-12-95" href="#__codelineno-12-95"></a>    <span class="c1"># cv2.imshow(&quot;random_perspective&quot;, img4)</span>
<a id="__codelineno-12-96" name="__codelineno-12-96" href="#__codelineno-12-96"></a>    <span class="c1"># cv2.waitKey(0)</span>
<a id="__codelineno-12-97" name="__codelineno-12-97" href="#__codelineno-12-97"></a>    <span class="c1"># cv2.destroyAllWindows()</span>
<a id="__codelineno-12-98" name="__codelineno-12-98" href="#__codelineno-12-98"></a>    <span class="c1"># print(img4.shape)   # (640, 640, 3)</span>
<a id="__codelineno-12-99" name="__codelineno-12-99" href="#__codelineno-12-99"></a>
<a id="__codelineno-12-100" name="__codelineno-12-100" href="#__codelineno-12-100"></a>    <span class="k">return</span> <span class="n">img4</span><span class="p">,</span> <span class="n">labels4</span>
</code></pre></div>
<h3 id="92-load_mosaic9">9.2 load_mosaic9</h3>
<p>&emsp;è¿™ä¸ªæ¨¡å—æ˜¯ä½œè€…çš„å®éªŒæ¨¡å—ï¼Œå°†ä¹å¼ å›¾ç‰‡æ‹¼æ¥åœ¨ä¸€å¼ é©¬èµ›å…‹å›¾åƒä¸­ã€‚æ€»ä½“ä»£ç æµç¨‹å’Œload_mosaic4å‡ ä¹ä¸€æ ·ï¼Œçœ‹æ‡‚äº†load_mosaic4å†çœ‹è¿™ä¸ªå°±å¾ˆç®€å•äº†ã€</p>
<p>load_mosaic9æ¨¡å—ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">def</span> <span class="nf">load_mosaic9</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åœ¨LoadImagesAndLabelsæ¨¡å—çš„__getitem__å‡½æ•° æ›¿æ¢mosaicæ•°æ®å¢å¼º</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="sd">    å°†ä¹å¼ å›¾ç‰‡æ‹¼æ¥åœ¨ä¸€å¼ é©¬èµ›å…‹å›¾åƒä¸­  loads images in a 9-mosaic</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="sd">    :param self:</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="sd">    :param index: éœ€è¦è·å–çš„å›¾åƒç´¢å¼•</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="sd">    :return: img9: mosaicå’Œä»¿å°„å¢å¼ºåçš„ä¸€å¼ å›¾ç‰‡</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="sd">             labels9: img9å¯¹åº”çš„target</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="c1"># labels9: ç”¨äºå­˜æ”¾æ‹¼æ¥å›¾åƒï¼ˆ9å¼ å›¾æ‹¼æˆä¸€å¼ ï¼‰çš„labelä¿¡æ¯(ä¸åŒ…å«segmentså¤šè¾¹å½¢)</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    <span class="c1"># segments9: ç”¨äºå­˜æ”¾æ‹¼æ¥å›¾åƒï¼ˆ9å¼ å›¾æ‹¼æˆä¸€å¼ ï¼‰çš„labelä¿¡æ¯(åŒ…å«segmentså¤šè¾¹å½¢)</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="n">labels9</span><span class="p">,</span> <span class="n">segments9</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span>  <span class="c1"># ä¸€èˆ¬çš„å›¾ç‰‡å¤§å°(ä¹Ÿæ˜¯æœ€ç»ˆè¾“å‡ºçš„å›¾ç‰‡å¤§å°)</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="c1"># ä»datasetä¸­éšæœºå¯»æ‰¾é¢å¤–çš„ä¸‰å¼ å›¾åƒè¿›è¡Œæ‹¼æ¥ [14, 26, 2, 16] å†éšæœºé€‰ä¸‰å¼ å›¾ç‰‡çš„index</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  <span class="c1"># 8 additional image indices</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="c1"># Load image  æ¯æ¬¡æ‹¿ä¸€å¼ å›¾ç‰‡ å¹¶å°†è¿™å¼ å›¾ç‰‡resizeåˆ°self.size(h,w)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>        <span class="n">img</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>        <span class="c1"># è¿™é‡Œå’Œä¸Šé¢load_mosaicå‡½æ•°çš„æ“ä½œç±»ä¼¼ å°±æ˜¯å°†å–å‡ºçš„imgå›¾ç‰‡åµŒåˆ°img9ä¸­(ä¸æ˜¯çœŸçš„åµŒå…¥ è€Œæ˜¯æ‰¾åˆ°å¯¹åº”çš„ä½ç½®)</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="c1"># place img in img9</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># center</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>            <span class="n">img9</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">s</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">114</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>  <span class="c1"># base image with 4 tiles</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>            <span class="n">h0</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h</span>  <span class="c1"># xmin, ymin, xmax, ymax (base) coordinates</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># top</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># top right</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">wp</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">wp</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># right</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># bottom right</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">hp</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">hp</span> <span class="o">+</span> <span class="n">h</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># bottom</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">h</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># bottom left</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span> <span class="o">-</span> <span class="n">wp</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">w0</span> <span class="o">-</span> <span class="n">wp</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">h</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>  <span class="c1"># left</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>  <span class="c1"># top left</span>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span> <span class="o">-</span> <span class="n">hp</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">h0</span> <span class="o">-</span> <span class="n">hp</span>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>        <span class="n">padx</span><span class="p">,</span> <span class="n">pady</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>  <span class="c1"># allocate coords</span>
<a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>
<a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>        <span class="c1"># å’Œä¸Šé¢load_mosaicå‡½æ•°çš„æ“ä½œç±»ä¼¼ æ‰¾åˆ°mosaic9å¢å¼ºåçš„labels9å’Œsegments9</span>
<a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>        <span class="n">labels</span><span class="p">,</span> <span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>        <span class="k">if</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
<a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>            <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">xywhn2xyxy</span><span class="p">(</span><span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">padx</span><span class="p">,</span> <span class="n">pady</span><span class="p">)</span>  <span class="c1"># normalized xywh to pixel xyxy format</span>
<a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>            <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyn2xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">padx</span><span class="p">,</span> <span class="n">pady</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>
<a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>        <span class="n">labels9</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>        <span class="n">segments9</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
<a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>
<a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>        <span class="c1"># ç”Ÿæˆå¯¹åº”çš„img9å›¾ç‰‡(å°†å¯¹åº”ä½ç½®çš„å›¾ç‰‡åµŒå…¥img9ä¸­)</span>
<a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a>        <span class="n">img9</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y1</span> <span class="o">-</span> <span class="n">pady</span><span class="p">:,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">padx</span><span class="p">:]</span>  <span class="c1"># img9[ymin:ymax, xmin:xmax]</span>
<a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>        <span class="n">hp</span><span class="p">,</span> <span class="n">wp</span> <span class="o">=</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span>  <span class="c1"># height, width previous</span>
<a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>
<a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>    <span class="c1"># Offset</span>
<a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>    <span class="n">yc</span><span class="p">,</span> <span class="n">xc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mosaic_border</span><span class="p">]</span>  <span class="c1"># mosaic center x, y</span>
<a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>    <span class="n">img9</span> <span class="o">=</span> <span class="n">img9</span><span class="p">[</span><span class="n">yc</span><span class="p">:</span><span class="n">yc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">xc</span><span class="p">:</span><span class="n">xc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">]</span>
<a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>
<a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a>    <span class="c1"># Concat/clip labels</span>
<a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a>    <span class="n">labels9</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a>    <span class="n">labels9</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">xc</span>
<a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a>    <span class="n">labels9</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">yc</span>
<a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">])</span>  <span class="c1"># centers</span>
<a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a>    <span class="n">segments9</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">c</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">segments9</span><span class="p">]</span>
<a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a>
<a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">labels9</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="o">*</span><span class="n">segments9</span><span class="p">):</span>
<a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a>        <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># clip when using random_perspective()</span>
<a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a>    <span class="c1"># img9, labels9 = replicate(img9, labels9)  # replicate</span>
<a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a>
<a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a>    <span class="c1"># Augment åŒæ ·è¿›è¡Œ éšæœºé€è§†å˜æ¢</span>
<a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a>    <span class="n">img9</span><span class="p">,</span> <span class="n">labels9</span> <span class="o">=</span> <span class="n">random_perspective</span><span class="p">(</span><span class="n">img9</span><span class="p">,</span> <span class="n">labels9</span><span class="p">,</span> <span class="n">segments9</span><span class="p">,</span>
<a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a>                                       <span class="n">degrees</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;degrees&#39;</span><span class="p">],</span>
<a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a>                                       <span class="n">translate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;translate&#39;</span><span class="p">],</span>
<a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a>                                       <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">],</span>
<a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a>                                       <span class="n">shear</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">],</span>
<a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a>                                       <span class="n">perspective</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="s1">&#39;perspective&#39;</span><span class="p">],</span>
<a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a>                                       <span class="n">border</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mosaic_border</span><span class="p">)</span>  <span class="c1"># border to remove</span>
<a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a>
<a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a>    <span class="k">return</span> <span class="n">img9</span><span class="p">,</span> <span class="n">labels9</span>
</code></pre></div>
<p>ç”¨æ³•å’Œmosaicä¸€æ ·ï¼Œä½¿ç”¨ç›´æ¥å°†class LoadImagesAndLabels(Dataset): ä¸­ <strong>getitem</strong> çš„load_mosaicç›´æ¥
ç›´æ¥æ›¿æ¢æˆload_mosaic9å³å¯ï¼š</p>
<p><img alt="image" src="https://user-images.githubusercontent.com/109639975/199917054-2783d335-7ad7-42ce-91b7-73659010d679.png" /></p>
<h2 id="10-loadimages-loadstreams-loadwebcam">10. LoadImages &amp; LoadStreams &amp; LoadWebcam</h2>
<p>load æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡/è§†é¢‘ + ç”¨åˆ°å¾ˆå°‘ load webç½‘é¡µä¸­çš„æ•°æ®ã€‚
å…¨éƒ¨ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">class</span> <span class="nc">LoadImages</span><span class="p">:</span>  <span class="c1"># for inference</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="sd">&quot;&quot;&quot;åœ¨detect.pyä¸­ä½¿ç”¨</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="sd">    load æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡/è§†é¢‘</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="sd">    å®šä¹‰è¿­ä»£å™¨ ç”¨äºdetect.py</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        <span class="n">p</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>  <span class="c1"># os-agnostic absolute path</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="c1"># glob.glab: è¿”å›æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨   files: æå–å›¾ç‰‡æ‰€æœ‰è·¯å¾„</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>            <span class="c1"># å¦‚æœpæ˜¯é‡‡æ ·æ­£åˆ™åŒ–è¡¨è¾¾å¼æå–å›¾ç‰‡/è§†é¢‘, å¯ä»¥ä½¿ç”¨globè·å–æ–‡ä»¶è·¯å¾„</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>            <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>  <span class="c1"># glob</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>            <span class="c1"># å¦‚æœpæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä½¿ç”¨globè·å–å…¨éƒ¨æ–‡ä»¶è·¯å¾„</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>            <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;*.*&quot;</span><span class="p">)))</span>  <span class="c1"># dir</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>            <span class="c1"># å¦‚æœpæ˜¯æ–‡ä»¶åˆ™ç›´æ¥è·å–</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span>  <span class="c1"># files</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>        <span class="c1"># images: ç›®å½•ä¸‹æ‰€æœ‰å›¾ç‰‡çš„å›¾ç‰‡å  videos: ç›®å½•ä¸‹æ‰€æœ‰è§†é¢‘çš„è§†é¢‘å</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">img_formats</span><span class="p">]</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>        <span class="n">videos</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">vid_formats</span><span class="p">]</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>        <span class="c1"># å›¾ç‰‡ä¸è§†é¢‘æ•°é‡</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>        <span class="n">ni</span><span class="p">,</span> <span class="n">nv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">videos</span><span class="p">)</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>  <span class="c1"># æœ€å¤§çš„ä¸‹é‡‡æ ·ç‡</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">images</span> <span class="o">+</span> <span class="n">videos</span>  <span class="c1"># æ•´åˆå›¾ç‰‡å’Œè§†é¢‘è·¯å¾„åˆ°ä¸€ä¸ªåˆ—è¡¨</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="n">ni</span> <span class="o">+</span> <span class="n">nv</span>  <span class="c1"># number of files</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">video_flag</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">ni</span> <span class="o">+</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">nv</span>  <span class="c1"># æ˜¯ä¸æ˜¯video</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;image&quot;</span>  <span class="c1"># é»˜è®¤æ˜¯è¯»imageæ¨¡å¼</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">videos</span><span class="p">):</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>            <span class="c1"># åˆ¤æ–­æœ‰æ²¡æœ‰videoæ–‡ä»¶  å¦‚æœåŒ…å«videoæ–‡ä»¶ï¼Œåˆ™åˆå§‹åŒ–opencvä¸­çš„è§†é¢‘æ¨¡å—ï¼Œcap=cv2.VideoCaptureç­‰</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">new_video</span><span class="p">(</span><span class="n">videos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># new video</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>            <span class="sa">f</span><span class="s2">&quot;No images or videos found in </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>            <span class="sa">f</span><span class="s2">&quot;Supported formats are:</span><span class="se">\n</span><span class="s2">images: </span><span class="si">{</span><span class="n">img_formats</span><span class="si">}</span><span class="se">\n</span><span class="s2">videos: </span><span class="si">{</span><span class="n">vid_formats</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>        <span class="p">)</span>
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>        <span class="sd">&quot;&quot;&quot;è¿­ä»£å™¨&quot;&quot;&quot;</span>
<a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>
<a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>        <span class="sd">&quot;&quot;&quot;ä¸iterä¸€èµ·ç”¨ï¼Ÿ&quot;&quot;&quot;</span>
<a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span>  <span class="c1"># æ•°æ®è¯»å®Œäº†</span>
<a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
<a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a>        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">]</span>  <span class="c1"># è¯»å–å½“å‰æ–‡ä»¶è·¯å¾„</span>
<a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a>
<a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_flag</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">]:</span>  <span class="c1"># åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦æ˜¯è§†é¢‘</span>
<a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a>            <span class="c1"># Read video</span>
<a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;video&quot;</span>
<a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>            <span class="c1"># è·å–å½“å‰å¸§ç”»é¢ï¼Œret_valä¸ºä¸€ä¸ªboolå˜é‡ï¼Œç›´åˆ°è§†é¢‘è¯»å–å®Œæ¯•ä¹‹å‰éƒ½ä¸ºTrue</span>
<a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>            <span class="n">ret_val</span><span class="p">,</span> <span class="n">img0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a>            <span class="c1"># å¦‚æœå½“å‰è§†é¢‘è¯»å–ç»“æŸï¼Œåˆ™è¯»å–ä¸‹ä¸€ä¸ªè§†é¢‘</span>
<a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret_val</span><span class="p">:</span>
<a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>                <span class="c1"># self.count == self.nfè¡¨ç¤ºè§†é¢‘å·²ç»è¯»å–å®Œäº†</span>
<a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span>  <span class="c1"># last video</span>
<a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a>                    <span class="k">raise</span> <span class="ne">StopIteration</span>
<a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a>                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">]</span>
<a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">new_video</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-14-70" name="__codelineno-14-70" href="#__codelineno-14-70"></a>                    <span class="n">ret_val</span><span class="p">,</span> <span class="n">img0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-14-71" name="__codelineno-14-71" href="#__codelineno-14-71"></a>
<a id="__codelineno-14-72" name="__codelineno-14-72" href="#__codelineno-14-72"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># å½“å‰è¯»å–è§†é¢‘çš„å¸§æ•°</span>
<a id="__codelineno-14-73" name="__codelineno-14-73" href="#__codelineno-14-73"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-14-74" name="__codelineno-14-74" href="#__codelineno-14-74"></a>                <span class="sa">f</span><span class="s2">&quot;video </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">,</span>
<a id="__codelineno-14-75" name="__codelineno-14-75" href="#__codelineno-14-75"></a>                <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-14-76" name="__codelineno-14-76" href="#__codelineno-14-76"></a>            <span class="p">)</span>
<a id="__codelineno-14-77" name="__codelineno-14-77" href="#__codelineno-14-77"></a>
<a id="__codelineno-14-78" name="__codelineno-14-78" href="#__codelineno-14-78"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-79" name="__codelineno-14-79" href="#__codelineno-14-79"></a>            <span class="c1"># Read image</span>
<a id="__codelineno-14-80" name="__codelineno-14-80" href="#__codelineno-14-80"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-81" name="__codelineno-14-81" href="#__codelineno-14-81"></a>            <span class="n">img0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># BGR</span>
<a id="__codelineno-14-82" name="__codelineno-14-82" href="#__codelineno-14-82"></a>            <span class="k">assert</span> <span class="n">img0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Image Not Found &quot;</span> <span class="o">+</span> <span class="n">path</span>
<a id="__codelineno-14-83" name="__codelineno-14-83" href="#__codelineno-14-83"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-14-84" name="__codelineno-14-84" href="#__codelineno-14-84"></a>
<a id="__codelineno-14-85" name="__codelineno-14-85" href="#__codelineno-14-85"></a>        <span class="c1"># Padded resize</span>
<a id="__codelineno-14-86" name="__codelineno-14-86" href="#__codelineno-14-86"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">letterbox</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-14-87" name="__codelineno-14-87" href="#__codelineno-14-87"></a>
<a id="__codelineno-14-88" name="__codelineno-14-88" href="#__codelineno-14-88"></a>        <span class="c1"># Convert</span>
<a id="__codelineno-14-89" name="__codelineno-14-89" href="#__codelineno-14-89"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># BGR to RGB and HWC to CHW</span>
<a id="__codelineno-14-90" name="__codelineno-14-90" href="#__codelineno-14-90"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-14-91" name="__codelineno-14-91" href="#__codelineno-14-91"></a>
<a id="__codelineno-14-92" name="__codelineno-14-92" href="#__codelineno-14-92"></a>        <span class="c1"># è¿”å›è·¯å¾„, resize+padçš„å›¾ç‰‡, åŸå§‹å›¾ç‰‡, è§†é¢‘å¯¹è±¡</span>
<a id="__codelineno-14-93" name="__codelineno-14-93" href="#__codelineno-14-93"></a>        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">img0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span>
<a id="__codelineno-14-94" name="__codelineno-14-94" href="#__codelineno-14-94"></a>
<a id="__codelineno-14-95" name="__codelineno-14-95" href="#__codelineno-14-95"></a>    <span class="k">def</span> <span class="nf">new_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<a id="__codelineno-14-96" name="__codelineno-14-96" href="#__codelineno-14-96"></a>        <span class="c1"># è®°å½•å¸§æ•°</span>
<a id="__codelineno-14-97" name="__codelineno-14-97" href="#__codelineno-14-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-98" name="__codelineno-14-98" href="#__codelineno-14-98"></a>        <span class="c1"># åˆå§‹åŒ–è§†é¢‘å¯¹è±¡</span>
<a id="__codelineno-14-99" name="__codelineno-14-99" href="#__codelineno-14-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-14-100" name="__codelineno-14-100" href="#__codelineno-14-100"></a>        <span class="c1"># å¾—åˆ°è§†é¢‘æ–‡ä»¶ä¸­çš„æ€»å¸§æ•°</span>
<a id="__codelineno-14-101" name="__codelineno-14-101" href="#__codelineno-14-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span>
<a id="__codelineno-14-102" name="__codelineno-14-102" href="#__codelineno-14-102"></a>
<a id="__codelineno-14-103" name="__codelineno-14-103" href="#__codelineno-14-103"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-104" name="__codelineno-14-104" href="#__codelineno-14-104"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>  <span class="c1"># number of files</span>
<a id="__codelineno-14-105" name="__codelineno-14-105" href="#__codelineno-14-105"></a>
<a id="__codelineno-14-106" name="__codelineno-14-106" href="#__codelineno-14-106"></a>
<a id="__codelineno-14-107" name="__codelineno-14-107" href="#__codelineno-14-107"></a><span class="k">class</span> <span class="nc">LoadStreams</span><span class="p">:</span>
<a id="__codelineno-14-108" name="__codelineno-14-108" href="#__codelineno-14-108"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-14-109" name="__codelineno-14-109" href="#__codelineno-14-109"></a><span class="sd">    load æ–‡ä»¶å¤¹ä¸­è§†é¢‘æµ</span>
<a id="__codelineno-14-110" name="__codelineno-14-110" href="#__codelineno-14-110"></a><span class="sd">    multiple IP or RTSP cameras</span>
<a id="__codelineno-14-111" name="__codelineno-14-111" href="#__codelineno-14-111"></a><span class="sd">    å®šä¹‰è¿­ä»£å™¨ ç”¨äºdetect.py</span>
<a id="__codelineno-14-112" name="__codelineno-14-112" href="#__codelineno-14-112"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-14-113" name="__codelineno-14-113" href="#__codelineno-14-113"></a>
<a id="__codelineno-14-114" name="__codelineno-14-114" href="#__codelineno-14-114"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="s2">&quot;streams.txt&quot;</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<a id="__codelineno-14-115" name="__codelineno-14-115" href="#__codelineno-14-115"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;stream&quot;</span>  <span class="c1"># åˆå§‹åŒ–modeä¸ºimages</span>
<a id="__codelineno-14-116" name="__codelineno-14-116" href="#__codelineno-14-116"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
<a id="__codelineno-14-117" name="__codelineno-14-117" href="#__codelineno-14-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>  <span class="c1"># æœ€å¤§ä¸‹é‡‡æ ·æ­¥é•¿</span>
<a id="__codelineno-14-118" name="__codelineno-14-118" href="#__codelineno-14-118"></a>
<a id="__codelineno-14-119" name="__codelineno-14-119" href="#__codelineno-14-119"></a>        <span class="c1"># å¦‚æœsourcesä¸ºä¸€ä¸ªä¿å­˜äº†å¤šä¸ªè§†é¢‘æµçš„æ–‡ä»¶  è·å–æ¯ä¸€ä¸ªè§†é¢‘æµï¼Œä¿å­˜ä¸ºä¸€ä¸ªåˆ—è¡¨</span>
<a id="__codelineno-14-120" name="__codelineno-14-120" href="#__codelineno-14-120"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
<a id="__codelineno-14-121" name="__codelineno-14-121" href="#__codelineno-14-121"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-14-122" name="__codelineno-14-122" href="#__codelineno-14-122"></a>                <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-14-123" name="__codelineno-14-123" href="#__codelineno-14-123"></a>                    <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-14-124" name="__codelineno-14-124" href="#__codelineno-14-124"></a>                <span class="p">]</span>
<a id="__codelineno-14-125" name="__codelineno-14-125" href="#__codelineno-14-125"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-126" name="__codelineno-14-126" href="#__codelineno-14-126"></a>            <span class="c1"># åä¹‹ï¼Œåªæœ‰ä¸€ä¸ªè§†é¢‘æµæ–‡ä»¶å°±ç›´æ¥ä¿å­˜</span>
<a id="__codelineno-14-127" name="__codelineno-14-127" href="#__codelineno-14-127"></a>            <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">sources</span><span class="p">]</span>
<a id="__codelineno-14-128" name="__codelineno-14-128" href="#__codelineno-14-128"></a>
<a id="__codelineno-14-129" name="__codelineno-14-129" href="#__codelineno-14-129"></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>  <span class="c1"># è§†é¢‘æµä¸ªæ•°</span>
<a id="__codelineno-14-130" name="__codelineno-14-130" href="#__codelineno-14-130"></a>        <span class="c1"># åˆå§‹åŒ–å›¾ç‰‡ fps æ€»å¸§æ•° çº¿ç¨‹æ•°</span>
<a id="__codelineno-14-131" name="__codelineno-14-131" href="#__codelineno-14-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-14-132" name="__codelineno-14-132" href="#__codelineno-14-132"></a>            <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span>
<a id="__codelineno-14-133" name="__codelineno-14-133" href="#__codelineno-14-133"></a>            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span>
<a id="__codelineno-14-134" name="__codelineno-14-134" href="#__codelineno-14-134"></a>            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span>
<a id="__codelineno-14-135" name="__codelineno-14-135" href="#__codelineno-14-135"></a>            <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span>
<a id="__codelineno-14-136" name="__codelineno-14-136" href="#__codelineno-14-136"></a>        <span class="p">)</span>
<a id="__codelineno-14-137" name="__codelineno-14-137" href="#__codelineno-14-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">clean_str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>  <span class="c1"># clean source names for later</span>
<a id="__codelineno-14-138" name="__codelineno-14-138" href="#__codelineno-14-138"></a>
<a id="__codelineno-14-139" name="__codelineno-14-139" href="#__codelineno-14-139"></a>        <span class="c1"># éå†æ¯ä¸€ä¸ªè§†é¢‘æµ</span>
<a id="__codelineno-14-140" name="__codelineno-14-140" href="#__codelineno-14-140"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>  <span class="c1"># index, source</span>
<a id="__codelineno-14-141" name="__codelineno-14-141" href="#__codelineno-14-141"></a>            <span class="c1"># Start thread to read frames from video stream</span>
<a id="__codelineno-14-142" name="__codelineno-14-142" href="#__codelineno-14-142"></a>            <span class="c1"># æ‰“å°å½“å‰è§†é¢‘index/æ€»è§†é¢‘æ•°/è§†é¢‘æµåœ°å€</span>
<a id="__codelineno-14-143" name="__codelineno-14-143" href="#__codelineno-14-143"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-14-144" name="__codelineno-14-144" href="#__codelineno-14-144"></a>            <span class="k">if</span> <span class="s2">&quot;youtube.com/&quot;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">or</span> <span class="s2">&quot;youtu.be/&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>  <span class="c1"># if source is YouTube video</span>
<a id="__codelineno-14-145" name="__codelineno-14-145" href="#__codelineno-14-145"></a>                <span class="n">check_requirements</span><span class="p">((</span><span class="s2">&quot;pafy&quot;</span><span class="p">,</span> <span class="s2">&quot;youtube_dl&quot;</span><span class="p">))</span>
<a id="__codelineno-14-146" name="__codelineno-14-146" href="#__codelineno-14-146"></a>                <span class="kn">import</span> <span class="nn">pafy</span>
<a id="__codelineno-14-147" name="__codelineno-14-147" href="#__codelineno-14-147"></a>
<a id="__codelineno-14-148" name="__codelineno-14-148" href="#__codelineno-14-148"></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">pafy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">getbest</span><span class="p">(</span><span class="n">preftype</span><span class="o">=</span><span class="s2">&quot;mp4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">url</span>  <span class="c1"># YouTube URL</span>
<a id="__codelineno-14-149" name="__codelineno-14-149" href="#__codelineno-14-149"></a>            <span class="n">s</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="k">else</span> <span class="n">s</span>  <span class="c1"># i.e. s = &#39;0&#39; local webcam æœ¬åœ°æ‘„åƒå¤´</span>
<a id="__codelineno-14-150" name="__codelineno-14-150" href="#__codelineno-14-150"></a>            <span class="c1"># s=&#39;0&#39;æ‰“å¼€æœ¬åœ°æ‘„åƒå¤´ï¼Œå¦åˆ™æ‰“å¼€è§†é¢‘æµåœ°å€</span>
<a id="__codelineno-14-151" name="__codelineno-14-151" href="#__codelineno-14-151"></a>            <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-14-152" name="__codelineno-14-152" href="#__codelineno-14-152"></a>            <span class="k">assert</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;Failed to open </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-14-153" name="__codelineno-14-153" href="#__codelineno-14-153"></a>            <span class="c1"># è·å–è§†é¢‘çš„å®½å’Œé•¿</span>
<a id="__codelineno-14-154" name="__codelineno-14-154" href="#__codelineno-14-154"></a>            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">))</span>
<a id="__codelineno-14-155" name="__codelineno-14-155" href="#__codelineno-14-155"></a>            <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">))</span>
<a id="__codelineno-14-156" name="__codelineno-14-156" href="#__codelineno-14-156"></a>            <span class="c1"># è·å–è§†é¢‘çš„å¸§ç‡</span>
<a id="__codelineno-14-157" name="__codelineno-14-157" href="#__codelineno-14-157"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-14-158" name="__codelineno-14-158" href="#__codelineno-14-158"></a>                <span class="nb">max</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">30.0</span>
<a id="__codelineno-14-159" name="__codelineno-14-159" href="#__codelineno-14-159"></a>            <span class="p">)</span>  <span class="c1"># 30 FPS fallback</span>
<a id="__codelineno-14-160" name="__codelineno-14-160" href="#__codelineno-14-160"></a>            <span class="c1"># å¸§æ•°</span>
<a id="__codelineno-14-161" name="__codelineno-14-161" href="#__codelineno-14-161"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span>
<a id="__codelineno-14-162" name="__codelineno-14-162" href="#__codelineno-14-162"></a>                <span class="s2">&quot;inf&quot;</span>
<a id="__codelineno-14-163" name="__codelineno-14-163" href="#__codelineno-14-163"></a>            <span class="p">)</span>  <span class="c1"># infinite stream fallback</span>
<a id="__codelineno-14-164" name="__codelineno-14-164" href="#__codelineno-14-164"></a>
<a id="__codelineno-14-165" name="__codelineno-14-165" href="#__codelineno-14-165"></a>            <span class="c1"># è¯»å–å½“å‰ç”»é¢</span>
<a id="__codelineno-14-166" name="__codelineno-14-166" href="#__codelineno-14-166"></a>            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># guarantee first frame</span>
<a id="__codelineno-14-167" name="__codelineno-14-167" href="#__codelineno-14-167"></a>            <span class="c1"># åˆ›å»ºå¤šçº¿ç¨‹è¯»å–è§†é¢‘æµï¼Œdaemonè¡¨ç¤ºä¸»çº¿ç¨‹ç»“æŸæ—¶å­çº¿ç¨‹ä¹Ÿç»“æŸ</span>
<a id="__codelineno-14-168" name="__codelineno-14-168" href="#__codelineno-14-168"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">cap</span><span class="p">]),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-14-169" name="__codelineno-14-169" href="#__codelineno-14-169"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-14-170" name="__codelineno-14-170" href="#__codelineno-14-170"></a>                <span class="sa">f</span><span class="s2">&quot; success (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> frames </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> FPS)&quot;</span>
<a id="__codelineno-14-171" name="__codelineno-14-171" href="#__codelineno-14-171"></a>            <span class="p">)</span>
<a id="__codelineno-14-172" name="__codelineno-14-172" href="#__codelineno-14-172"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-14-173" name="__codelineno-14-173" href="#__codelineno-14-173"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># newline</span>
<a id="__codelineno-14-174" name="__codelineno-14-174" href="#__codelineno-14-174"></a>
<a id="__codelineno-14-175" name="__codelineno-14-175" href="#__codelineno-14-175"></a>        <span class="c1"># check for common shapes</span>
<a id="__codelineno-14-176" name="__codelineno-14-176" href="#__codelineno-14-176"></a>        <span class="c1"># è·å–è¿›è¡Œresize+padä¹‹åçš„shapeï¼Œletterboxå‡½æ•°é»˜è®¤(å‚æ•°auto=True)æ˜¯æŒ‰ç…§çŸ©å½¢æ¨ç†è¿›è¡Œå¡«å……</span>
<a id="__codelineno-14-177" name="__codelineno-14-177" href="#__codelineno-14-177"></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<a id="__codelineno-14-178" name="__codelineno-14-178" href="#__codelineno-14-178"></a>            <span class="p">[</span>
<a id="__codelineno-14-179" name="__codelineno-14-179" href="#__codelineno-14-179"></a>                <span class="n">letterbox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-14-180" name="__codelineno-14-180" href="#__codelineno-14-180"></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span>
<a id="__codelineno-14-181" name="__codelineno-14-181" href="#__codelineno-14-181"></a>            <span class="p">],</span>
<a id="__codelineno-14-182" name="__codelineno-14-182" href="#__codelineno-14-182"></a>            <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-14-183" name="__codelineno-14-183" href="#__codelineno-14-183"></a>        <span class="p">)</span>  <span class="c1"># shapes</span>
<a id="__codelineno-14-184" name="__codelineno-14-184" href="#__codelineno-14-184"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rect</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-14-185" name="__codelineno-14-185" href="#__codelineno-14-185"></a>            <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-14-186" name="__codelineno-14-186" href="#__codelineno-14-186"></a>        <span class="p">)</span>  <span class="c1"># rect inference if all shapes equal</span>
<a id="__codelineno-14-187" name="__codelineno-14-187" href="#__codelineno-14-187"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">:</span>
<a id="__codelineno-14-188" name="__codelineno-14-188" href="#__codelineno-14-188"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-14-189" name="__codelineno-14-189" href="#__codelineno-14-189"></a>                <span class="s2">&quot;WARNING: Different stream shapes detected. For optimal performance supply similarly-shaped streams.&quot;</span>
<a id="__codelineno-14-190" name="__codelineno-14-190" href="#__codelineno-14-190"></a>            <span class="p">)</span>
<a id="__codelineno-14-191" name="__codelineno-14-191" href="#__codelineno-14-191"></a>
<a id="__codelineno-14-192" name="__codelineno-14-192" href="#__codelineno-14-192"></a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cap</span><span class="p">):</span>
<a id="__codelineno-14-193" name="__codelineno-14-193" href="#__codelineno-14-193"></a>        <span class="c1"># Read stream `i` frames in daemon thread</span>
<a id="__codelineno-14-194" name="__codelineno-14-194" href="#__codelineno-14-194"></a>        <span class="n">n</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-14-195" name="__codelineno-14-195" href="#__codelineno-14-195"></a>        <span class="k">while</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">()</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-14-196" name="__codelineno-14-196" href="#__codelineno-14-196"></a>            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-197" name="__codelineno-14-197" href="#__codelineno-14-197"></a>            <span class="c1"># _, self.imgs[index] = cap.read()</span>
<a id="__codelineno-14-198" name="__codelineno-14-198" href="#__codelineno-14-198"></a>            <span class="n">cap</span><span class="o">.</span><span class="n">grab</span><span class="p">()</span>
<a id="__codelineno-14-199" name="__codelineno-14-199" href="#__codelineno-14-199"></a>            <span class="c1"># æ¯4å¸§è¯»å–ä¸€æ¬¡</span>
<a id="__codelineno-14-200" name="__codelineno-14-200" href="#__codelineno-14-200"></a>            <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># read every 4th frame</span>
<a id="__codelineno-14-201" name="__codelineno-14-201" href="#__codelineno-14-201"></a>                <span class="n">success</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">retrieve</span><span class="p">()</span>
<a id="__codelineno-14-202" name="__codelineno-14-202" href="#__codelineno-14-202"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">0</span>
<a id="__codelineno-14-203" name="__codelineno-14-203" href="#__codelineno-14-203"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># wait time</span>
<a id="__codelineno-14-204" name="__codelineno-14-204" href="#__codelineno-14-204"></a>
<a id="__codelineno-14-205" name="__codelineno-14-205" href="#__codelineno-14-205"></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-206" name="__codelineno-14-206" href="#__codelineno-14-206"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-14-207" name="__codelineno-14-207" href="#__codelineno-14-207"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-14-208" name="__codelineno-14-208" href="#__codelineno-14-208"></a>
<a id="__codelineno-14-209" name="__codelineno-14-209" href="#__codelineno-14-209"></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-210" name="__codelineno-14-210" href="#__codelineno-14-210"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-211" name="__codelineno-14-211" href="#__codelineno-14-211"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span>
<a id="__codelineno-14-212" name="__codelineno-14-212" href="#__codelineno-14-212"></a>            <span class="s2">&quot;q&quot;</span>
<a id="__codelineno-14-213" name="__codelineno-14-213" href="#__codelineno-14-213"></a>        <span class="p">):</span>  <span class="c1"># q to quit</span>
<a id="__codelineno-14-214" name="__codelineno-14-214" href="#__codelineno-14-214"></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
<a id="__codelineno-14-215" name="__codelineno-14-215" href="#__codelineno-14-215"></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
<a id="__codelineno-14-216" name="__codelineno-14-216" href="#__codelineno-14-216"></a>
<a id="__codelineno-14-217" name="__codelineno-14-217" href="#__codelineno-14-217"></a>        <span class="c1"># Letterbox</span>
<a id="__codelineno-14-218" name="__codelineno-14-218" href="#__codelineno-14-218"></a>        <span class="n">img0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-14-219" name="__codelineno-14-219" href="#__codelineno-14-219"></a>        <span class="n">img</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-14-220" name="__codelineno-14-220" href="#__codelineno-14-220"></a>            <span class="n">letterbox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-14-221" name="__codelineno-14-221" href="#__codelineno-14-221"></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img0</span>
<a id="__codelineno-14-222" name="__codelineno-14-222" href="#__codelineno-14-222"></a>        <span class="p">]</span>
<a id="__codelineno-14-223" name="__codelineno-14-223" href="#__codelineno-14-223"></a>
<a id="__codelineno-14-224" name="__codelineno-14-224" href="#__codelineno-14-224"></a>        <span class="c1"># Stack  å°†è¯»å–çš„å›¾ç‰‡æ‹¼æ¥åˆ°ä¸€èµ·</span>
<a id="__codelineno-14-225" name="__codelineno-14-225" href="#__codelineno-14-225"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-14-226" name="__codelineno-14-226" href="#__codelineno-14-226"></a>
<a id="__codelineno-14-227" name="__codelineno-14-227" href="#__codelineno-14-227"></a>        <span class="c1"># Convert</span>
<a id="__codelineno-14-228" name="__codelineno-14-228" href="#__codelineno-14-228"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># BGR to RGB and BHWC to BCHW</span>
<a id="__codelineno-14-229" name="__codelineno-14-229" href="#__codelineno-14-229"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-14-230" name="__codelineno-14-230" href="#__codelineno-14-230"></a>
<a id="__codelineno-14-231" name="__codelineno-14-231" href="#__codelineno-14-231"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">img0</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-14-232" name="__codelineno-14-232" href="#__codelineno-14-232"></a>
<a id="__codelineno-14-233" name="__codelineno-14-233" href="#__codelineno-14-233"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-234" name="__codelineno-14-234" href="#__codelineno-14-234"></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># 1E12 frames = 32 streams at 30 FPS for 30 years</span>
<a id="__codelineno-14-235" name="__codelineno-14-235" href="#__codelineno-14-235"></a>
<a id="__codelineno-14-236" name="__codelineno-14-236" href="#__codelineno-14-236"></a>
<a id="__codelineno-14-237" name="__codelineno-14-237" href="#__codelineno-14-237"></a><span class="k">class</span> <span class="nc">LoadWebcam</span><span class="p">:</span>  <span class="c1"># for inference</span>
<a id="__codelineno-14-238" name="__codelineno-14-238" href="#__codelineno-14-238"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åˆ°å¾ˆå°‘ load webç½‘é¡µä¸­çš„æ•°æ®&quot;&quot;&quot;</span>
<a id="__codelineno-14-239" name="__codelineno-14-239" href="#__codelineno-14-239"></a>
<a id="__codelineno-14-240" name="__codelineno-14-240" href="#__codelineno-14-240"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipe</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<a id="__codelineno-14-241" name="__codelineno-14-241" href="#__codelineno-14-241"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
<a id="__codelineno-14-242" name="__codelineno-14-242" href="#__codelineno-14-242"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>
<a id="__codelineno-14-243" name="__codelineno-14-243" href="#__codelineno-14-243"></a>
<a id="__codelineno-14-244" name="__codelineno-14-244" href="#__codelineno-14-244"></a>        <span class="k">if</span> <span class="n">pipe</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
<a id="__codelineno-14-245" name="__codelineno-14-245" href="#__codelineno-14-245"></a>            <span class="n">pipe</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>  <span class="c1"># local camera</span>
<a id="__codelineno-14-246" name="__codelineno-14-246" href="#__codelineno-14-246"></a>        <span class="c1"># pipe = &#39;rtsp://192.168.1.64/1&#39;  # IP camera</span>
<a id="__codelineno-14-247" name="__codelineno-14-247" href="#__codelineno-14-247"></a>        <span class="c1"># pipe = &#39;rtsp://username:password@192.168.1.64/1&#39;  # IP camera with login</span>
<a id="__codelineno-14-248" name="__codelineno-14-248" href="#__codelineno-14-248"></a>        <span class="c1"># pipe = &#39;http://wmccpinetop.axiscam.net/mjpg/video.mjpg&#39;  # IP golf camera</span>
<a id="__codelineno-14-249" name="__codelineno-14-249" href="#__codelineno-14-249"></a>
<a id="__codelineno-14-250" name="__codelineno-14-250" href="#__codelineno-14-250"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe</span>
<a id="__codelineno-14-251" name="__codelineno-14-251" href="#__codelineno-14-251"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>  <span class="c1"># video capture object</span>
<a id="__codelineno-14-252" name="__codelineno-14-252" href="#__codelineno-14-252"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_BUFFERSIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># set buffer size</span>
<a id="__codelineno-14-253" name="__codelineno-14-253" href="#__codelineno-14-253"></a>
<a id="__codelineno-14-254" name="__codelineno-14-254" href="#__codelineno-14-254"></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-255" name="__codelineno-14-255" href="#__codelineno-14-255"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-14-256" name="__codelineno-14-256" href="#__codelineno-14-256"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-14-257" name="__codelineno-14-257" href="#__codelineno-14-257"></a>
<a id="__codelineno-14-258" name="__codelineno-14-258" href="#__codelineno-14-258"></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-259" name="__codelineno-14-259" href="#__codelineno-14-259"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-260" name="__codelineno-14-260" href="#__codelineno-14-260"></a>        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">):</span>  <span class="c1"># q to quit</span>
<a id="__codelineno-14-261" name="__codelineno-14-261" href="#__codelineno-14-261"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<a id="__codelineno-14-262" name="__codelineno-14-262" href="#__codelineno-14-262"></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
<a id="__codelineno-14-263" name="__codelineno-14-263" href="#__codelineno-14-263"></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
<a id="__codelineno-14-264" name="__codelineno-14-264" href="#__codelineno-14-264"></a>
<a id="__codelineno-14-265" name="__codelineno-14-265" href="#__codelineno-14-265"></a>        <span class="c1"># Read frame</span>
<a id="__codelineno-14-266" name="__codelineno-14-266" href="#__codelineno-14-266"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># local camera</span>
<a id="__codelineno-14-267" name="__codelineno-14-267" href="#__codelineno-14-267"></a>            <span class="n">ret_val</span><span class="p">,</span> <span class="n">img0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-14-268" name="__codelineno-14-268" href="#__codelineno-14-268"></a>            <span class="n">img0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># flip left-right</span>
<a id="__codelineno-14-269" name="__codelineno-14-269" href="#__codelineno-14-269"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># IP camera</span>
<a id="__codelineno-14-270" name="__codelineno-14-270" href="#__codelineno-14-270"></a>            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-14-271" name="__codelineno-14-271" href="#__codelineno-14-271"></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-14-272" name="__codelineno-14-272" href="#__codelineno-14-272"></a>                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-14-273" name="__codelineno-14-273" href="#__codelineno-14-273"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">grab</span><span class="p">()</span>
<a id="__codelineno-14-274" name="__codelineno-14-274" href="#__codelineno-14-274"></a>                <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># skip frames</span>
<a id="__codelineno-14-275" name="__codelineno-14-275" href="#__codelineno-14-275"></a>                    <span class="n">ret_val</span><span class="p">,</span> <span class="n">img0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">retrieve</span><span class="p">()</span>
<a id="__codelineno-14-276" name="__codelineno-14-276" href="#__codelineno-14-276"></a>                    <span class="k">if</span> <span class="n">ret_val</span><span class="p">:</span>
<a id="__codelineno-14-277" name="__codelineno-14-277" href="#__codelineno-14-277"></a>                        <span class="k">break</span>
<a id="__codelineno-14-278" name="__codelineno-14-278" href="#__codelineno-14-278"></a>
<a id="__codelineno-14-279" name="__codelineno-14-279" href="#__codelineno-14-279"></a>        <span class="c1"># Print</span>
<a id="__codelineno-14-280" name="__codelineno-14-280" href="#__codelineno-14-280"></a>        <span class="k">assert</span> <span class="n">ret_val</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Camera Error </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pipe</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-14-281" name="__codelineno-14-281" href="#__codelineno-14-281"></a>        <span class="n">img_path</span> <span class="o">=</span> <span class="s2">&quot;webcam.jpg&quot;</span>
<a id="__codelineno-14-282" name="__codelineno-14-282" href="#__codelineno-14-282"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;webcam </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-14-283" name="__codelineno-14-283" href="#__codelineno-14-283"></a>
<a id="__codelineno-14-284" name="__codelineno-14-284" href="#__codelineno-14-284"></a>        <span class="c1"># Padded resize</span>
<a id="__codelineno-14-285" name="__codelineno-14-285" href="#__codelineno-14-285"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">letterbox</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-14-286" name="__codelineno-14-286" href="#__codelineno-14-286"></a>
<a id="__codelineno-14-287" name="__codelineno-14-287" href="#__codelineno-14-287"></a>        <span class="c1"># Convert</span>
<a id="__codelineno-14-288" name="__codelineno-14-288" href="#__codelineno-14-288"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># BGR to RGB and HWC to CHW</span>
<a id="__codelineno-14-289" name="__codelineno-14-289" href="#__codelineno-14-289"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-14-290" name="__codelineno-14-290" href="#__codelineno-14-290"></a>
<a id="__codelineno-14-291" name="__codelineno-14-291" href="#__codelineno-14-291"></a>        <span class="k">return</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">img0</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-14-292" name="__codelineno-14-292" href="#__codelineno-14-292"></a>
<a id="__codelineno-14-293" name="__codelineno-14-293" href="#__codelineno-14-293"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-294" name="__codelineno-14-294" href="#__codelineno-14-294"></a>        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div>
<h2 id="11-flatten_recursive">11. flatten_recursive</h2>
<p>è¿™ä¸ªæ¨¡å—æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ å³å°†imageæ–‡ä»¶å’Œlabelæ–‡ä»¶æ”¾åˆ°ä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ä¸­ã€‚</p>
<p>flatten_recursiveæ¨¡å—ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">def</span> <span class="nf">flatten_recursive</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">DATASETS_DIR</span> <span class="o">/</span> <span class="s2">&quot;coco128&quot;</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="c1"># å°†ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­  å³å°†imageæ–‡ä»¶å’Œlabelæ–‡ä»¶æ”¾åˆ°ä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ä¸­</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="c1"># Flatten a recursive directory by bringing all files to top level</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="n">new_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">_flat&quot;</span><span class="p">)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>  <span class="c1"># delete output folder</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>  <span class="c1"># make new output folder</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="si">}</span><span class="s2">/**/*.*&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>        <span class="c1"># shutil.copyfile: å¤åˆ¶æ–‡ä»¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">new_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
<h2 id="12extract_boxes">12.extract_boxes</h2>
<p>&emsp;è¿™ä¸ªæ¨¡å—æ˜¯å°†ç›®æ ‡æ£€æµ‹æ•°æ®é›†è½¬åŒ–ä¸ºåˆ†ç±»æ•°æ®é›† ï¼Œé›†ä½“åšæ³•: æŠŠç›®æ ‡æ£€æµ‹æ•°æ®é›†ä¸­çš„æ¯ä¸€ä¸ªgtæ‹†è§£å¼€ åˆ†ç±»åˆ«å­˜å‚¨åˆ°å¯¹åº”çš„æ–‡ä»¶å½“ä¸­ã€‚</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span> <span class="nf">extract_boxes</span><span class="p">(</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="n">path</span><span class="o">=</span><span class="n">DATASETS_DIR</span> <span class="o">/</span> <span class="s2">&quot;coco128&quot;</span><span class="p">,</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="p">):</span>  <span class="c1"># from utils.dataloaders import *; extract_boxes()</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="c1"># Convert detection dataset into classification dataset, with one directory per class</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="sd">&quot;&quot;&quot;è‡ªè¡Œä½¿ç”¨ ç”Ÿæˆåˆ†ç±»æ•°æ®é›†</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="sd">    å°†ç›®æ ‡æ£€æµ‹æ•°æ®é›†è½¬åŒ–ä¸ºåˆ†ç±»æ•°æ®é›† é›†ä½“åšæ³•: æŠŠç›®æ ‡æ£€æµ‹æ•°æ®é›†ä¸­çš„æ¯ä¸€ä¸ªgtæ‹†è§£å¼€ åˆ†ç±»åˆ«å­˜å‚¨åˆ°å¯¹åº”çš„æ–‡ä»¶å½“ä¸­</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="sd">    Convert detection dataset into classification dataset, with one directory per class</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="sd">    ä½¿ç”¨: from utils.datasets import *; extract_boxes()</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="sd">    :params path: æ•°æ®é›†åœ°å€</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># images dir æ•°æ®é›†æ–‡ä»¶ç›®å½• é»˜è®¤&#39;..\datasets\coco128&#39;</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;classifier&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;classifier&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># remove existing</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.*&quot;</span><span class="p">))</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>  <span class="c1"># number of files</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="k">for</span> <span class="n">im_file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>        <span class="k">if</span> <span class="n">im_file</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">IMG_FORMATS</span><span class="p">:</span> <span class="c1"># å¿…é¡»å¾—æ˜¯å›¾ç‰‡æ–‡ä»¶</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>            <span class="c1"># image</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>            <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">im_file</span><span class="p">))[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># BGR to RGB</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># å¾—åˆ°è¿™å¼ å›¾ç‰‡h w</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>            <span class="c1"># labels æ ¹æ®è¿™å¼ å›¾ç‰‡çš„è·¯å¾„æ‰¾åˆ°è¿™å¼ å›¾ç‰‡çš„labelè·¯å¾„</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>            <span class="n">lb_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">img2label_paths</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">im_file</span><span class="p">)])[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">lb_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lb_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>                    <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># labels è¯»å–labelçš„å„è¡Œ: å¯¹åº”å„ä¸ªgtåæ ‡</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lb</span><span class="p">):</span> <span class="c1"># éå†æ¯ä¸€ä¸ªgt</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>                    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># class</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>                    <span class="c1"># ç”Ÿæˆæ–°&#39;file_name path\classifier\class_index\image_name&#39;</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>                    <span class="c1"># å¦‚: &#39;F:\yolo_v5\datasets\coco128\images\train2017\classifier\45\train2017_000000000009_0.jpg&#39;</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>                    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;classifier&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">im_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">.jpg&quot;</span>  <span class="c1"># new filename</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>                        <span class="c1"># æ¯ä¸€ä¸ªç±»åˆ«çš„ç¬¬ä¸€å¼ ç…§ç‰‡å­˜è¿›å»ä¹‹å‰ å…ˆåˆ›å»ºå¯¹åº”ç±»çš„æ–‡ä»¶å¤¹</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>                        <span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>                    <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>  <span class="c1"># box normalized to æ­£å¸¸å¤§å°</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>                    <span class="c1"># b[2:] = b[2:].max()  # rectangle to square</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>                    <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">*</span> <span class="mf">1.2</span> <span class="o">+</span> <span class="mi">3</span>  <span class="c1"># pad</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>                    <span class="n">b</span> <span class="o">=</span> <span class="n">xywh2xyxy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>                    <span class="n">b</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">b</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>  <span class="c1"># clip boxes outside of image é˜²æ­¢å‡ºç•Œ </span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>                    <span class="n">b</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">b</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>                    <span class="k">assert</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">im</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]]),</span> <span class="sa">f</span><span class="s2">&quot;box failure in </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<h2 id="13-autosplit">13. autosplit</h2>
<p>&emsp;è¿™ä¸ªæ¨¡å—æ˜¯è¿›è¡Œè‡ªåŠ¨åˆ’åˆ†æ•°æ®é›†ã€‚å½“ä½¿ç”¨è‡ªå·±æ•°æ®é›†æ—¶ï¼Œå¯ä»¥ç”¨è¿™ä¸ªæ¨¡å—è¿›è¡Œè‡ªè¡Œåˆ’åˆ†æ•°æ®é›†ã€‚</p>
<p>autosplitæ¨¡å—ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span> <span class="nf">autosplit</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">DATASETS_DIR</span> <span class="o">/</span> <span class="s2">&quot;coco128/images&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">annotated_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="sd">&quot;&quot;&quot;Autosplit a dataset into train/val/test splits and save path/autosplit_*.txt files</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="sd">    Usage: from utils.dataloaders import *; autosplit()</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="sd">    Arguments</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="sd">        path:            Path to images directory</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="sd">        weights:         Train, val, test weights (list, tuple)</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="sd">        annotated_only:  Only use images with an annotated txt file</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># images dir</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="c1"># è·å–imagesä¸­æ‰€æœ‰çš„å›¾ç‰‡ image files only</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.*&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">IMG_FORMATS</span><span class="p">)</span>  <span class="c1"># image files only</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>  <span class="c1"># number of files</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="c1"># éšæœºæ•°ç§å­</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># for reproducibility</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="c1"># assign each image to a split æ ¹æ®(train, val, test)æƒé‡åˆ’åˆ†åŸå§‹å›¾ç‰‡æ•°æ®é›†</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="c1"># indices: [n]   0, 1, 2   åˆ†åˆ«è¡¨ç¤ºæ•°æ®é›†ä¸­æ¯ä¸€å¼ å›¾ç‰‡å±äºå“ªä¸ªæ•°æ®é›† åˆ†åˆ«å¯¹åº”ç€(train, val, test)</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># assign each image to a split</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>    <span class="n">txt</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;autosplit_train.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;autosplit_val.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;autosplit_test.txt&quot;</span><span class="p">]</span>  <span class="c1"># 3 txt files</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>    <span class="p">[(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">]</span>  <span class="c1"># remove existing</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Autosplitting images from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;, using *.txt labeled images only&quot;</span> <span class="o">*</span> <span class="n">annotated_only</span><span class="p">)</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">files</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">annotated_only</span> <span class="ow">or</span> <span class="n">Path</span><span class="p">(</span><span class="n">img2label_paths</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="p">)])[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># check label</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">txt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># add image to txt file</span>
</code></pre></div>
<h2 id="reference">Reference</h2>
<ul>
<li>ã€YOLOV5-5.x æºç è§£è¯»ã€‘<a href="https://blog.csdn.net/qq_38253797/article/details/119904518">atasets.py</a></li>
</ul>
                
              
              
                


<script src="https://giscus.app/client.js"
        data-repo="Oneflow-Inc/oneflow-yolo-doc"
        data-repo-id="R_kgDOIGN7Xw"
        data-category="Announcements"
        data-category-id="DIC_kwDOIGN7X84CSq90"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="augmentations_py.html" class="md-footer__link md-footer__link--prev" aria-label="ä¸Šä¸€é¡µ: augmentations.py" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                ä¸Šä¸€é¡µ
              </span>
              augmentations.py
            </div>
          </div>
        </a>
      
      
        
        <a href="downloads_py.html" class="md-footer__link md-footer__link--next" aria-label="ä¸‹ä¸€é¡µ: downloads.py" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                ä¸‹ä¸€é¡µ
              </span>
              downloads.py
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "instant"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>