
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.1.11">
    
    
      
        <title>YOLOv5 ç½‘ç»œç»“æ„è§£æ - oneflow-yolo-doc</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3754935a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#yolov5" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="oneflow-yolo-doc" class="md-header__button md-logo" aria-label="oneflow-yolo-doc" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            oneflow-yolo-doc
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              YOLOv5 ç½‘ç»œç»“æ„è§£æ
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../index.html" class="md-tabs__link">
      é¦–é¡µğŸ 
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../00_chapter/overview.html" class="md-tabs__link md-tabs__link--active">
        YOLOv5æ•™ç¨‹ğŸ“š
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../thesis_interpretation/00_yolo_history.html" class="md-tabs__link">
        è®ºæ–‡è§£è¯»
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="oneflow-yolo-doc" class="md-nav__button md-logo" aria-label="oneflow-yolo-doc" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    oneflow-yolo-doc
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        é¦–é¡µğŸ 
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        YOLOv5æ•™ç¨‹ğŸ“š
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YOLOv5æ•™ç¨‹ğŸ“š" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YOLOv5æ•™ç¨‹ğŸ“š
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../00_chapter/overview.html" class="md-nav__link">
        one-yolov5 ç‰¹ç‚¹è§£æ
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          YOLOv5 ç½‘ç»œç»“æ„è§£æ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="yolov5_network_structure_analysis.html" class="md-nav__link md-nav__link--active">
        YOLOv5 ç½‘ç»œç»“æ„è§£æ
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    å¼•è¨€
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yolov5syaml" class="md-nav__link">
    yolov5s.yamlæ–‡ä»¶å†…å®¹:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anchors" class="md-nav__link">
    anchors è§£è¯»
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backbone-head" class="md-nav__link">
    backbone &amp; headè§£è¯»
  </a>
  
    <nav class="md-nav" aria-label="backbone &amp; headè§£è¯»">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-number-module-args" class="md-nav__link">
    [from, number, module, args] å‚æ•°
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    å…³äºè°ƒæ•´ç½‘ç»œå¤§å°çš„è¯¦è§£è¯´æ˜
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conv" class="md-nav__link">
    Convæ¨¡å—è§£è¯»
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    ç½‘ç»œç»“æ„é¢„è§ˆ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yolopy" class="md-nav__link">
    yolo.py è§£è¯»
  </a>
  
    <nav class="md-nav" aria-label="yolo.py è§£è¯»">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parse_model" class="md-nav__link">
    parse_modelå‡½æ•°è§£è¯»
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model" class="md-nav__link">
    Model ç±»è§£è¯»
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect" class="md-nav__link">
    Detectç±»è§£è¯»
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    é™„ä»¶
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    å‚è€ƒæ–‡ç« :
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../02_chapter/how_to_prepare_yolov5_training_data.html" class="md-nav__link">
        å¦‚ä½•å‡†å¤‡YOLOv5æ¨¡å‹è®­ç»ƒæ•°æ®
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../03_chapter/quick_start.html" class="md-nav__link">
        å¿«é€Ÿå¼€å§‹
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../03_chapter/model_train.html" class="md-nav__link">
        æ¨¡å‹è®­ç»ƒ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../03_chapter/TTA.html" class="md-nav__link">
        Test-Time Augmentation (TTA)
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../04_chapter/mosaic.html" class="md-nav__link">
        æ•°æ®å¢å¼º
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../05_chapter/rectangular_reasoning.html" class="md-nav__link">
        çŸ©å½¢æ¨ç†
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../05_chapter/iou_in-depth_analysis.html" class="md-nav__link">
        IOUæ·±å…¥è§£æ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../05_chapter/map_analysis.html" class="md-nav__link">
        æ¨¡å‹ç²¾ç¡®åº¦è¯„ä¼°
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../06_chapter/export_onnx_tflite_tensorrt.html" class="md-nav__link">
        æ¨¡å‹å¯¼å‡º
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        è®ºæ–‡è§£è¯»
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="è®ºæ–‡è§£è¯»" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          è®ºæ–‡è§£è¯»
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/00_yolo_history.html" class="md-nav__link">
        history
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/01_yolo.html" class="md-nav__link">
        YOLOv1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/02_yolo.html" class="md-nav__link">
        YOLOv2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/03_yolo.html" class="md-nav__link">
        YOLOv3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/04_yolo.html" class="md-nav__link">
        YOLOv4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../thesis_interpretation/06_yolo.html" class="md-nav__link">
        YOLOv6
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    å¼•è¨€
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yolov5syaml" class="md-nav__link">
    yolov5s.yamlæ–‡ä»¶å†…å®¹:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anchors" class="md-nav__link">
    anchors è§£è¯»
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backbone-head" class="md-nav__link">
    backbone &amp; headè§£è¯»
  </a>
  
    <nav class="md-nav" aria-label="backbone &amp; headè§£è¯»">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-number-module-args" class="md-nav__link">
    [from, number, module, args] å‚æ•°
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    å…³äºè°ƒæ•´ç½‘ç»œå¤§å°çš„è¯¦è§£è¯´æ˜
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conv" class="md-nav__link">
    Convæ¨¡å—è§£è¯»
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    ç½‘ç»œç»“æ„é¢„è§ˆ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yolopy" class="md-nav__link">
    yolo.py è§£è¯»
  </a>
  
    <nav class="md-nav" aria-label="yolo.py è§£è¯»">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parse_model" class="md-nav__link">
    parse_modelå‡½æ•°è§£è¯»
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model" class="md-nav__link">
    Model ç±»è§£è¯»
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect" class="md-nav__link">
    Detectç±»è§£è¯»
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    é™„ä»¶
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    å‚è€ƒæ–‡ç« :
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="yolov5">YOLOv5 ç½‘ç»œç»“æ„è§£æ</h1>
<h2 id="_1">å¼•è¨€</h2>
<p>YOLOv5é’ˆå¯¹ä¸åŒå¤§å°ï¼ˆn, s, m, l, xï¼‰çš„ç½‘ç»œæ•´ä½“æ¶æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä¼šåœ¨æ¯ä¸ªå­æ¨¡å—ä¸­é‡‡ç”¨ä¸åŒçš„æ·±åº¦å’Œå®½åº¦ï¼Œ</p>
<p>åˆ†åˆ«åº”å¯¹yamlæ–‡ä»¶ä¸­çš„depth_multipleå’Œwidth_multipleå‚æ•°ã€‚</p>
<p>è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå®˜æ–¹é™¤äº†n, s, m, l, xç‰ˆæœ¬å¤–è¿˜æœ‰n6, s6, m6, l6, x6ï¼ŒåŒºåˆ«åœ¨äºåè€…æ˜¯é’ˆå¯¹æ›´å¤§åˆ†è¾¨ç‡çš„å›¾ç‰‡æ¯”å¦‚1280x1280,</p>
<p>å½“ç„¶ç»“æ„ä¸Šä¹Ÿæœ‰äº›å·®å¼‚ï¼Œå‰è€…åªä¼šä¸‹é‡‡æ ·åˆ°32å€ä¸”é‡‡ç”¨3ä¸ªé¢„æµ‹ç‰¹å¾å±‚ , è€Œåè€…ä¼šä¸‹é‡‡æ ·64å€ï¼Œé‡‡ç”¨4ä¸ªé¢„æµ‹ç‰¹å¾å±‚ã€‚</p>
<p>æœ¬ç« å°†ä»¥ yolov5sä¸ºä¾‹ ï¼Œä»é…ç½®æ–‡ä»¶ models/<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml">yolov5s.yaml</a> åˆ° models/<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolo.py">yolo.py</a> æºç è¿›è¡Œè§£è¯»ã€‚</p>
<h2 id="yolov5syaml"><a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml">yolov5s.yaml</a>æ–‡ä»¶å†…å®¹:</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">nc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span><span class="w">  </span><span class="c1"># number of classes æ•°æ®é›†ä¸­çš„ç±»åˆ«æ•°</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">depth_multiple</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.33</span><span class="w">  </span><span class="c1"># model depth multiple  æ¨¡å‹å±‚æ•°å› å­(ç”¨æ¥è°ƒæ•´ç½‘ç»œçš„æ·±åº¦)</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nt">width_multiple</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.50</span><span class="w">  </span><span class="c1"># layer channel multiple æ¨¡å‹é€šé“æ•°å› å­(ç”¨æ¥è°ƒæ•´ç½‘ç»œçš„å®½åº¦)</span><span class="w"></span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># å¦‚ä½•ç†è§£è¿™ä¸ªdepth_multipleå’Œwidth_multipleå‘¢?å®ƒå†³å®šçš„æ˜¯æ•´ä¸ªæ¨¡å‹ä¸­çš„æ·±åº¦ï¼ˆå±‚æ•°ï¼‰å’Œå®½åº¦ï¼ˆé€šé“æ•°ï¼‰,å…·ä½“æ€ä¹ˆè°ƒæ•´çš„ç»“åˆåé¢çš„backboneä»£ç è§£é‡Šã€‚</span><span class="w"></span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="nt">anchors</span><span class="p">:</span><span class="w"> </span><span class="c1"># è¡¨ç¤ºä½œç”¨äºå½“å‰ç‰¹å¾å›¾çš„Anchorå¤§å°ä¸º xxx</span><span class="w"></span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1"># 9ä¸ªanchorï¼Œå…¶ä¸­Pè¡¨ç¤ºç‰¹å¾å›¾çš„å±‚çº§ï¼ŒP3/8è¯¥å±‚ç‰¹å¾å›¾ç¼©æ”¾ä¸º1/8,æ˜¯ç¬¬3å±‚ç‰¹å¾</span><span class="w"></span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="nv">13</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">16</span><span class="p p-Indicator">,</span><span class="nv">30</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">33</span><span class="p p-Indicator">,</span><span class="nv">23</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># P3/8ï¼Œ è¡¨ç¤º[10,13],[16,30], [33,23]3ä¸ªanchor</span><span class="w"></span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">30</span><span class="p p-Indicator">,</span><span class="nv">61</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">62</span><span class="p p-Indicator">,</span><span class="nv">45</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">59</span><span class="p p-Indicator">,</span><span class="nv">119</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># P4/16</span><span class="w"></span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">116</span><span class="p p-Indicator">,</span><span class="nv">90</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">156</span><span class="p p-Indicator">,</span><span class="nv">198</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">373</span><span class="p p-Indicator">,</span><span class="nv">326</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># P5/32</span><span class="w"></span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="c1"># YOLOv5s v6.0 backbone</span><span class="w"></span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="nt">backbone</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">  </span><span class="c1"># [from, number, module, args]</span><span class="w"></span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">  </span><span class="p p-Indicator">[[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">64</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 0-P1/2</span><span class="w"></span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">128</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 1-P2/4</span><span class="w"></span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">128</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 3-P3/8</span><span class="w"></span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">256</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">512</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 5-P4/16</span><span class="w"></span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">9</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">512</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1024</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 7-P5/32</span><span class="w"></span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1024</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">SPPF</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1024</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 9</span><span class="w"></span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">  </span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="c1"># YOLOv5s v6.0 head</span><span class="w"></span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="nt">head</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">  </span><span class="p p-Indicator">[[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">512</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">nn.Upsample</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">None</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;nearest&#39;</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">   </span><span class="p p-Indicator">[[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">],</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Concat</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># cat backbone P4</span><span class="w"></span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">512</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">False</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 13</span><span class="w"></span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">nn.Upsample</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">None</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;nearest&#39;</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">   </span><span class="p p-Indicator">[[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">],</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Concat</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># cat backbone P3</span><span class="w"></span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">False</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 17 (P3/8-small)</span><span class="w"></span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">256</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="w">   </span><span class="p p-Indicator">[[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">14</span><span class="p p-Indicator">],</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Concat</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># cat head P4</span><span class="w"></span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">512</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">False</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 20 (P4/16-medium)</span><span class="w"></span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Conv</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">512</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">]],</span><span class="w"></span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="w">   </span><span class="p p-Indicator">[[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">],</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Concat</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># cat head P5</span><span class="w"></span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="w">   </span><span class="p p-Indicator">[</span><span class="nv">-1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1024</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">False</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># 23 (P5/32-large)</span><span class="w"></span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="w">   </span><span class="p p-Indicator">[[</span><span class="nv">17</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">20</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">23</span><span class="p p-Indicator">],</span><span class="w"> </span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">Detect</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">nc</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">anchors</span><span class="p p-Indicator">]],</span><span class="w">  </span><span class="c1"># Detect(P3, P4, P5)</span><span class="w"></span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="w">  </span><span class="p p-Indicator">]</span><span class="w"></span>
</code></pre></div>
<h2 id="anchors">anchors è§£è¯»</h2>
<p>yolov5 åˆå§‹åŒ–äº† 9 ä¸ª anchorsï¼Œåˆ†åˆ«åœ¨ä¸‰ä¸ªç‰¹å¾å›¾    ï¼ˆfeature mapï¼‰ä¸­ä½¿ç”¨ï¼Œæ¯ä¸ª feature map çš„æ¯ä¸ª grid cell éƒ½æœ‰ä¸‰ä¸ª anchor è¿›è¡Œé¢„æµ‹ã€‚
åˆ†é…è§„åˆ™ï¼š</p>
<ul>
<li>
<p>å°ºåº¦è¶Šå¤§çš„ feature map è¶Šé å‰ï¼Œç›¸å¯¹åŸå›¾çš„ä¸‹é‡‡æ ·ç‡è¶Šå°ï¼Œæ„Ÿå—é‡è¶Šå°ï¼Œ
  æ‰€ä»¥ç›¸å¯¹å¯ä»¥é¢„æµ‹ä¸€äº›å°ºåº¦æ¯”è¾ƒå°çš„ç‰©ä½“(å°ç›®æ ‡)ï¼Œåˆ†é…åˆ°çš„ anchors è¶Šå°ã€‚</p>
</li>
<li>
<p>å°ºåº¦è¶Šå°çš„ feature map è¶Šé åï¼Œç›¸å¯¹åŸå›¾çš„ä¸‹é‡‡æ ·ç‡è¶Šå¤§ï¼Œæ„Ÿå—é‡è¶Šå¤§ï¼Œ
  æ‰€ä»¥å¯ä»¥é¢„æµ‹ä¸€äº›å°ºåº¦æ¯”è¾ƒå¤§çš„ç‰©ä½“(å¤§ç›®æ ‡)ï¼Œæ‰€ä»¥åˆ†é…åˆ°çš„ anchors è¶Šå¤§ã€‚</p>
</li>
<li>
<p>å³åœ¨å°ç‰¹å¾å›¾ï¼ˆfeature mapï¼‰ä¸Šæ£€æµ‹å¤§ç›®æ ‡ï¼Œä¸­ç­‰å¤§å°çš„ç‰¹å¾å›¾ä¸Šæ£€æµ‹ä¸­ç­‰ç›®æ ‡ï¼Œ åœ¨å¤§ç‰¹å¾å›¾ä¸Šæ£€æµ‹å°ç›®æ ‡ã€‚</p>
</li>
</ul>
<h2 id="backbone-head">backbone &amp; headè§£è¯»</h2>
<h3 id="from-number-module-args">[from, number, module, args] å‚æ•°</h3>
<p>å››ä¸ªå‚æ•°çš„æ„ä¹‰åˆ†åˆ«æ˜¯ï¼š
1. ç¬¬ä¸€ä¸ªå‚æ•° from ï¼šä»å“ªä¸€å±‚è·å¾—è¾“å…¥ï¼Œ-1è¡¨ç¤ºä»ä¸Šä¸€å±‚è·å¾—ï¼Œ[-1, 6]è¡¨ç¤ºä»ä¸Šå±‚å’Œç¬¬6å±‚ä¸¤å±‚è·å¾—ã€‚
2. ç¬¬äºŒä¸ªå‚æ•° numberï¼šè¡¨ç¤ºæœ‰å‡ ä¸ªç›¸åŒçš„æ¨¡å—ï¼Œå¦‚æœä¸º9åˆ™è¡¨ç¤ºæœ‰9ä¸ªç›¸åŒçš„æ¨¡å—ã€‚
3. ç¬¬ä¸‰ä¸ªå‚æ•° moduleï¼šæ¨¡å—çš„åç§°ï¼Œè¿™äº›æ¨¡å—å†™åœ¨common.pyä¸­ã€‚
4. ç¬¬å››ä¸ªå‚æ•° argsï¼šç±»çš„åˆå§‹åŒ–å‚æ•°ï¼Œç”¨äºè§£æä½œä¸º moudle çš„ä¼ å…¥å‚æ•°ã€‚</p>
<p>ä¸‹é¢ä»¥ç¬¬ä¸€ä¸ªæ¨¡å—Conv ä¸ºä¾‹ä»‹ç»ä¸‹common.pyä¸­çš„æ¨¡å—</p>
<p>Conv æ¨¡å—å®šä¹‰å¦‚ä¸‹: 
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span> <span class="nc">Conv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="c1"># Standard convolution</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">act</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># ch_in, ch_out, kernel, stride, padding, groups</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="sd">        @Pargm c1: è¾“å…¥é€šé“æ•°</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="sd">        @Pargm c2: è¾“å‡ºé€šé“æ•°</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="sd">        @Pargm k : å·ç§¯æ ¸å¤§å°(kernel_size)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="sd">        @Pargm s : å·ç§¯æ­¥é•¿ (stride)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="sd">        @Pargm p : ç‰¹å¾å›¾å¡«å……å®½åº¦ (padding)</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="sd">        @Pargm g : æ§åˆ¶åˆ†ç»„ï¼Œå¿…é¡»æ•´é™¤è¾“å…¥çš„é€šé“æ•°(ä¿è¯è¾“å…¥çš„é€šé“èƒ½è¢«æ­£ç¡®åˆ†ç»„)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="c1"># https://oneflow.readthedocs.io/en/master/generated/oneflow.nn.Conv2d.html?highlight=Conv</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">autopad</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">groups</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">()</span> <span class="k">if</span> <span class="n">act</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="p">(</span><span class="n">act</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">())</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="k">def</span> <span class="nf">forward_fuse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</code></pre></div></p>
<p>æ¯”å¦‚ä¸Šé¢æŠŠwidth_multipleè®¾ç½®ä¸ºäº†0.5ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ª [64, 6, 2, 2] å°±ä¼šè¢«è§£æä¸º [3,64*0.5=32,6,2,2]ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª 3 ä¸ºè¾“å…¥channel(å› ä¸ºè¾“å…¥)ï¼Œ32 ä¸ºè¾“å‡ºchannelã€‚ </p>
<h3 id="_2">å…³äºè°ƒæ•´ç½‘ç»œå¤§å°çš„è¯¦è§£è¯´æ˜</h3>
<p>åœ¨<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolo.py">yolo.py</a>çš„256è¡Œ æœ‰å¯¹yaml æ–‡ä»¶çš„nc,depth_multipleç­‰å‚æ•°è¯»å–ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>anchors, nc, gd, gw = d[&#39;anchors&#39;], d[&#39;nc&#39;], d[&#39;depth_multiple&#39;], d[&#39;width_multiple&#39;]
</code></pre></div>
<p>"width_multiple"å‚æ•°çš„ä½œç”¨å‰é¢ä»‹ç»argså‚æ•°ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œé‚£ä¹ˆ"depth_multiple"åˆæ˜¯ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p>
<p>åœ¨<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolo.py">yolo.py</a>çš„257è¡Œæœ‰å¯¹å‚æ•°çš„å…·ä½“å®šä¹‰ï¼š</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a> <span class="n">n</span> <span class="o">=</span> <span class="n">n_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">gd</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n</span>  <span class="c1"># depth gain æš‚ä¸”å°†è¿™æ®µä»£ç å½“ä½œå…¬å¼(1)</span>
</code></pre></div>
<p>å…¶ä¸­ gd å°±æ˜¯depth_multipleçš„å€¼ï¼Œnçš„å€¼å°±æ˜¯backboneä¸­åˆ—è¡¨çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š</p>
<p>æ ¹æ®å…¬ç¤º(1)  å¾ˆå®¹æ˜“çœ‹å‡º gd å½±å“ n çš„å¤§å°ï¼Œä»è€Œå½±å“ç½‘ç»œçš„ç»“æ„å¤§å°ã€‚</p>
<p>åé¢å„å±‚ä¹‹é—´çš„æ¨¡å—æ•°é‡ã€å·ç§¯æ ¸å¤§å°å’Œæ•°é‡ç­‰ä¹Ÿéƒ½äº§ç”Ÿäº†å˜åŒ–ï¼ŒYOLOv5l ä¸ YOLOv5s ç›¸æ¯”è¾ƒèµ·æ¥è®­ç»ƒå‚æ•°çš„å¤§å°æˆå€æ•°å¢é•¿ï¼Œ</p>
<p>å…¶æ¨¡å‹çš„æ·±åº¦å’Œå®½åº¦ä¹Ÿä¼šå¤§å¾ˆå¤šï¼Œè¿™å°±ä½¿å¾— YOLOv5l çš„ ç²¾åº¦å€¼è¦æ¯” YOLOv5s å¥½å¾ˆå¤šï¼Œå› æ­¤åœ¨æœ€ç»ˆæ¨ç†æ—¶çš„æ£€æµ‹ç²¾åº¦é«˜ï¼Œä½†æ˜¯æ¨¡å‹çš„æ¨ç†é€Ÿåº¦æ›´æ…¢ã€‚</p>
<p>æ‰€ä»¥ YOLOv5 æä¾›äº†ä¸åŒçš„é€‰æ‹©ï¼Œå¦‚æœæƒ³è¦è¿½æ±‚æ¨ç†é€Ÿåº¦å¯é€‰ç”¨è¾ƒå°ä¸€äº›çš„æ¨¡å‹å¦‚ YOLOv5sã€YOLOv5mï¼Œå¦‚æœæƒ³è¦è¿½æ±‚ç²¾åº¦æ›´é«˜å¯¹æ¨ç†é€Ÿåº¦è¦æ±‚ä¸é«˜çš„å¯ä»¥é€‰æ‹©å…¶ä»–ä¸¤ä¸ªç¨å¤§çš„æ¨¡å‹ã€‚</p>
<p>å¦‚ä¸‹é¢è¿™å¼ å›¾ï¼š </p>
<p align="center">
  <img src="./yolov5_network_structure_analysis_imgs/model_comparison.png" >
  <caption> <u>å›¾2.1</u>:yolov5 æ¨¡å‹æ¯”è¾ƒå›¾ <br> æ¥æº:https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data </caption>
</p>

<h3 id="conv">Convæ¨¡å—è§£è¯»</h3>
<h3 id="_3">ç½‘ç»œç»“æ„é¢„è§ˆ</h3>
<p>ä¸‹é¢æ˜¯æ ¹æ®<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml">yolov5s.yaml</a>ç»˜åˆ¶çš„ç½‘ç»œæ•´ä½“ç»“æ„ç®€åŒ–ç‰ˆã€‚</p>
<p align="center">
  <!-- <img src="https://oneflow-static.oss-cn-beijing.aliyuncs.com/one-yolo/imgs/yolovs%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84%E6%A8%A1%E5%9E%8B.drawio.png" > -->

  <img src = "./yolov5_network_structure_analysis_imgs/yolovsç½‘ç»œç»“æ„æ¨¡å‹.drawio.png">
  <caption> <u>å›¾2.2</u>:yolov5s ç½‘ç»œæ•´ä½“ç»“æ„ <br> </caption>
</p>

<ol>
<li>
<p>è¯¦ç»†çš„ç½‘ç»œç»“æ„å›¾ï¼šhttps://oneflow-static.oss-cn-beijing.aliyuncs.com/one-yolo/imgs/yolov5s.onnx.png 
é€šè¿‡export.pyå¯¼å‡ºçš„onnxæ ¼å¼ï¼Œå¹¶é€šè¿‡ https://netron.app/ ç½‘ç«™å¯¼å‡ºçš„å›¾ç‰‡(æ¨¡å‹å¯¼å‡º å°†åœ¨ç¬¬å…«ç« ä»‹ç»)ã€‚</p>
</li>
<li>
<p>æ¨¡å—ç»„ä»¶å³è¾¹å‚æ•° è¡¨ç¤ºç‰¹å¾å›¾çš„çš„å½¢çŠ¶ï¼Œæ¯”å¦‚ åœ¨ ç¬¬ ä¸€ å±‚( Conv )è¾“å…¥ å›¾ç‰‡å½¢çŠ¶ä¸º [ 3, 640, 640] ,å…³äºè¿™äº›å‚æ•°ï¼Œå¯ä»¥å›ºå®šä¸€å¼ å›¾ç‰‡è¾“å…¥åˆ°ç½‘ç»œå¹¶é€šè¿‡<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml">yolov5s.yaml</a>çš„æ¨¡å‹å‚æ•°è®¡ç®—å¾—åˆ°ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å·¥ç¨‹ models/<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolo.py">yolo.py</a> é€šè¿‡ä»£ç è¿›è¡ŒprintæŸ¥çœ‹,è¯¦ç»†æ•°æ®å¯ä»¥å‚è€ƒé™„ä»¶è¡¨2.1ã€‚</p>
</li>
</ol>
<h2 id="yolopy"><a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolo.py">yolo.py</a> è§£è¯»</h2>
<p><a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/[yolo.py](https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolo.py)">æ–‡ä»¶åœ°å€</a></p>
<p>æ–‡ä»¶ä¸»è¦åŒ…å« ä¸‰å¤§éƒ¨åˆ† Detectç±»ï¼Œ Modelç±»ï¼Œå’Œ parse_model å‡½æ•°</p>
<p>å¯ä»¥é€šè¿‡ <strong>python models/<a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolo.py">yolo.py</a> --cfg <a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml">yolov5s.yaml</a></strong> è¿è¡Œè¯¥è„šæœ¬è¿›è¡Œè§‚å¯Ÿ</p>
<h3 id="parse_model">parse_modelå‡½æ•°è§£è¯»</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span> <span class="nf">parse_model</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>  <span class="c1"># model_dict, input_channels(3)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="sd">&quot;&quot;&quot;ç”¨åœ¨ä¸‹é¢Modelæ¨¡å—ä¸­</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="sd">    è§£ææ¨¡å‹æ–‡ä»¶(å­—å…¸å½¢å¼)ï¼Œå¹¶æ­å»ºç½‘ç»œç»“æ„</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="sd">    è¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦åšçš„å°±æ˜¯: æ›´æ–°å½“å‰å±‚çš„argsï¼ˆå‚æ•°ï¼‰,è®¡ç®—c2ï¼ˆå½“å‰å±‚çš„è¾“å‡ºchannelï¼‰ =&gt;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="sd">                          ä½¿ç”¨å½“å‰å±‚çš„å‚æ•°æ­å»ºå½“å‰å±‚ =&gt;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="sd">                          ç”Ÿæˆ layers + save</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="sd">    @Params d: model_dict æ¨¡å‹æ–‡ä»¶ å­—å…¸å½¢å¼ {dict:7}  [yolov5s.yaml](https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml)ä¸­çš„6ä¸ªå…ƒç´  + ch</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="sd">    #Params ch: è®°å½•æ¨¡å‹æ¯ä¸€å±‚çš„è¾“å‡ºchannel åˆå§‹ch=[3] åé¢ä¼šåˆ é™¤</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="sd">    @return nn.Sequential(*layers): ç½‘ç»œçš„æ¯ä¸€å±‚çš„å±‚ç»“æ„</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="sd">    @return sorted(save): æŠŠæ‰€æœ‰å±‚ç»“æ„ä¸­fromä¸æ˜¯-1çš„å€¼è®°ä¸‹ å¹¶æ’åº [4, 6, 10, 14, 17, 20, 23]</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}{</span><span class="s1">&#39;from&#39;</span><span class="si">:</span><span class="s2">&gt;18</span><span class="si">}{</span><span class="s1">&#39;n&#39;</span><span class="si">:</span><span class="s2">&gt;3</span><span class="si">}{</span><span class="s1">&#39;params&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="s1">&#39;module&#39;</span><span class="si">:</span><span class="s2">&lt;40</span><span class="si">}{</span><span class="s1">&#39;arguments&#39;</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="c1"># è¯»å–då­—å…¸ä¸­çš„anchorså’Œparameters(ncã€depth_multipleã€width_multiple)</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="n">anchors</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">gd</span><span class="p">,</span> <span class="n">gw</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;anchors&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;depth_multiple&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;width_multiple&#39;</span><span class="p">]</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="c1"># na: number of anchors æ¯ä¸€ä¸ªpredict headä¸Šçš„anchoræ•° = 3</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="n">na</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">anchors</span>  <span class="c1"># number of anchors</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="n">no</span> <span class="o">=</span> <span class="n">na</span> <span class="o">*</span> <span class="p">(</span><span class="n">nc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># number of outputs = anchors * (classes + 5) æ¯ä¸€ä¸ªpredict headå±‚çš„è¾“å‡ºchannel </span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="c1"># å¼€å§‹æ­å»ºç½‘ç»œ</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="c1"># layers: ä¿å­˜æ¯ä¸€å±‚çš„å±‚ç»“æ„</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="c1"># save: è®°å½•ä¸‹æ‰€æœ‰å±‚ç»“æ„ä¸­fromä¸­ä¸æ˜¯-1çš„å±‚ç»“æ„åºå·</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="c1"># c2: ä¿å­˜å½“å‰å±‚çš„è¾“å‡ºchannel</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="n">layers</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">ch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># layers, savelist, ch out</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="c1"># enumerate() å‡½æ•°ç”¨äºå°†ä¸€ä¸ªå¯éå†çš„æ•°æ®å¯¹è±¡(å¦‚åˆ—è¡¨ã€å…ƒç»„æˆ–å­—ç¬¦ä¸²)ç»„åˆä¸ºä¸€ä¸ªç´¢å¼•åºåˆ—ï¼ŒåŒæ—¶åˆ—å‡ºæ•°æ®å’Œæ•°æ®ä¸‹æ ‡ï¼Œä¸€èˆ¬ç”¨åœ¨ for å¾ªç¯å½“ä¸­ã€‚</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;backbone&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]):</span>  <span class="c1"># from, number, module, args</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="n">m</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">m</span>  <span class="c1"># eval strings</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>            <span class="c1"># argsæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸€æ­¥æŠŠåˆ—è¡¨ä¸­çš„å†…å®¹å–å‡ºæ¥</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">NameError</span><span class="p">):</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>                <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">a</span>  <span class="c1"># eval strings</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="c1"># å°†æ·±åº¦ä¸æ·±åº¦å› å­ç›¸ä¹˜ï¼Œè®¡ç®—å±‚æ·±åº¦ã€‚æ·±åº¦æœ€å°ä¸º1. </span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="n">n</span> <span class="o">=</span> <span class="n">n_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">gd</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">n</span>  <span class="c1"># depth gain</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="c1"># å¦‚æœå½“å‰çš„æ¨¡å—måœ¨æœ¬é¡¹ç›®å®šä¹‰çš„æ¨¡å—ç±»å‹ä¸­ï¼Œå°±å¯ä»¥å¤„ç†è¿™ä¸ªæ¨¡å—</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Conv</span><span class="p">,</span> <span class="n">GhostConv</span><span class="p">,</span> <span class="n">Bottleneck</span><span class="p">,</span> <span class="n">GhostBottleneck</span><span class="p">,</span> <span class="n">SPP</span><span class="p">,</span> <span class="n">SPPF</span><span class="p">,</span> <span class="n">DWConv</span><span class="p">,</span> <span class="n">MixConv2d</span><span class="p">,</span> <span class="n">Focus</span><span class="p">,</span> <span class="n">CrossConv</span><span class="p">,</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>                 <span class="n">BottleneckCSP</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C3TR</span><span class="p">,</span> <span class="n">C3SPP</span><span class="p">,</span> <span class="n">C3Ghost</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">,</span> <span class="n">DWConvTranspose2d</span><span class="p">,</span> <span class="n">C3x</span><span class="p">):</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>            <span class="c1"># c1: è¾“å…¥é€šé“æ•° c2ï¼šè¾“å‡ºé€šé“æ•°</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>            <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="c1"># è¯¥å±‚ä¸æ˜¯æœ€åä¸€å±‚ï¼Œåˆ™å°†é€šé“æ•°ä¹˜ä»¥å®½åº¦å› å­ ä¹Ÿå°±æ˜¯è¯´ï¼Œå®½åº¦å› å­ä½œç”¨äºé™¤äº†æœ€åä¸€å±‚ä¹‹å¤–çš„æ‰€æœ‰å±‚</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>            <span class="k">if</span> <span class="n">c2</span> <span class="o">!=</span> <span class="n">no</span><span class="p">:</span>  <span class="c1"># if not output</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>                <span class="c1"># make_divisibleçš„ä½œç”¨ï¼Œä½¿å¾—åŸå§‹çš„é€šé“æ•°ä¹˜ä»¥å®½åº¦å› å­ä¹‹åå–æ•´åˆ°8çš„å€æ•°ï¼Œè¿™æ ·å¤„ç†ä¸€èˆ¬æ˜¯è®©æ¨¡å‹çš„å¹¶è¡Œæ€§å’Œæ¨ç†æ€§èƒ½æ›´å¥½ã€‚</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>                <span class="n">c2</span> <span class="o">=</span> <span class="n">make_divisible</span><span class="p">(</span><span class="n">c2</span> <span class="o">*</span> <span class="n">gw</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>            <span class="c1"># å°†å‰é¢çš„è¿ç®—ç»“æœä¿å­˜åœ¨argsä¸­ï¼Œå®ƒä¹Ÿå°±æ˜¯è¿™ä¸ªæ¨¡å—æœ€ç»ˆçš„è¾“å…¥å‚æ•°ã€‚</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> 
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>            <span class="c1"># æ ¹æ®æ¯å±‚ç½‘ç»œå‚æ•°çš„ä¸åŒï¼Œåˆ†åˆ«å¤„ç†å‚æ•° å…·ä½“å„ä¸ªç±»çš„å‚æ•°æ˜¯ä»€ä¹ˆè¯·å‚è€ƒå®ƒä»¬çš„__init__æ–¹æ³•è¿™é‡Œä¸å†è¯¦ç»†è§£é‡Šäº†</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">BottleneckCSP</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C3TR</span><span class="p">,</span> <span class="n">C3Ghost</span><span class="p">,</span> <span class="n">C3x</span><span class="p">]:</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>                <span class="c1"># è¿™é‡Œçš„æ„æ€å°±æ˜¯é‡å¤næ¬¡ï¼Œæ¯”å¦‚convè¿™ä¸ªæ¨¡å—é‡å¤næ¬¡ï¼Œè¿™ä¸ªn æ˜¯ä¸Šé¢ç®—å‡ºæ¥çš„ depth </span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>                <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># number of repeats</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">:</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">Concat</span><span class="p">:</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>            <span class="n">c2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">Detect</span><span class="p">:</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ch</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>  <span class="c1"># number of anchors</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>                <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">Contract</span><span class="p">:</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>            <span class="n">c2</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>        <span class="k">elif</span> <span class="n">m</span> <span class="ow">is</span> <span class="n">Expand</span><span class="p">:</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>            <span class="n">c2</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">//</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>            <span class="n">c2</span> <span class="o">=</span> <span class="n">ch</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>        <span class="c1"># æ„å»ºæ•´ä¸ªç½‘ç»œæ¨¡å— è¿™é‡Œå°±æ˜¯æ ¹æ®æ¨¡å—çš„é‡å¤æ¬¡æ•°nä»¥åŠæ¨¡å—æœ¬èº«å’Œå®ƒçš„å‚æ•°æ¥æ„å»ºè¿™ä¸ªæ¨¡å—å’Œå‚æ•°å¯¹åº”çš„Module</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>        <span class="n">m_</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># module</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>        <span class="c1"># è·å–æ¨¡å—(module type)å…·ä½“åä¾‹å¦‚ models.common.Conv , models.common.C3 , models.common.SPPF ç­‰ã€‚</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>        <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__main__.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1">#  replaceå‡½æ•°ä½œç”¨æ˜¯å­—ç¬¦ä¸²&quot;__main__&quot;æ›¿æ¢ä¸º&#39;&#39;ï¼Œåœ¨å½“å‰é¡¹ç›®æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªæ›¿æ¢ã€‚</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>        <span class="n">np</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m_</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>  <span class="c1"># number params</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>        <span class="n">m_</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">m_</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">m_</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">m_</span><span class="o">.</span><span class="n">np</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">np</span>  <span class="c1"># attach index, &#39;from&#39; index, type, number params</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">&gt;3</span><span class="si">}{</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;18</span><span class="si">}{</span><span class="n">n_</span><span class="si">:</span><span class="s1">&gt;3</span><span class="si">}{</span><span class="n">np</span><span class="si">:</span><span class="s1">10.0f</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s1">&lt;40</span><span class="si">}{</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">:</span><span class="s1">&lt;30</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># print</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="sd">        å¦‚æœxä¸æ˜¯-1ï¼Œåˆ™å°†å…¶ä¿å­˜åœ¨saveåˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºè¯¥å±‚éœ€è¦ä¿å­˜ç‰¹å¾å›¾ã€‚</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a><span class="sd">        è¿™é‡Œ x % i ä¸ x ç­‰ä»·ä¾‹å¦‚åœ¨æœ€åä¸€å±‚ : </span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="sd">        f = [17,20,23] , i = 24 </span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="sd">        y = [ x % i for x in ([f] if isinstance(f, int) else f) if x != -1 ]</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a><span class="sd">        print(y) # [17, 20, 23] </span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a><span class="sd">        # å†™æˆx % i å¯èƒ½å› ä¸ºï¼ši - 1 = -1 % i (æ¯”å¦‚ f = [-1]ï¼Œåˆ™ [x % i for x in f] ä»£è¡¨ [11] )</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>        <span class="n">save</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">([</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># append to savelist</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_</span><span class="p">)</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># å¦‚æœæ˜¯åˆæ¬¡è¿­ä»£ï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ªchï¼ˆå› ä¸ºå½¢å‚chåœ¨åˆ›å»ºç¬¬ä¸€ä¸ªç½‘ç»œæ¨¡å—æ—¶éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥åˆ›å»ºç½‘ç»œæ¨¡å—ä¹‹åå†åˆå§‹åŒ–chï¼‰</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>            <span class="n">ch</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>        <span class="n">ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>    <span class="c1"># å°†æ‰€æœ‰çš„å±‚å°è£…ä¸ºnn.Sequential , å¯¹ä¿å­˜çš„ç‰¹å¾å›¾æ’åº</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">save</span><span class="p">)</span> 
</code></pre></div>
<h3 id="model">Model ç±»è§£è¯»</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="c1"># YOLOv5 model</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="s1">&#39;[yolov5s.yaml](https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml)&#39;</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anchors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># model, input channels, number of classes</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        <span class="c1"># å¦‚æœcfgå·²ç»æ˜¯å­—å…¸ï¼Œåˆ™ç›´æ¥èµ‹å€¼ï¼Œå¦åˆ™å…ˆåŠ è½½cfgè·¯å¾„çš„æ–‡ä»¶ä¸ºå­—å…¸å¹¶èµ‹å€¼ç»™self.yamlã€‚</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> 
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span> <span class="o">=</span> <span class="n">cfg</span>  <span class="c1"># model dict</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># is *.yaml  åŠ è½½yamlæ¨¡å—</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>            <span class="kn">import</span> <span class="nn">yaml</span>  <span class="c1"># for flow hub </span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">yaml_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># model dict  ä»yamlæ–‡ä»¶ä¸­åŠ è½½å‡ºå­—å…¸</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="c1"># Define model</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="c1"># ch: è¾“å…¥é€šé“æ•°ã€‚ å‡å¦‚self.yamlæœ‰é”®â€˜châ€™ï¼Œåˆ™å°†è¯¥é”®å¯¹åº”çš„å€¼èµ‹ç»™å†…éƒ¨å˜é‡chã€‚å‡å¦‚æ²¡æœ‰â€˜châ€™ï¼Œåˆ™å°†å½¢å‚chèµ‹ç»™å†…éƒ¨å˜é‡ch</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        <span class="n">ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s1">&#39;ch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ch&#39;</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>  <span class="c1"># input channels</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="c1"># å‡å¦‚yamlä¸­çš„ncå’Œæ–¹æ³•å½¢å‚ä¸­çš„ncä¸ä¸€è‡´ï¼Œåˆ™è¦†ç›–yamlä¸­çš„ncã€‚</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span class="k">if</span> <span class="n">nc</span> <span class="ow">and</span> <span class="n">nc</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overriding model.yaml nc=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with nc=</span><span class="si">{</span><span class="n">nc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc</span>  <span class="c1"># override yaml value</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="k">if</span> <span class="n">anchors</span><span class="p">:</span> <span class="c1"># anchors  å…ˆéªŒæ¡†çš„é…ç½®</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Overriding model.yaml anchors with anchors=</span><span class="si">{</span><span class="n">anchors</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s1">&#39;anchors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>  <span class="c1"># override yaml value</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="c1"># å¾—åˆ°æ¨¡å‹ï¼Œä»¥åŠå¯¹åº”çš„ä¿å­˜çš„ç‰¹å¾å›¾åˆ—è¡¨ã€‚    </span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">parse_model</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">),</span> <span class="n">ch</span><span class="o">=</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span>  <span class="c1"># model, savelist</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">])]</span>  <span class="c1"># default names åˆå§‹åŒ–ç±»ååˆ—è¡¨ï¼Œé»˜è®¤ä¸º[0,1,2...]</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>        <span class="c1"># self.inplace=True  é»˜è®¤True  èŠ‚çœå†…å­˜</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inplace&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="c1"># Build strides, anchors  ç¡®å®šæ­¥é•¿ã€æ­¥é•¿å¯¹åº”çš„é”šæ¡†</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Detect()</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Detect</span><span class="p">):</span> <span class="c1"># æ£€éªŒæ¨¡å‹çš„æœ€åä¸€å±‚æ˜¯Detectæ¨¡å—</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>            <span class="n">s</span> <span class="o">=</span> <span class="mi">256</span>  <span class="c1"># 2x min stride</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>            <span class="n">m</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="c1"># è®¡ç®—ä¸‰ä¸ªfeature mapä¸‹é‡‡æ ·çš„å€ç‡  [8, 16, 32]</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="n">m</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">s</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">))])</span>  <span class="c1"># forward</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>            <span class="c1"># æ£€æŸ¥anchoré¡ºåºä¸strideé¡ºåºæ˜¯å¦ä¸€è‡´ anchorçš„é¡ºåºåº”è¯¥æ˜¯ä»å°åˆ°å¤§ï¼Œè¿™é‡Œæ’ä¸€ä¸‹åº</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>            <span class="n">check_anchor_order</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># must be in pixel-space (not grid-space)</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>            <span class="c1"># å¯¹åº”çš„anchorè¿›è¡Œç¼©æ”¾æ“ä½œï¼ŒåŸå› ï¼šå¾—åˆ°anchoråœ¨å®é™…çš„ç‰¹å¾å›¾ä¸­çš„ä½ç½®ï¼Œå› ä¸ºåŠ è½½çš„åŸå§‹anchorå¤§å°æ˜¯ç›¸å¯¹äºåŸå›¾çš„åƒç´ ï¼Œä½†æ˜¯ç»è¿‡å·ç§¯æ± åŒ–ä¹‹åï¼Œç‰¹å¾å›¾çš„é•¿å®½å˜å°äº†ã€‚</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>            <span class="n">m</span><span class="o">.</span><span class="n">anchors</span> <span class="o">/=</span> <span class="n">m</span><span class="o">.</span><span class="n">stride</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">stride</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_biases</span><span class="p">()</span> <span class="c1"># only run once  åˆå§‹åŒ–åç½® </span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        <span class="c1"># Init weights, biases</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>        <span class="c1"># è°ƒç”¨oneflow_utils.pyä¸‹initialize_weightsåˆå§‹åŒ–æ¨¡å‹æƒé‡</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>        <span class="n">initialize_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span> <span class="c1"># æ‰“å°æ¨¡å‹ä¿¡æ¯</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>    <span class="c1"># ç®¡ç†å‰å‘ä¼ æ’­å‡½æ•°</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>        <span class="k">if</span> <span class="n">augment</span><span class="p">:</span><span class="c1"># æ˜¯å¦åœ¨æµ‹è¯•æ—¶ä¹Ÿä½¿ç”¨æ•°æ®å¢å¼º  Test Time Augmentation(TTA)</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_augment</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># augmented inference, None</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_once</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">visualize</span><span class="p">)</span>  <span class="c1"># single-scale inference, train</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>    <span class="c1"># å¸¦æ•°æ®å¢å¼ºçš„å‰å‘ä¼ æ’­</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>    <span class="k">def</span> <span class="nf">_forward_augment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>        <span class="n">img_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># height, width</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.83</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">]</span>  <span class="c1"># scales</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>        <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># flips (2-ud, 3-lr)</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># outputs</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>        <span class="k">for</span> <span class="n">si</span><span class="p">,</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>            <span class="n">xi</span> <span class="o">=</span> <span class="n">scale_img</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span> <span class="k">if</span> <span class="n">fi</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>            <span class="n">yi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_once</span><span class="p">(</span><span class="n">xi</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># forward</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>            <span class="c1"># cv2.imwrite(f&#39;img_{si}.jpg&#39;, 255 * xi[0].cpu().numpy().transpose((1, 2, 0))[:, :, ::-1])  # save</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>            <span class="n">yi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_descale_pred</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_augmented</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># clip augmented tails</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>        <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span>  <span class="c1"># augmented inference, train</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>    <span class="c1"># å‰å‘ä¼ æ’­å…·ä½“å®ç°</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>    <span class="k">def</span> <span class="nf">_forward_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a><span class="sd">        @params x: è¾“å…¥å›¾åƒ</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a><span class="sd">        @params profile: True å¯ä»¥åšä¸€äº›æ€§èƒ½è¯„ä¼°</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a><span class="sd">        @params feature_vis: True å¯ä»¥åšä¸€äº›ç‰¹å¾å¯è§†åŒ–</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>        <span class="c1"># y: å­˜æ”¾ç€self.save=Trueçš„æ¯ä¸€å±‚çš„è¾“å‡ºï¼Œå› ä¸ºåé¢çš„ç‰¹å¾èåˆæ“ä½œè¦ç”¨åˆ°è¿™äº›ç‰¹å¾å›¾</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>        <span class="n">y</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>  <span class="c1"># outputs</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>        <span class="c1"># å‰å‘æ¨ç†æ¯ä¸€å±‚ç»“æ„   m.i=index   m.f=from   m.type=ç±»å   m.np=number of params</span>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>            <span class="c1"># if not from previous layer   m.f=å½“å‰å±‚çš„è¾“å…¥æ¥è‡ªå“ªä¸€å±‚çš„è¾“å‡º  sçš„m.féƒ½æ˜¯-1</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">f</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># if not from previous layer</span>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">f</span><span class="p">]</span>  <span class="c1"># from earlier layers</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>            <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_profile_one_layer</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># run</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># save output</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>            <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>                <span class="n">feature_visualization</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">visualize</span><span class="p">)</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>    <span class="c1"># å°†æ¨ç†ç»“æœæ¢å¤åˆ°åŸå›¾å›¾ç‰‡å°ºå¯¸(é€†æ“ä½œ)</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a>    <span class="k">def</span> <span class="nf">_descale_pred</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">flips</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>        <span class="c1"># de-scale predictions following augmented inference (inverse operation)</span>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>        <span class="sd">&quot;&quot;&quot;ç”¨åœ¨ä¸Šé¢çš„__init__å‡½æ•°ä¸Š</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a><span class="sd">        å°†æ¨ç†ç»“æœæ¢å¤åˆ°åŸå›¾å›¾ç‰‡å°ºå¯¸  Test Time Augmentation(TTA)ä¸­ç”¨åˆ°</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a><span class="sd">         de-scale predictions following augmented inference (inverse operation)</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a><span class="sd">        @params p: æ¨ç†ç»“æœ</span>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a><span class="sd">        @params flips:</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a><span class="sd">        @params scale:</span>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a><span class="sd">        @params img_size:</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span><span class="p">:</span>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>            <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span>  <span class="c1"># de-scale</span>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a>            <span class="k">if</span> <span class="n">flips</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>                <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># de-flip ud</span>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>            <span class="k">elif</span> <span class="n">flips</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>                <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># de-flip lr</span>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">wh</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span>  <span class="c1"># de-scale</span>
<a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>            <span class="k">if</span> <span class="n">flips</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span>  <span class="c1"># de-flip ud</span>
<a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>            <span class="k">elif</span> <span class="n">flips</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span>  <span class="c1"># de-flip lr</span>
<a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">wh</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>        <span class="k">return</span> <span class="n">p</span>
<a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>    <span class="c1"># è¿™ä¸ªæ˜¯TTAçš„æ—¶å€™å¯¹åŸå›¾ç‰‡è¿›è¡Œè£å‰ªï¼Œä¹Ÿæ˜¯ä¸€ç§æ•°æ®å¢å¼ºæ–¹å¼ï¼Œç”¨åœ¨TTAæµ‹è¯•çš„æ—¶å€™ã€‚</span>
<a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>    <span class="k">def</span> <span class="nf">_clip_augmented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>        <span class="c1"># Clip YOLOv5 augmented inference tails</span>
<a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>        <span class="n">nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nl</span>  <span class="c1"># number of detection layers (P3-P5)</span>
<a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>        <span class="n">g</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">4</span> <span class="o">**</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nl</span><span class="p">))</span>  <span class="c1"># grid points</span>
<a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>        <span class="n">e</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># exclude layer count</span>
<a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">4</span> <span class="o">**</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># indices</span>
<a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># large</span>
<a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">4</span> <span class="o">**</span> <span class="p">(</span><span class="n">nl</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># indices</span>
<a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>        <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">i</span><span class="p">:]</span>  <span class="c1"># small</span>
<a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>        <span class="k">return</span> <span class="n">y</span>
<a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>    <span class="c1"># æ‰“å°æ—¥å¿—ä¿¡æ¯  å‰å‘æ¨ç†æ—¶é—´</span>
<a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>    <span class="k">def</span> <span class="nf">_profile_one_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>        <span class="n">c</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Detect</span><span class="p">)</span>  <span class="c1"># is final layer, copy input as inplace fix</span>
<a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>        <span class="n">o</span> <span class="o">=</span> <span class="n">thop</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="n">x</span><span class="p">,),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1E9</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">thop</span> <span class="k">else</span> <span class="mi">0</span>  <span class="c1"># FLOPs</span>
<a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>        <span class="n">t</span> <span class="o">=</span> <span class="n">time_sync</span><span class="p">()</span>
<a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a>            <span class="n">m</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>        <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">time_sync</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a>        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;time (ms)&#39;</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;GFLOPs&#39;</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;params&#39;</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2">  module&quot;</span><span class="p">)</span>
<a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">10.2f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">o</span><span class="si">:</span><span class="s1">10.2f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">np</span><span class="si">:</span><span class="s1">10.0f</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
<a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="si">:</span><span class="s2">10.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="si">:</span><span class="s2">&gt;10s</span><span class="si">}</span><span class="s2">  Total&quot;</span><span class="p">)</span>
<a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>    <span class="c1"># initialize biases into Detect(), cf is class frequency</span>
<a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>    <span class="k">def</span> <span class="nf">_initialize_biases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
<a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>        <span class="c1"># https://arxiv.org/abs/1708.02002 section 3.3</span>
<a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>        <span class="c1"># cf = flow.bincount(flow.tensor(np.concatenate(dataset.labels, 0)[:, 0]).long(), minlength=nc) + 1.</span>
<a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Detect() module</span>
<a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>        <span class="k">for</span> <span class="n">mi</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">stride</span><span class="p">):</span>  <span class="c1"># from</span>
<a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>            <span class="n">b</span> <span class="o">=</span> <span class="n">mi</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># conv.bias(255) to (3,85)</span>
<a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a>            <span class="n">b</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">8</span> <span class="o">/</span> <span class="p">(</span><span class="mi">640</span> <span class="o">/</span> <span class="n">s</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># obj (8 objects per 640 image)</span>
<a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>            <span class="n">b</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">nc</span> <span class="o">-</span> <span class="mf">0.999999</span><span class="p">))</span> <span class="k">if</span> <span class="n">cf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">flow</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">cf</span> <span class="o">/</span> <span class="n">cf</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  <span class="c1"># cls</span>
<a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>            <span class="n">mi</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>    <span class="c1">#  æ‰“å°æ¨¡å‹ä¸­æœ€åDetectå±‚çš„åç½®biasesä¿¡æ¯(ä¹Ÿå¯ä»¥ä»»é€‰å“ªäº›å±‚biasesä¿¡æ¯)</span>
<a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>    <span class="k">def</span> <span class="nf">_print_biases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a><span class="sd">        æ‰“å°æ¨¡å‹ä¸­æœ€åDetectæ¨¡å—é‡Œé¢çš„å·ç§¯å±‚çš„åç½®biasesä¿¡æ¯(ä¹Ÿå¯ä»¥ä»»é€‰å“ªäº›å±‚biasesä¿¡æ¯)</span>
<a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Detect() module</span>
<a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>        <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>  <span class="c1"># from</span>
<a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>            <span class="n">b</span> <span class="o">=</span> <span class="n">mi</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># conv.bias(255) to (3,85)</span>
<a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>                <span class="p">(</span><span class="s1">&#39;</span><span class="si">%6g</span><span class="s1"> Conv2d.bias:&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%10.3g</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">mi</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">b</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">b</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
<a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>
<a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>    <span class="k">def</span> <span class="nf">_print_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a><span class="sd">        æ‰“å°æ¨¡å‹ä¸­Bottleneckå±‚çš„æƒé‡å‚æ•°weightsä¿¡æ¯(ä¹Ÿå¯ä»¥ä»»é€‰å“ªäº›å±‚weightsä¿¡æ¯)</span>
<a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
<a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Bottleneck</span><span class="p">:</span>
<a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%10.3g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># shortcut weights</span>
<a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>
<a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>    <span class="c1"># fuse()æ˜¯ç”¨æ¥è¿›è¡Œconvå’Œbnå±‚åˆå¹¶ï¼Œä¸ºäº†æé€Ÿæ¨¡å‹æ¨ç†é€Ÿåº¦ã€‚</span>
<a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a>    <span class="k">def</span> <span class="nf">fuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># fuse model Conv2d() + BatchNorm2d() layers</span>
<a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a>        <span class="sd">&quot;&quot;&quot;ç”¨åœ¨detect.pyã€val.py</span>
<a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a><span class="sd">        fuse model Conv2d() + BatchNorm2d() layers</span>
<a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a><span class="sd">        è°ƒç”¨oneflow_utils.pyä¸­çš„fuse_conv_and_bnå‡½æ•°å’Œcommon.pyä¸­Convæ¨¡å—çš„fuseforwardå‡½æ•°</span>
<a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a>        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fusing layers... &#39;</span><span class="p">)</span>
<a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
<a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>            <span class="c1"># å¦‚æœå½“å‰å±‚æ˜¯å·ç§¯å±‚Convä¸”æœ‰bnç»“æ„, é‚£ä¹ˆå°±è°ƒç”¨fuse_conv_and_bnå‡½æ•°è®²convå’Œbnè¿›è¡Œèåˆ, åŠ é€Ÿæ¨ç†</span>
<a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">Conv</span><span class="p">,</span> <span class="n">DWConv</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bn&#39;</span><span class="p">):</span>
<a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>                <span class="n">m</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">fuse_conv_and_bn</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">conv</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bn</span><span class="p">)</span>  <span class="c1"># update conv</span>
<a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>                <span class="nb">delattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;bn&#39;</span><span class="p">)</span>  <span class="c1"># remove batchnorm  ç§»é™¤bn remove batchnorm</span>
<a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>                <span class="n">m</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">forward_fuse</span>  <span class="c1"># update forward æ›´æ–°å‰å‘ä¼ æ’­ update forward (åå‘ä¼ æ’­ä¸ç”¨ç®¡, å› ä¸ºè¿™ç§æ¨ç†åªç”¨åœ¨æ¨ç†é˜¶æ®µ)</span>
<a id="__codelineno-5-181" name="__codelineno-5-181" href="#__codelineno-5-181"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>  <span class="c1"># æ‰“å°conv+bnèåˆåçš„æ¨¡å‹ä¿¡æ¯</span>
<a id="__codelineno-5-182" name="__codelineno-5-182" href="#__codelineno-5-182"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-183" name="__codelineno-5-183" href="#__codelineno-5-183"></a>    <span class="c1"># æ‰“å°æ¨¡å‹ç»“æ„ä¿¡æ¯ åœ¨å½“å‰ç±»__init__å‡½æ•°ç»“å°¾å¤„æœ‰è°ƒç”¨</span>
<a id="__codelineno-5-184" name="__codelineno-5-184" href="#__codelineno-5-184"></a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">640</span><span class="p">):</span>  <span class="c1"># print model information</span>
<a id="__codelineno-5-185" name="__codelineno-5-185" href="#__codelineno-5-185"></a>        <span class="n">model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
<a id="__codelineno-5-186" name="__codelineno-5-186" href="#__codelineno-5-186"></a>
<a id="__codelineno-5-187" name="__codelineno-5-187" href="#__codelineno-5-187"></a>    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
<a id="__codelineno-5-188" name="__codelineno-5-188" href="#__codelineno-5-188"></a>        <span class="c1"># Apply to(), cpu(), cuda(), half() to model tensors that are not parameters or registered buffers</span>
<a id="__codelineno-5-189" name="__codelineno-5-189" href="#__codelineno-5-189"></a>        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<a id="__codelineno-5-190" name="__codelineno-5-190" href="#__codelineno-5-190"></a>        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Detect()</span>
<a id="__codelineno-5-191" name="__codelineno-5-191" href="#__codelineno-5-191"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Detect</span><span class="p">):</span>
<a id="__codelineno-5-192" name="__codelineno-5-192" href="#__codelineno-5-192"></a>            <span class="n">m</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span>
<a id="__codelineno-5-193" name="__codelineno-5-193" href="#__codelineno-5-193"></a>            <span class="n">m</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">grid</span><span class="p">))</span>
<a id="__codelineno-5-194" name="__codelineno-5-194" href="#__codelineno-5-194"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">anchor_grid</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-5-195" name="__codelineno-5-195" href="#__codelineno-5-195"></a>                <span class="n">m</span><span class="o">.</span><span class="n">anchor_grid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">anchor_grid</span><span class="p">))</span>
<a id="__codelineno-5-196" name="__codelineno-5-196" href="#__codelineno-5-196"></a>        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>
<h3 id="detect">Detectç±»è§£è¯»</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">class</span> <span class="nc">Detect</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="sd">    Detectæ¨¡å—æ˜¯ç”¨æ¥æ„å»ºDetectå±‚çš„ï¼Œå°†è¾“å…¥feature map é€šè¿‡ä¸€ä¸ªå·ç§¯æ“ä½œå’Œå…¬å¼è®¡ç®—åˆ°æˆ‘ä»¬æƒ³è¦çš„shape, ä¸ºåé¢çš„è®¡ç®—æŸå¤±æˆ–è€…NMSåå¤„ç†ä½œå‡†å¤‡</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="n">stride</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># strides computed during build</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="n">onnx_dynamic</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># ONNX export parameter</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="n">export</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># export mode</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">anchors</span><span class="o">=</span><span class="p">(),</span> <span class="n">ch</span><span class="o">=</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># detection layer</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        <span class="c1">#  nc:åˆ†ç±»æ•°é‡</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">nc</span>  <span class="c1"># number of classes  </span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span class="c1">#  no:æ¯ä¸ªanchorçš„è¾“å‡ºæ•°</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">+</span> <span class="mi">5</span>  <span class="c1"># number of outputs per anchor</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        <span class="c1"># nl:é¢„æµ‹å±‚æ•°ï¼Œæ­¤æ¬¡ä¸º3</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>  <span class="c1"># number of detection layers</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>        <span class="c1">#  na:anchorsçš„æ•°é‡ï¼Œæ­¤æ¬¡ä¸º3</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">na</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># number of anchors</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>        <span class="c1">#  grid:æ ¼å­åæ ‡ç³»ï¼Œå·¦ä¸Šè§’ä¸º(1,1),å³ä¸‹è§’ä¸º(input.w/stride,input.h/stride)</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="p">[</span><span class="n">flow</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl</span>  <span class="c1"># init grid</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_grid</span> <span class="o">=</span> <span class="p">[</span><span class="n">flow</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl</span>  <span class="c1"># init anchor grid</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>        <span class="c1"># å†™å…¥ç¼“å­˜ä¸­ï¼Œå¹¶å‘½åä¸ºanchors</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;anchors&#39;</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># shape(nl,na,2)</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>        <span class="c1"># å°†è¾“å‡ºé€šè¿‡å·ç§¯åˆ° self.no * self.na çš„é€šé“ï¼Œè¾¾åˆ°å…¨è¿æ¥çš„ä½œç”¨</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ch</span><span class="p">)</span>  <span class="c1"># output conv</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span> <span class="o">=</span> <span class="n">inplace</span>  <span class="c1"># use inplace ops (e.g. slice assignment)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>        <span class="n">z</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># inference output</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nl</span><span class="p">):</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># conv</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>            <span class="n">bs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># x(bs,255,20,20) to x(bs,3,20,20,85)</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>  <span class="c1"># inference</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onnx_dynamic</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>                    <span class="c1"># å‘å‰ä¼ æ’­æ—¶éœ€è¦å°†ç›¸å¯¹åæ ‡è½¬æ¢åˆ°gridç»å¯¹åæ ‡ç³»ä¸­</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_grid</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>                <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span><span class="p">:</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>                    <span class="n">y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># xy</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>                    <span class="n">y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># wh</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># for YOLOv5 on AWS Inferentia https://github.com/ultralytics/yolov5/pull/2953</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>                    <span class="n">xy</span><span class="p">,</span> <span class="n">wh</span><span class="p">,</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">split</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># y.tensor_split((2, 4, 5), 4)  </span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>                    <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># xy</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>                    <span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="n">wh</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># wh</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">xy</span><span class="p">,</span> <span class="n">wh</span><span class="p">,</span> <span class="n">conf</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>                <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">))</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>        <span class="k">return</span> <span class="n">x</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">),)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span> <span class="k">else</span> <span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>    <span class="c1"># ç›¸å¯¹åæ ‡è½¬æ¢åˆ°gridç»å¯¹åæ ‡ç³»</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>    <span class="k">def</span> <span class="nf">_make_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>        <span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="mi">2</span>  <span class="c1"># grid shape</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="p">),</span> <span class="n">flow</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>        <span class="n">yv</span><span class="p">,</span> <span class="n">xv</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>  <span class="c1"># add grid offset, i.e. y = 2.0 * x - 0.5</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>        <span class="n">anchor_grid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">na</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">anchor_grid</span>
</code></pre></div>
<h2 id="_4">é™„ä»¶</h2>
<p>è¡¨2.1  <a href="https://github.com/Oneflow-Inc/one-yolov5/blob/main/models/yolov5s.yaml">yolov5s.yaml</a>è§£æè¡¨ </p>
<table>
<thead>
<tr>
<th>å±‚æ•°</th>
<th>form</th>
<th>moudule</th>
<th>arguments</th>
<th>input</th>
<th>output</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>-1</td>
<td>Conv</td>
<td>[3, 32, 6, 2, 2]</td>
<td>[3, 640, 640]</td>
<td>[32, 320, 320]</td>
</tr>
<tr>
<td>1</td>
<td>-1</td>
<td>Conv</td>
<td>[32, 64, 3, 2]</td>
<td>[32, 320, 320]</td>
<td>[64, 160, 160]</td>
</tr>
<tr>
<td>2</td>
<td>-1</td>
<td>C3</td>
<td>[64, 64, 1]</td>
<td>[64, 160, 160]</td>
<td>[64, 160, 160]</td>
</tr>
<tr>
<td>3</td>
<td>-1</td>
<td>Conv</td>
<td>[64, 128, 3, 2]</td>
<td>[64, 160, 160]</td>
<td>[128, 80, 80]</td>
</tr>
<tr>
<td>4</td>
<td>-1</td>
<td>C3</td>
<td>[128, 128, 2]</td>
<td>[128, 80, 80]</td>
<td>[128, 80, 80]</td>
</tr>
<tr>
<td>5</td>
<td>-1</td>
<td>Conv</td>
<td>[128, 256, 3, 2]</td>
<td>[128, 80, 80]</td>
<td>[256, 40, 40]</td>
</tr>
<tr>
<td>6</td>
<td>-1</td>
<td>C3</td>
<td>[256, 256, 3]</td>
<td>[256, 40, 40]</td>
<td>[256, 40, 40]</td>
</tr>
<tr>
<td>7</td>
<td>-1</td>
<td>Conv</td>
<td>[256, 512, 3, 2]</td>
<td>[256, 40, 40]</td>
<td>[512, 20, 20]</td>
</tr>
<tr>
<td>8</td>
<td>-1</td>
<td>C3</td>
<td>[512, 512, 1]</td>
<td>[512, 20, 20]</td>
<td>[512, 20, 20]</td>
</tr>
<tr>
<td>9</td>
<td>-1</td>
<td>SPPF</td>
<td>[512, 512, 5]</td>
<td>[512, 20, 20]</td>
<td>[512, 20, 20]</td>
</tr>
<tr>
<td>10</td>
<td>-1</td>
<td>Conv</td>
<td>[512, 256, 1, 1]</td>
<td>[512, 20, 20]</td>
<td>[256, 20, 20]</td>
</tr>
<tr>
<td>11</td>
<td>-1</td>
<td>Upsample</td>
<td>[None, 2, 'nearest']</td>
<td>[256, 20, 20]</td>
<td>[256, 40, 40]</td>
</tr>
<tr>
<td>12</td>
<td>[-1, 6]</td>
<td>Concat</td>
<td>[1]</td>
<td>[1, 256, 40, 40],[1, 256, 40, 40]</td>
<td>[512, 40, 40]</td>
</tr>
<tr>
<td>13</td>
<td>-1</td>
<td>C3</td>
<td>[512, 256, 1, False]</td>
<td>[512, 40, 40]</td>
<td>[256, 40, 40]</td>
</tr>
<tr>
<td>14</td>
<td>-1</td>
<td>Conv</td>
<td>[256, 128, 1, 1]</td>
<td>[256, 40, 40]</td>
<td>[128, 40, 40]</td>
</tr>
<tr>
<td>15</td>
<td>-1</td>
<td>Upsample</td>
<td>[None, 2, 'nearest']</td>
<td>[128, 40, 40]</td>
<td>[128, 80, 80]</td>
</tr>
<tr>
<td>16</td>
<td>[-1, 4]</td>
<td>Concat</td>
<td>[1]</td>
<td>[1, 128, 80, 80],[1, 128, 80, 80]</td>
<td>[256, 80, 80]</td>
</tr>
<tr>
<td>17</td>
<td>-1</td>
<td>C3</td>
<td>[256, 128, 1, False]</td>
<td>[256, 80, 80]</td>
<td>[128, 80, 80]</td>
</tr>
<tr>
<td>18</td>
<td>-1</td>
<td>Conv</td>
<td>[128, 128, 3, 2]</td>
<td>[128, 80, 80]</td>
<td>[128, 40, 40]</td>
</tr>
<tr>
<td>19</td>
<td>[-1, 14]</td>
<td>Concat</td>
<td>[1]</td>
<td>[1, 128, 40, 40],[1, 128, 40, 40]</td>
<td>[256, 40, 40]</td>
</tr>
<tr>
<td>20</td>
<td>-1</td>
<td>C3</td>
<td>[256, 256, 1, False]</td>
<td>[256, 40, 40]</td>
<td>[256, 40, 40]</td>
</tr>
<tr>
<td>21</td>
<td>-1</td>
<td>Conv</td>
<td>[256, 256, 3, 2]</td>
<td>[256, 40, 40]</td>
<td>[256, 20, 20]</td>
</tr>
<tr>
<td>22</td>
<td>[-1, 10]</td>
<td>Concat</td>
<td>[1]</td>
<td>[1, 256, 20, 20],[1, 256, 20, 20]</td>
<td>[512, 20, 20]</td>
</tr>
<tr>
<td>23</td>
<td>-1</td>
<td>C3</td>
<td>[512, 512, 1, False]</td>
<td>[512, 20, 20]</td>
<td>[512, 20, 20]</td>
</tr>
<tr>
<td>24</td>
<td>[17, 20, 23]</td>
<td>Detect</td>
<td>[80, [[10, 13, 16, 30, 33, 23], [30, 61, 62, 45, 59, 119], [116, 90, 156, 198, 373, 326]], [128, 256, 512]]</td>
<td>[1, 128, 80, 80],[1, 256, 40, 40],[1, 512, 20, 20]</td>
<td>[1, 3, 80, 80, 85],[1, 3, 40, 40, 85],[1, 3, 20, 20, 85]</td>
</tr>
</tbody>
</table>
<h2 id="_5">å‚è€ƒæ–‡ç« :</h2>
<ul>
<li>https://zhuanlan.zhihu.com/p/436891962?ivk_sa=1025922q</li>
<li>https://zhuanlan.zhihu.com/p/110204563</li>
<li>https://www.it610.com/article/1550621248474648576.htm</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../00_chapter/overview.html" class="md-footer__link md-footer__link--prev" aria-label="ä¸Šä¸€é¡µ: one-yolov5 ç‰¹ç‚¹è§£æ" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                ä¸Šä¸€é¡µ
              </span>
              one-yolov5 ç‰¹ç‚¹è§£æ
            </div>
          </div>
        </a>
      
      
        
        <a href="../02_chapter/how_to_prepare_yolov5_training_data.html" class="md-footer__link md-footer__link--next" aria-label="ä¸‹ä¸€é¡µ: å¦‚ä½•å‡†å¤‡YOLOv5æ¨¡å‹è®­ç»ƒæ•°æ®" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                ä¸‹ä¸€é¡µ
              </span>
              å¦‚ä½•å‡†å¤‡YOLOv5æ¨¡å‹è®­ç»ƒæ•°æ®
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "instant"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.ddd52ceb.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>