# 0x0 åŠ¨æœº

ä¸ºäº†è¯´æ˜ä½¿ç”¨ OneFlow è®­ç»ƒç›®æ ‡æ£€æµ‹æ¨¡å‹çš„å¯è¡Œæ€§ä»¥åŠæ€§èƒ½çš„ä¼˜è¶Šæ€§ï¼Œæœ€è¿‘æˆ‘ä»¬å°† ultralytics ç‰ˆ YOLOv5ï¼ˆhttps://github.com/ultralytics/yolov5ï¼‰é€šè¿‡import oneflow as torchçš„æ–¹å¼è¿ç§»ä¸ºäº†OneFlowåç«¯ï¼ˆå¯¹åº”YOLOv5çš„commitå·ä¸ºï¼š`48a85314bc80d8023c99bfb114cea98d71dd0591`ï¼‰ã€‚å¹¶å¯¹ YOLOv5 ä¸­ç›¸å…³çš„æ•™ç¨‹è¿›è¡Œäº†æ±‰åŒ–ï¼Œæ·»åŠ äº†ä¸€ç³»åˆ—è¯¦ç»†çš„ä»£ç è§£è¯»ï¼ŒåŸç†è®²è§£ä»¥åŠéƒ¨ç½²æ•™ç¨‹ï¼Œå¸Œæœ›ä½¿å¾— YOLOv5 é¡¹ç›®å¯¹ç”¨æˆ·æ›´åŠ é€æ˜åŒ–ã€‚å¦å¤–æˆ‘ä»¬ä¹Ÿå°†åœ¨æ€§èƒ½è¿™ä¸ªè§’åº¦è¿›è¡Œæ·±å…¥æ¢ç´¢ï¼Œæœ¬æ¬¡æˆ‘ä»¬å‘å¸ƒçš„OneFlowåç«¯çš„YOLOv5åªæ˜¯ä¸€ä¸ªåŸºç¡€ç‰ˆæœ¬ï¼Œæ²¡æœ‰ç”¨ä¸Šä»»ä½•çš„ä¼˜åŒ–æŠ€å·§ã€‚ç›®å‰æˆ‘ä»¬åœ¨å° Batch è¿›è¡Œè®­ç»ƒæ—¶ç›¸æ¯”äº PyTorch æœ‰5%-10%å·¦å³çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œè€Œå¯¹äºå¤§ Batch åˆ™æ€§èƒ½å’Œ PyTorch æŒå¹³ã€‚ç›¸ä¿¡åœ¨åç»­çš„ä¸€äº›å®šåˆ¶åŒ–çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ä¸‹ï¼ˆæ¯”å¦‚nn.GraphåŠ æŒï¼Œç®—å­çš„ä¼˜åŒ–ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æå‡YOLOv5åœ¨COCOç­‰æ•°æ®é›†çš„è®­ç»ƒé€Ÿåº¦ï¼Œæ›´æœ‰æ•ˆç¼©çŸ­ç›®æ ‡æ£€æµ‹æ¨¡å‹çš„è®­ç»ƒæ—¶é—´ã€‚

å–œæ¬¢çš„è¯è¯·å¤šå¤šä¸ºæˆ‘æŠ•ç¥¨å§ã€‚


<img width="256" alt="å›¾ç‰‡" src="https://user-images.githubusercontent.com/35585791/197813929-79e0ca2b-dcb1-4a5e-91e3-d244e03af0fd.png">


- ğŸ‰ä»£ç ä»“åº“åœ°å€ï¼šhttps://github.com/Oneflow-Inc/one-yolov5
- ğŸ‰æ–‡æ¡£ç½‘ç«™åœ°å€ï¼šhttps://start.oneflow.org/oneflow-yolo-doc/index.html
- OneFlow å®‰è£…æ–¹æ³•ï¼šhttps://github.com/Oneflow-Inc/oneflow#install-oneflow

ä¸è¿‡å³ä½¿ä½ å¯¹ OneFlow å¸¦æ¥çš„æ€§èƒ½æå‡ä¸å¤ªæ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬ç›¸ä¿¡[æ–‡æ¡£ç½‘ç«™](https://start.oneflow.org/oneflow-yolo-doc/index.html)ä¸­å¯¹ YOLOv5 æ•™ç¨‹çš„æ±‰åŒ–ä»¥åŠæºç å‰–æä¹Ÿä¼šæ˜¯ä»é›¶å¼€å§‹æ·±å…¥å­¦ä¹  YOLOv5 ä¸€ä»½ä¸é”™çš„èµ„æ–™ã€‚æ¬¢è¿åœ¨ä»“åº“ç»™æˆ‘ä»¬æå‡ºå®è´µçš„æ„è§ã€‚ğŸŒŸğŸŒŸğŸŒŸ

æ¬¢è¿star [one-yolov5é¡¹ç›®](https://github.com/Oneflow-Inc/one-yolov5) è·å–æœ€æ–°çš„åŠ¨æ€ã€‚


# 0x1. å·®å¼‚

æˆ‘ä»¬å°† YOLOv5 çš„åç«¯ä» PyTorch æ¢æˆ OneFlow ä¹‹åé™¤äº†æ€§èƒ½ä¼˜åŠ¿å¤–è¿˜åšäº†ä¸€äº›å·®å¼‚åŒ–çš„å†…å®¹ï¼Œå…¶ä¸­ä¸€äº›å†…å®¹å·²ç»å®Œæˆï¼Œè¿˜æœ‰ä¸€äº›æ­£åœ¨è¿›è¡Œä¸­ï¼Œä¸‹é¢ç®€å•å±•ç¤ºä¸€ä¸‹ï¼š

![](https://user-images.githubusercontent.com/35585791/196579121-76c6246e-5793-491e-bf96-86dd5ce06290.png)


- [1. YOLOv5 ç½‘ç»œç»“æ„è§£æ](https://start.oneflow.org/oneflow-yolo-doc/tutorials/01_chapter/yolov5_network_structure_analysis.html)
- [2. å¦‚ä½•å‡†å¤‡yolov5æ¨¡å‹è®­ç»ƒæ•°æ®](https://start.oneflow.org/oneflow-yolo-doc/tutorials/02_chapter/how_to_prepare_yolov5_training_data.html)
- [3. å¿«é€Ÿå¼€å§‹](https://start.oneflow.org/oneflow-yolo-doc/tutorials/03_chapter/quick_start.html)
- [4. æ¨¡å‹è®­ç»ƒ](https://start.oneflow.org/oneflow-yolo-doc/tutorials/03_chapter/model_train.html)
- [5. æµ‹è¯•æ—¶å¢å¼º (TTA)](https://start.oneflow.org/oneflow-yolo-doc/tutorials/03_chapter/TTA.html)
- [6. æ¨¡å‹èåˆ (Model Ensembling)](https://start.oneflow.org/oneflow-yolo-doc/tutorials/03_chapter/model_ensembling.html)
- [7. ä» OneFlow Hub åŠ è½½ YOLOv5](https://start.oneflow.org/oneflow-yolo-doc/tutorials/03_chapter/loading_model_from_oneflowhub.html)
- [8. æ•°æ®å¢å¼º](https://start.oneflow.org/oneflow-yolo-doc/tutorials/04_chapter/mosaic.html)
- [9. çŸ©å½¢æ¨ç†](https://start.oneflow.org/oneflow-yolo-doc/tutorials/05_chapter/rectangular_reasoning.html)
- [10. IOUæ·±å…¥è§£æ](https://start.oneflow.org/oneflow-yolo-doc/tutorials/05_chapter/iou_in-depth_analysis.html)
- [11. æ¨¡å‹ç²¾ç¡®åº¦è¯„ä¼°](https://start.oneflow.org/oneflow-yolo-doc/tutorials/05_chapter/map_analysis.html)
- [12. ONNXæ¨¡å‹å¯¼å‡º](https://start.oneflow.org/oneflow-yolo-doc/tutorials/06_chapter/export_onnx_tflite_tensorrt.html)

è¿™ä¸€ç³»åˆ—çš„æ–‡ç« æˆ‘ä»¬å°†é€æ­¥å¼€å‘ï¼ŒReview ä»¥åŠå‘å¸ƒå¹¶ä¸”ä¼šæœ‰ç›¸åº”çš„è§†é¢‘è®²è§£ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªç³»åˆ—çš„æ–‡ç« å«ä½œï¼š**ã€ŠYOLOv5å…¨é¢è§£ææ•™ç¨‹ã€‹** ğŸ‰ğŸ‰ğŸ‰

# 0x2. åœ¨COCOä¸Šçš„ç²¾åº¦è¡¨ç°

æˆ‘ä»¬ä»¥ yolov5n ç½‘ç»œä¸ºä¾‹ï¼Œ [result.csv](https://oneflow-static.oss-cn-beijing.aliyuncs.com/one-yolo/YOLOv5n_results.csv) è¿™ä¸ªæ—¥å¿—å±•ç¤ºäº†æˆ‘ä»¬åŸºäº one-yolov5 åœ¨ COCO ä¸Šä»é›¶å¼€å§‹è®­ç»ƒ YOLOv5n ç½‘ç»œçš„æ—¥å¿—ã€‚ä¸‹å›¾å±•ç¤ºäº† `box_loss` , `obj_loss`, `cls_loss` ï¼Œ`map_0.5`, `map_0.5:0.95` ç­‰æŒ‡æ ‡åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„å˜åŒ–æƒ…å†µï¼š

![å›¾ç‰‡](https://user-images.githubusercontent.com/35585791/197911473-ec1b246f-aa3d-4f25-bf35-534458804213.png)

æœ€ç»ˆåœ¨ç¬¬ 300 ä¸ª epoch æ—¶ï¼Œæˆ‘ä»¬çš„ `map_0.5` è¾¾åˆ°äº† **0.45174** ï¼Œ`map_0.5:0.95` è¾¾åˆ°äº† **0.27726** ã€‚

å’Œ [å®˜æ–¹ YOLOv5 ç»™å‡ºçš„ç²¾åº¦æ•°æ®](https://github.com/ultralytics/yolov5#pretrained-checkpoints) ä¸€è‡´ï¼ˆæ³¨æ„å®˜ç½‘ç»™å‡ºçš„ç²¾åº¦æŒ‡å®š `iou` ä¸º 0.65 çš„ç²¾åº¦ï¼Œè€Œä¸Šè¿° csv æ–‡ä»¶ä¸­æ˜¯åœ¨ `iou` ä¸º 0.60 ä¸‹çš„ç²¾åº¦ï¼Œä½¿ç”¨æˆ‘ä»¬è®­ç»ƒçš„æƒé‡å¹¶æŠŠ `iou` æŒ‡å®šä¸º 0.65 å¯ä»¥å®Œå…¨å¯¹é½å®˜æ–¹ç»™å‡ºçš„ç²¾åº¦æ•°æ®ï¼‰ã€‚

å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ultralytics/yolov5 æ¥éªŒè¯ä¸€ä¸‹ï¼š

```python
python val.py  --weights yolov5n.pt --data data/coco.yaml --img 640 --iou 0.60
```

è¾“å‡ºï¼š

```shell
val: data=data/coco.yaml, weights=['yolov5n.pt'], batch_size=32, imgsz=640, conf_thres=0.001, iou_thres=0.6, max_det=300, task=val, device=, workers=8, single_cls=False, augment=False, verbose=False, save_txt=False, save_hybrid=False, save_conf=False, save_json=True, project=runs/val, name=exp, exist_ok=False, half=False, dnn=False
YOLOv5 ğŸš€ v6.1-384-g7fd9867 Python-3.8.13 torch-1.10.0+cu113 CUDA:0 (NVIDIA GeForce RTX 3080 Ti, 12054MiB)

cuda:0
Fusing layers... 
YOLOv5n summary: 213 layers, 1867405 parameters, 0 gradients, 4.5 GFLOPs
val: Scanning '/data/dataset/fengwen/coco/val2017.cache' images and labels... 4952 found, 48 missing, 0 empty, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                 Class     Images  Instances          P          R      mAP50   mAP50-95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 157/157 [00:40<00:00,  3.
                   all       5000      36335      0.573      0.432      0.456      0.277
```

ä¸Šé¢çš„è¾“å‡ºå¯ä»¥è¯´æ˜æˆ‘ä»¬å’Œ ultralytics/yolov5 çš„ç²¾åº¦æ˜¯å®Œå…¨å¯¹é½çš„ã€‚


åœ¨ one-yolov5 ä»é›¶å¼€å§‹è®­ç»ƒ yolov5n è¿›è¡Œç²¾åº¦å¤ç°çš„å‘½ä»¤ä¸º (2å¡DDPæ¨¡å¼) ï¼š

```python3
python  -m oneflow.distributed.launch --nproc_per_node 2 train.py --data  data/coco.yaml  --weights ' ' --cfg models/yolov5n.yaml --batch 64
```

# 0x3. åœ¨COCOä¸Šçš„æ€§èƒ½è¡¨ç°

ä»¥ä¸‹çš„æ€§èƒ½ç»“æœéƒ½æ˜¯ç›´æ¥å°† PyTorch åˆ‡æ¢ä¸º OneFlow ä¹‹åæµ‹è¯•çš„ï¼Œ**å¹¶æ²¡æœ‰åšé’ˆå¯¹æ€§ä¼˜åŒ–**ï¼Œåç»­ä¼šåœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­æå‡ OneFlow åç«¯ YOLOv5 çš„è®­ç»ƒé€Ÿåº¦ã€‚

## åœ¨ 3080Ti çš„æ€§èƒ½æµ‹è¯•ç»“æœ

### å•å¡æµ‹è¯•ç»“æœ

- ä»¥ä¸‹ä¸ºGTX 3080ti(12GB) çš„yolov5æµ‹è¯•ç»“æœï¼ˆoneflowåç«¯ vs PyTorchåç«¯ï¼‰
- ä»¥ä¸‹æµ‹è¯•ç»“æœçš„æ•°æ®é…ç½®å‡ä¸ºcoco.yamlï¼Œæ¨¡å‹é…ç½®ä¹Ÿå®Œå…¨ä¸€æ ·ï¼Œå¹¶è®°å½•è®­ç»ƒå®Œcocoæ•°æ®é›†1ä¸ªepochéœ€è¦çš„æ—¶é—´
- ç”±äºoneflow eagerç›®å‰ampçš„æ”¯æŒè¿˜ä¸å®Œå–„ï¼Œæ‰€ä»¥æˆ‘ä»¬æä¾›çš„ç»“æœå‡ä¸ºfp32æ¨¡å¼ä¸‹è¿›è¡Œè®­ç»ƒçš„æ€§èƒ½ç»“æœ
- PyTorchç‰ˆæœ¬ yolov5 code baseé“¾æ¥ï¼šhttps://github.com/ultralytics/yolov5
- OneFlowç‰ˆæœ¬ yolov5 code baseé“¾æ¥ï¼šhttps://github.com/Oneflow-Inc/one-yolov5
- cuda ç‰ˆæœ¬ 11.7, cudnn ç‰ˆæœ¬ä¸º 8.5.0
- æµ‹è¯•çš„å‘½ä»¤ä¸ºï¼š`python train.py --batch 16 --cfg models/yolov5n.yaml --weights '' --data coco.yaml --img 640 --device 0` ï¼Œå…¶ä¸­ batch å‚æ•°æ˜¯åŠ¨æ€å˜åŒ–çš„

![å›¾ç‰‡](https://user-images.githubusercontent.com/35585791/196843664-ceaabc3c-aae9-40dc-9972-60254f8b2549.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ batch æ¯”è¾ƒå°çš„æ—¶å€™ OneFlow åç«¯çš„ YOLOv5 ç›¸æ¯”äº PyTorch æœ‰ 5%-10% å·¦å³çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œè¿™å¯èƒ½å¾—ç›Šäº OneFlow çš„ Eager è¿è¡Œæ—¶ç³»ç»Ÿå¯ä»¥æ›´å¿«çš„åš CUDA Kernel Launchã€‚è€Œ batch æ¯”è¾ƒå¤§çš„æ—¶å€™ OneFlow åç«¯çš„ YOLOv5 ç›¸æ¯”äº PyTorch çš„æ€§èƒ½å·®ä¸å¤šæ˜¯æŒå¹³ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºå½“ Batch æ¯”è¾ƒå¤§çš„æ—¶å€™ CUDA Kernel Launch çš„å¼€é”€ç›¸æ¯”äºè®¡ç®—çš„å¼€é”€ä¼šæ¯”è¾ƒå°ã€‚

### ä¸¤å¡DDPæµ‹è¯•ç»“æœ

- é…ç½®å’Œå•å¡å‡ä¸€è‡´
- æµ‹è¯•çš„å‘½ä»¤ä¸ºï¼š`python -m oneflow.distributed.launch --nproc_per_node 2 train.py --batch 16 --data coco.yaml --weights '' --device 0,1` ï¼Œå…¶ä¸­ batch å‚æ•°æ˜¯åŠ¨æ€å˜åŒ–çš„

![å›¾ç‰‡](https://user-images.githubusercontent.com/35585791/196844299-3f6c169d-4606-4e94-9edb-95c1c8935234.png)

å¾—ç›Šäºå•å¡çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œåœ¨ 2 å¡DDPæ¨¡å¼ä¸‹ï¼ŒOneFlow åç«¯çš„ YOLOv5 åœ¨å° batch çš„è®­ç»ƒæ—¶é—´ä¹Ÿæ˜¯ç¨å¾®é¢†å…ˆ PyTorch åç«¯çš„ YoloV5 ï¼Œè€Œå¯¹äºå¤§ Batch æ¥è¯´æ€§èƒ½å’Œ PyTorch ç›¸æ¯”ä¹Ÿæ˜¯å·®ä¸å¤šæŒå¹³ã€‚

# 0x4. æ€»ç»“

æˆ‘ä»¬åŸºäº OneFlow ç§»æ¤äº† ultralytics ç‰ˆçš„ YOLOv5 ï¼Œåœ¨ç²¾åº¦è®­ç»ƒè¾¾æ ‡çš„æƒ…å†µä¸‹è¿˜å¯ä»¥åœ¨ Batch æ¯”è¾ƒå°æ—¶å–å¾—ä¸€äº›æ€§èƒ½ä¼˜åŠ¿ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯¹ YOLOv5 ä¸­ç›¸å…³çš„æ•™ç¨‹è¿›è¡Œäº†æ±‰åŒ–ï¼Œæ·»åŠ äº†ä¸€ç³»åˆ—è¯¦ç»†çš„ä»£ç è§£è¯»ï¼ŒåŸç†è®²è§£ä»¥åŠéƒ¨ç½²æ•™ç¨‹ï¼Œå¸Œæœ›ä½¿å¾— YOLOv5 é¡¹ç›®å¯¹ç”¨æˆ·æ›´åŠ é€æ˜åŒ–ã€‚ç›¸ä¿¡å¯¹æƒ³æ·±å…¥äº†è§£ YOLOv5 çš„è¯»è€…æˆ‘ä»¬çš„ **ã€ŠYOLOv5å…¨é¢è§£ææ•™ç¨‹ã€‹** ä¹Ÿæ˜¯ä¸€ä»½ä¸é”™çš„å­¦ä¹ èµ„æ–™ã€‚

